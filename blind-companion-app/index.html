<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ©ç›²é™ªè·‘ - è¿æ¥è§†éšœäººå£«ä¸å¿—æ„¿è€…</title>

    <!-- Leaflet åœ°å›¾åº“ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        /* æ— éšœç¢æ”¯æŒ - é«˜å¯¹æ¯”åº¦å’Œå¤§å­—ä½“ */
        .accessible-mode {
            font-size: 18px;
            line-height: 1.8;
        }

        .accessible-mode button,
        .accessible-mode .btn {
            min-height: 50px;
            font-size: 20px;
            font-weight: 600;
        }

        /* å¤´éƒ¨å¯¼èˆª */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* åº•éƒ¨å¯¼èˆªæ  */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 5px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: none;
            color: #666;
        }

        .nav-item:hover {
            color: #667eea;
        }

        .nav-item.active {
            color: #667eea;
            font-weight: 600;
        }

        .nav-item .icon {
            font-size: 24px;
            display: block;
            margin-bottom: 3px;
        }

        .nav-item .label {
            font-size: 12px;
        }

        .nav-item {
            position: relative;
        }

        .nav-badge {
            position: absolute;
            top: 0;
            right: 10px;
            background: #ff4444;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
        }

        .nav-badge.hidden {
            display: none;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            padding-bottom: 80px;
            min-height: calc(100vh - 100px);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* å®¹å™¨ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            min-height: 44px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-success {
            background: #52c41a;
            color: white;
        }

        .btn-block {
            width: 100%;
            display: block;
        }

        /* æ ‡ç­¾ */
        .tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            margin-right: 8px;
            margin-bottom: 5px;
        }

        .tag-running {
            background: #e6f7ff;
            color: #1890ff;
        }

        .tag-walking {
            background: #f6ffed;
            color: #52c41a;
        }

        .tag-travel {
            background: #fff7e6;
            color: #fa8c16;
        }

        .tag-certified {
            background: #f0f5ff;
            color: #597ef7;
            font-weight: 600;
        }

        .tag-pending {
            background: #fff7e6;
            color: #fa8c16;
        }

        .tag-matched {
            background: #f6ffed;
            color: #52c41a;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* åœ°å›¾å®¹å™¨ */
        #map {
            width: 100%;
            height: 400px;
            border-radius: 12px;
            margin-bottom: 20px;
            background: #e0e0e0;
            position: relative;
            z-index: 1;
        }

        #map .leaflet-container {
            border-radius: 12px;
        }

        /* ç”¨æˆ·ç±»å‹é€‰æ‹© */
        .user-type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .user-type-card {
            flex: 1;
            padding: 30px 20px;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-type-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .user-type-card.selected {
            border-color: #667eea;
            background: #f0f5ff;
        }

        .user-type-card .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .user-type-card .title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-type-card .desc {
            font-size: 14px;
            color: #666;
        }

        /* ç™»å½•æ³¨å†Œé¡µé¢ */
        #auth-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        #auth-page.hidden {
            display: none;
        }

        .auth-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            font-size: 32px;
            color: #333;
            margin-bottom: 10px;
        }

        .auth-header p {
            color: #666;
            font-size: 14px;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: #667eea;
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .role-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .role-option {
            flex: 1;
            padding: 20px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .role-option:hover {
            border-color: #667eea;
        }

        .role-option.selected {
            border-color: #667eea;
            background: #f0f5ff;
        }

        .role-option .icon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .role-option .label {
            font-size: 14px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- åé¦ˆè¯„ä»·å¼¹çª— -->
    <div id="feedback-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9998; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h2 style="margin-bottom: 20px;">â­ è¯„ä»·å¿—æ„¿è€…</h2>

            <form id="feedback-form" onsubmit="submitFeedback(event)">
                <input type="hidden" id="feedback-record-id">

                <div class="form-group">
                    <label class="form-label">è¯„åˆ†</label>
                    <div style="display: flex; gap: 10px; font-size: 32px; margin-bottom: 10px;">
                        <span class="star-rating" data-rating="1" onclick="selectRating(1)" style="cursor: pointer;">â­</span>
                        <span class="star-rating" data-rating="2" onclick="selectRating(2)" style="cursor: pointer;">â­</span>
                        <span class="star-rating" data-rating="3" onclick="selectRating(3)" style="cursor: pointer;">â­</span>
                        <span class="star-rating" data-rating="4" onclick="selectRating(4)" style="cursor: pointer;">â­</span>
                        <span class="star-rating" data-rating="5" onclick="selectRating(5)" style="cursor: pointer;">â­</span>
                    </div>
                    <input type="hidden" id="feedback-rating" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="feedback-comment">
                        çœŸå®æ„Ÿå— <span style="color: #f5222a;">*</span>
                        <small style="color: #52c41a; margin-left: 10px;">å¡«å†™çœŸå®æ„Ÿå— +5 ç§¯åˆ†</small>
                    </label>
                    <textarea id="feedback-comment" class="form-textarea" required
                              placeholder="åˆ†äº«æ‚¨çš„é™ªè·‘çœŸå®ä½“éªŒï¼Œå¸®åŠ©æ”¹è¿›æœåŠ¡ï¼ˆå¿…å¡«ï¼‰"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="feedback-image">ä¸Šä¼ å›¾ç‰‡ï¼ˆé€‰å¡«ï¼‰</label>
                    <input type="file" id="feedback-image" accept="image/*" onchange="previewFeedbackImage(event)">
                    <div id="feedback-image-preview" style="margin-top: 10px; display: none;">
                        <img id="feedback-image-img" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeFeedbackForm()">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        æäº¤è¯„ä»·
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- è¿åŠ¨è®°å½•æäº¤å¼¹çª— -->
    <div id="exercise-record-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 20px;">ğŸ“Š æäº¤è¿åŠ¨è®°å½•</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">è¯·å¡«å†™æœ¬æ¬¡é™ªè·‘çš„è¿åŠ¨æ•°æ®ï¼Œæäº¤åå°†ç”±å®˜æ–¹å®¡æ ¸</p>

            <form id="exercise-record-form" onsubmit="submitExerciseRecord(event)">
                <input type="hidden" id="exercise-record-id">

                <div class="form-group">
                    <label class="form-label" for="exercise-duration">è¿åŠ¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰*</label>
                    <input type="number" id="exercise-duration" class="form-input"
                           placeholder="ä¾‹å¦‚ï¼š30" min="1" step="0.1" required
                           oninput="calculatePace()">
                </div>

                <div class="form-group">
                    <label class="form-label" for="exercise-distance">è¿åŠ¨è·ç¦»ï¼ˆå…¬é‡Œï¼‰*</label>
                    <input type="number" id="exercise-distance" class="form-input"
                           placeholder="ä¾‹å¦‚ï¼š5.0" min="0.1" step="0.01" required
                           oninput="calculatePace()">
                </div>

                <div class="form-group">
                    <label class="form-label">é…é€Ÿï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰</label>
                    <div id="exercise-pace" style="font-size: 24px; font-weight: 600; color: #667eea; padding: 15px; background: #f5f5f5; border-radius: 8px; text-align: center;">
                        --:-- åˆ†é’Ÿ/å…¬é‡Œ
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">é¢„è®¡ç§¯åˆ†å¥–åŠ±ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰</label>
                    <div id="exercise-points-preview" style="padding: 15px; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
                        <div style="display: flex; justify-content: space-around; text-align: center;">
                            <div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">å¿—æ„¿è€…</div>
                                <div style="font-size: 20px; font-weight: 600; color: #ff6b6b;">
                                    <span id="volunteer-points">--</span> ç§¯åˆ†
                                </div>
                            </div>
                            <div style="border-left: 2px solid #ffc107;"></div>
                            <div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">ç›²äºº</div>
                                <div style="font-size: 20px; font-weight: 600; color: #667eea;">
                                    <span id="blind-points">--</span> ç§¯åˆ†
                                </div>
                            </div>
                        </div>
                        <div id="points-breakdown" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ffc107; font-size: 12px; color: #666; text-align: center;">
                            è¾“å…¥è·ç¦»åè‡ªåŠ¨è®¡ç®—
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="exercise-screenshot">è¿åŠ¨æˆªå›¾ï¼ˆKeepæˆªå›¾ï¼‰*</label>
                    <input type="file" id="exercise-screenshot" class="form-input"
                           accept="image/*" required
                           onchange="previewScreenshot(event)">
                    <p style="font-size: 12px; color: #999; margin-top: 5px;">
                        è¯·ä¸Šä¼ Keepè¿åŠ¨æˆªå›¾ï¼ŒåŒ…å«è·ç¦»ã€é…é€Ÿå’Œæ—¶é—´æ•°æ®
                    </p>
                    <div id="screenshot-preview" style="margin-top: 10px; display: none;">
                        <img id="screenshot-preview-img" style="max-width: 100%; border-radius: 8px; border: 2px solid #ddd;">
                    </div>
                </div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">

                <h3 style="margin-bottom: 15px; color: #333;">â­ è¯„ä»·å¿—æ„¿è€…</h3>
                <p style="font-size: 12px; color: #52c41a; margin-bottom: 15px;">å¡«å†™çœŸå®æ„Ÿå—å¯è·å¾— +5 ç§¯åˆ†</p>

                <div class="form-group">
                    <label class="form-label">è¯„åˆ† *</label>
                    <div style="display: flex; gap: 10px; font-size: 32px;">
                        <span class="exercise-star-rating" data-rating="1" onclick="selectExerciseRating(1)" style="cursor: pointer; opacity: 0.3;">â­</span>
                        <span class="exercise-star-rating" data-rating="2" onclick="selectExerciseRating(2)" style="cursor: pointer; opacity: 0.3;">â­</span>
                        <span class="exercise-star-rating" data-rating="3" onclick="selectExerciseRating(3)" style="cursor: pointer; opacity: 0.3;">â­</span>
                        <span class="exercise-star-rating" data-rating="4" onclick="selectExerciseRating(4)" style="cursor: pointer; opacity: 0.3;">â­</span>
                        <span class="exercise-star-rating" data-rating="5" onclick="selectExerciseRating(5)" style="cursor: pointer; opacity: 0.3;">â­</span>
                    </div>
                    <input type="hidden" id="exercise-feedback-rating">
                </div>

                <div class="form-group">
                    <label class="form-label" for="exercise-feedback-comment">çœŸå®æ„Ÿå— *</label>
                    <textarea id="exercise-feedback-comment" class="form-textarea" required
                              placeholder="åˆ†äº«æ‚¨çš„é™ªè·‘çœŸå®ä½“éªŒï¼Œå¸®åŠ©æ”¹è¿›æœåŠ¡ï¼ˆå¿…å¡«ï¼Œè‡³å°‘5ä¸ªå­—ï¼‰"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="exercise-feedback-image">ä¸Šä¼ å›¾ç‰‡ï¼ˆé€‰å¡«ï¼‰</label>
                    <input type="file" id="exercise-feedback-image" accept="image/*" onchange="previewExerciseFeedbackImage(event)">
                    <div id="exercise-feedback-image-preview" style="margin-top: 10px; display: none;">
                        <img id="exercise-feedback-image-img" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeExerciseRecordForm()">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        æäº¤å®¡æ ¸
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- å¿—æ„¿è€…è¯¦æƒ…å¼¹çª— -->
    <div id="volunteer-details-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9998; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>ğŸ’ª å¿—æ„¿è€…è¯¦æƒ…</h2>
                <button onclick="closeVolunteerDetails()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">Ã—</button>
            </div>

            <div id="volunteer-details-content">
                <!-- å¿—æ„¿è€…è¯¦æƒ…å†…å®¹å°†åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- å¯¼èˆªé€‰æ‹©å¼¹çª— -->
    <div id="navigation-choice-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 500px;">
            <h2 style="margin-bottom: 20px; text-align: center;">ğŸ§­ é€‰æ‹©å¯¼èˆªæ–¹å¼</h2>
            <p style="color: #666; margin-bottom: 25px; text-align: center; font-size: 14px;">è¯·é€‰æ‹©æ‚¨å¸¸ç”¨çš„åœ°å›¾åº”ç”¨è¿›è¡Œå¯¼èˆª</p>

            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button onclick="openExternalMap('baidu')" class="btn btn-primary" style="padding: 18px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span style="font-size: 24px;">ğŸ—ºï¸</span>
                    <span>ç™¾åº¦åœ°å›¾</span>
                </button>

                <button onclick="openExternalMap('amap')" class="btn btn-primary" style="padding: 18px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span style="font-size: 24px;">ğŸ§­</span>
                    <span>é«˜å¾·åœ°å›¾</span>
                </button>

                <button onclick="openExternalMap('tencent')" class="btn btn-primary" style="padding: 18px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span style="font-size: 24px;">ğŸ“</span>
                    <span>è…¾è®¯åœ°å›¾</span>
                </button>

                <button onclick="openExternalMap('builtin')" class="btn btn-secondary" style="padding: 18px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span style="font-size: 24px;">ğŸ—ºï¸</span>
                    <span>ä½¿ç”¨å†…ç½®åœ°å›¾</span>
                </button>
            </div>

            <button onclick="closeNavigationChoice()" class="btn btn-secondary btn-block" style="margin-top: 20px;">
                å–æ¶ˆ
            </button>
        </div>
    </div>

    <!-- åˆ›å»ºèµ›äº‹å¼¹çª— -->
    <div id="create-event-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto;">
        <div style="background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 500px; margin: 20px;">
            <h2 style="margin-bottom: 20px;">â• åˆ›å»ºæ–°èµ›äº‹</h2>

            <form id="create-event-form" onsubmit="event.preventDefault(); submitCreateEvent();">
                <div class="form-group">
                    <label class="form-label">èµ›äº‹åç§°*</label>
                    <input type="text" id="event-title" class="form-input" placeholder="ä¾‹å¦‚ï¼š6å°æ—¶æŒ‘æˆ˜èµ›" required>
                </div>

                <div class="form-group">
                    <label class="form-label">èµ›äº‹æè¿°*</label>
                    <textarea id="event-description" class="form-input" rows="3" placeholder="æè¿°èµ›äº‹å†…å®¹å’Œè§„åˆ™" required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">å‚èµ›å¯¹è±¡*</label>
                    <select id="event-target-type" class="form-input" required>
                        <option value="all">æ‰€æœ‰ç”¨æˆ·ï¼ˆç›²äºº+å¿—æ„¿è€…ï¼‰</option>
                        <option value="blind">ä»…ç›²äºº</option>
                        <option value="volunteer">ä»…å¿—æ„¿è€…</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">å®Œæˆç±»å‹*</label>
                    <select id="event-requirement-type" class="form-input" required>
                        <option value="cumulative">ç´¯è®¡å®Œæˆï¼ˆæ—¶é—´å†…ç´¯è®¡è¾¾æ ‡å³å¯ï¼‰</option>
                        <option value="consecutive">è¿ç»­å®Œæˆï¼ˆéœ€è¦è¿ç»­å®Œæˆï¼‰</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">èµ›äº‹è§„åˆ™*</label>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px;">æ—¶é—´é™åˆ¶ï¼ˆå°æ—¶ï¼‰</label>
                        <input type="number" id="event-requirement-time-limit" class="form-input" placeholder="ä¾‹å¦‚ï¼š6" min="1" required>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px;">éœ€å®Œæˆå•æ•°</label>
                        <input type="number" id="event-requirement-count" class="form-input" placeholder="ä¾‹å¦‚ï¼š3" min="1" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px;">æ¯å•æœ€ä½è·ç¦»ï¼ˆå…¬é‡Œï¼‰</label>
                        <input type="number" id="event-requirement-distance" class="form-input" placeholder="ä¾‹å¦‚ï¼š3" min="0.1" step="0.1" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">å®Œæˆå¥–åŠ±ï¼ˆç§¯åˆ†ï¼‰*</label>
                    <input type="number" id="event-reward-points" class="form-input" placeholder="ä¾‹å¦‚ï¼š500" min="1" required>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeCreateEventForm()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">åˆ›å»ºèµ›äº‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- èµ›äº‹è¯¦æƒ…å¼¹çª— -->
    <div id="event-detail-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto;">
        <div style="background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 600px; margin: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="event-detail-title">èµ›äº‹è¯¦æƒ…</h2>
                <button onclick="closeEventDetail()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">Ã—</button>
            </div>

            <div id="event-detail-content">
                <!-- èµ›äº‹è¯¦æƒ…å†…å®¹å°†åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- ç”³è¯·å†°å†»è¿èƒœå¼¹çª— -->
    <div id="request-freeze-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 500px;">
            <h2 style="margin-bottom: 20px;">â„ï¸ ç”³è¯·å†°å†»è¿èƒœ</h2>
            <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">
                å†°å†»è¿èƒœåï¼Œæ‚¨çš„è¿èƒœå°†ä¿æŒä¸å˜ï¼ŒæœŸé—´ä¸è·‘æ­¥ä¹Ÿä¸ä¼šä¸­æ–­è¿èƒœã€‚<br>
                ç”³è¯·éœ€è¦å®˜æ–¹å®¡æ ¸æ‰¹å‡†ï¼Œæ‰¹å‡†åå¯éšæ—¶è§£å†»ã€‚
            </p>

            <div class="form-group">
                <label class="form-label">ç”³è¯·ç†ç”±*</label>
                <textarea id="freeze-reason" class="form-input" rows="4" placeholder="è¯·è¯´æ˜ç”³è¯·å†°å†»è¿èƒœçš„ç†ç”±ï¼ˆå¦‚ï¼šæœŸæœ«è€ƒè¯•ã€å¤–å‡ºæ—…æ¸¸ç­‰ï¼‰" required></textarea>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closeRequestFreezeModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" style="flex: 1;" onclick="submitFreezeRequest()">æäº¤ç”³è¯·</button>
            </div>
        </div>
    </div>

    <!-- ç™»å½•æ³¨å†Œé¡µé¢ -->
    <div id="auth-page">
        <div class="auth-container">
            <div class="auth-header">
                <h1>ğŸ¤ åŠ©ç›²é™ªè·‘</h1>
                <p>è¿æ¥1700ä¸‡è§†éšœäººå£«ä¸çˆ±å¿ƒå¿—æ„¿è€…</p>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">ç™»å½•</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">æ³¨å†Œ</button>
            </div>

            <!-- ç™»å½•è¡¨å• -->
            <form id="login-form" class="auth-form active" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">æ˜µç§°</label>
                    <input type="text" id="login-username" class="form-input"
                           placeholder="è¯·è¾“å…¥æ˜µç§°" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" id="login-password" class="form-input"
                           placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">ç™»å½•</button>
            </form>

            <!-- æ³¨å†Œè¡¨å• -->
            <form id="register-form" class="auth-form" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©èº«ä»½</label>
                    <div class="role-selector">
                        <div class="role-option" onclick="selectRole('blind')" data-role="blind">
                            <div class="icon">ğŸ‘ï¸</div>
                            <div class="label">è§†éšœäººå£«</div>
                        </div>
                        <div class="role-option" onclick="selectRole('volunteer')" data-role="volunteer">
                            <div class="icon">ğŸ’ª</div>
                            <div class="label">å¿—æ„¿è€…</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">æ˜µç§°</label>
                    <input type="text" id="register-username" class="form-input"
                           placeholder="è¯·è¾“å…¥æ˜µç§°" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" id="register-password" class="form-input"
                           placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required minlength="6">
                </div>
                <div class="form-group">
                    <label class="form-label">ç¡®è®¤å¯†ç </label>
                    <input type="password" id="register-password-confirm" class="form-input"
                           placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
                </div>
                <div class="form-group">
                    <label class="form-label">è”ç³»ç”µè¯</label>
                    <input type="tel" id="register-phone" class="form-input"
                           placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">æ³¨å†Œ</button>
            </form>
        </div>
    </div>

    <!-- å¤´éƒ¨ -->
    <div class="header">
        <h1>ğŸ¤ åŠ©ç›²é™ªè·‘</h1>
        <p>è¿æ¥1700ä¸‡è§†éšœäººå£«ä¸çˆ±å¿ƒå¿—æ„¿è€…</p>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <!-- é¦–é¡µ - åœ°å›¾é¡µ -->
        <div id="page-map" class="page active">
            <div class="container">
                <div id="map"></div>

                <div id="requests-list">
                    <!-- éœ€æ±‚åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>

        <!-- å‘å¸ƒéœ€æ±‚é¡µ -->
        <div id="page-publish" class="page">
            <div class="container">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">ğŸ“ å‘å¸ƒé™ªè·‘éœ€æ±‚</h2>

                    <form id="publish-form" aria-label="å‘å¸ƒé™ªè·‘éœ€æ±‚è¡¨å•">
                        <div class="form-group">
                            <label class="form-label" for="request-age">å¹´é¾„</label>
                            <input type="number" id="request-age" class="form-input"
                                   placeholder="è¯·è¾“å…¥å¹´é¾„" required min="1" max="120"
                                   aria-label="è¾“å…¥å¹´é¾„"
                                   aria-required="true">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="request-type">æ´»åŠ¨ç±»å‹</label>
                            <input type="text" id="request-type" class="form-input"
                                   placeholder="ä¾‹å¦‚ï¼šè·‘æ­¥ã€æ•£æ­¥ã€å‡ºè¡Œç­‰" required
                                   aria-label="è¾“å…¥æ´»åŠ¨ç±»å‹"
                                   aria-required="true">
                        </div>

                        <div class="form-group">
                            <label class="form-label">åœ°ç‚¹ç±»å‹</label>
                            <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="location-type" value="destination"
                                           style="margin-right: 8px;" required checked>
                                    <span>è¦å»çš„åœ°ç‚¹</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="location-type" value="companion"
                                           style="margin-right: 8px;" required>
                                    <span>ç»“ä¼´çš„åœ°ç‚¹</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="request-location">å…·ä½“åœ°å€ï¼ˆè¯·è¾“å…¥å®Œæ•´åœ°å€ï¼‰</label>
                            <input type="text" id="request-location" class="form-input"
                                   placeholder="ä¾‹å¦‚ï¼šä¸Šæµ·å¸‚æ¨æµ¦åŒºæ”¿ç«‹è·¯485å·ï¼ˆå»ºå¹³ä¸­å­¦è¥¿æ ¡ï¼‰" required
                                   aria-label="è¾“å…¥æ´»åŠ¨åœ°ç‚¹"
                                   aria-required="true">
                        </div>

                        <div class="form-group">
                            <label class="form-label">æ¥é€æ–¹å¼</label>
                            <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="pickup-type" value="normal"
                                           style="margin-right: 8px;" required checked>
                                    <span>æ­£å¸¸æ¥é€</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="pickup-type" value="home"
                                           style="margin-right: 8px;" required>
                                    <span>åˆ°å®¶æ¥</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="request-time">æ—¶é—´</label>
                            <input type="text" id="request-time" class="form-input"
                                   placeholder="ä¾‹å¦‚ï¼šå‘¨å…­ä¸Šåˆ 9:00" required
                                   aria-label="è¾“å…¥æ´»åŠ¨æ—¶é—´"
                                   aria-required="true">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="request-phone">è”ç³»ç”µè¯</label>
                            <input type="tel" id="request-phone" class="form-input"
                                   placeholder="è¯·è¾“å…¥æ‚¨çš„è”ç³»ç”µè¯" required
                                   aria-label="è¾“å…¥è”ç³»ç”µè¯ï¼Œæ–¹ä¾¿å¿—æ„¿è€…è”ç³»æ‚¨"
                                   aria-required="true">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="request-description">è¯¦ç»†è¯´æ˜</label>
                            <textarea id="request-description" class="form-textarea"
                                      placeholder="è¯·æè¿°æ‚¨çš„éœ€æ±‚ï¼Œä¾‹å¦‚ï¼š8å²ç›²ç«¥ï¼Œå¸Œæœ›æœ‰å¿—æ„¿è€…é™ªè·‘"
                                      aria-label="è¾“å…¥è¯¦ç»†è¯´æ˜ï¼Œæè¿°æ‚¨çš„å…·ä½“éœ€æ±‚"></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary btn-block"
                                aria-label="æäº¤å¹¶å‘å¸ƒé™ªè·‘éœ€æ±‚">
                            å‘å¸ƒéœ€æ±‚
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- å¿—æ„¿è€…æ¥å•é¡µ -->
        <div id="page-volunteer" class="page">
            <div class="container">
                <h2 style="margin-bottom: 20px;">ğŸ’ª å¿—æ„¿è€…æ¥å•</h2>
                <div id="volunteer-requests-list">
                    <!-- å¯æ¥å•çš„éœ€æ±‚åˆ—è¡¨ -->
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½•é¡µ -->
        <div id="page-history" class="page">
            <div class="container">
                <h2 style="margin-bottom: 20px;">ğŸ“Š é™ªè·‘è®°å½•</h2>
                <div id="history-list">
                    <!-- å†å²è®°å½•åˆ—è¡¨ -->
                </div>
            </div>
        </div>

        <!-- ä¸ªäººä¸­å¿ƒé¡µ -->
        <div id="page-profile" class="page">
            <div class="container">
                <div class="card">
                    <h2 style="margin-bottom: 20px;">ğŸ‘¤ ä¸ªäººä¸­å¿ƒ</h2>

                    <div id="user-info-section">
                        <!-- ç”¨æˆ·ä¿¡æ¯å°†åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ç§¯åˆ†å•†åŸé¡µ -->
        <div id="page-shop" class="page">
            <div class="container">
                <h2 style="margin-bottom: 20px;">ğŸ›’ ç§¯åˆ†å•†åŸ</h2>

                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center;">
                    <div style="font-size: 16px; opacity: 0.9; margin-bottom: 5px;">æˆ‘çš„ç§¯åˆ†</div>
                    <div style="font-size: 48px; font-weight: 600;" id="shop-user-points">0</div>
                </div>

                <div id="shop-items-list">
                    <!-- å•†å“åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>

        <!-- å¿—æ„¿è€…è¯„åˆ†é¡µ -->
        <div id="page-ratings" class="page">
            <div class="container">
                <h2 style="margin-bottom: 20px;">â­ å¿—æ„¿è€…è¯„åˆ†</h2>
                <p style="color: #666; margin-bottom: 20px;">æŸ¥çœ‹æ‰€æœ‰å¿—æ„¿è€…çš„æœåŠ¡è¯„åˆ†å’Œåé¦ˆ</p>

                <div id="volunteers-ratings-list">
                    <!-- å¿—æ„¿è€…è¯„åˆ†åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>

        <!-- å®˜æ–¹å®¡æ ¸é¡µ -->
        <div id="page-review" class="page">
            <div class="container">
                <h2 style="margin-bottom: 20px;">ğŸ“‹ è¿åŠ¨è®°å½•å®¡æ ¸</h2>
                <p style="color: #666; margin-bottom: 20px;">å®¡æ ¸ç”¨æˆ·æäº¤çš„è¿åŠ¨è®°å½•</p>

                <div id="exercise-records-list">
                    <!-- è¿åŠ¨è®°å½•åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
                </div>

                <!-- è¿èƒœå†°å†»ç”³è¯·å®¡æ ¸ -->
                <div style="margin-top: 40px;">
                    <h2 style="margin-bottom: 20px;">â„ï¸ è¿èƒœå†°å†»ç”³è¯·</h2>
                    <p style="color: #666; margin-bottom: 20px;">å®¡æ ¸å¿—æ„¿è€…æäº¤çš„è¿èƒœå†°å†»ç”³è¯·</p>

                    <div id="freeze-requests-list">
                        <!-- å†°å†»ç”³è¯·åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- ç§¯åˆ†å®¡æ ¸ -->
                <div style="margin-top: 40px;">
                    <h2 style="margin-bottom: 20px;">ğŸ¯ ç§¯åˆ†ç”³è¯·å®¡æ ¸</h2>
                    <p style="color: #666; margin-bottom: 20px;">å®¡æ ¸ç”¨æˆ·æäº¤çš„æ´»åŠ¨ç§¯åˆ†ç”³è¯·</p>

                    <div id="points-requests-list">
                        <!-- ç§¯åˆ†ç”³è¯·åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»“åº“ç®¡ç†é¡µ -->
        <div id="page-warehouse" class="page">
            <div class="container">
                <h2 style="margin-bottom: 20px;">ğŸ“¦ ä»“åº“ç®¡ç†</h2>
                <p style="color: #666; margin-bottom: 20px;">ç®¡ç†ç”¨æˆ·çš„ç§¯åˆ†å…‘æ¢è®¢å•</p>

                <div id="warehouse-orders-list">
                    <!-- å…‘æ¢è®¢å•åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>

        <!-- æŠ½å¥–é¡µ -->
        <div id="page-lottery" class="page">
            <div class="container">
                <h2 style="margin-bottom: 20px;">ğŸ° å¹¸è¿è€è™æœº</h2>

                <!-- æŠ½å¥–åˆ¸ä¿¡æ¯ -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">æˆ‘çš„æŠ½å¥–åˆ¸</div>
                    <div style="font-size: 48px; font-weight: 600;" id="lottery-tickets-count">0</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">è¿ç»­7å¤©å¹³å‡æ¯å¤©3å…¬é‡Œå¯è·å¾—1å¼ </div>
                </div>

                <!-- è€è™æœºåŒºåŸŸ -->
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 30px 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                    <div style="background: #2c3e50; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <div id="slot-machine" style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
                            <!-- 5ä¸ªè€è™æœºæ§½ä½ -->
                            <div class="slot" data-slot="0" style="width: 60px; height: 100px; background: white; border-radius: 8px; overflow: hidden; position: relative; box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);">
                                <div class="slot-symbols" style="position: absolute; top: 0; left: 0; right: 0; text-align: center; transition: top 0.1s linear;">
                                    <div style="height: 100px; display: flex; align-items: center; justify-content: center; font-size: 40px;">ğŸ’</div>
                                </div>
                            </div>
                            <div class="slot" data-slot="1" style="width: 60px; height: 100px; background: white; border-radius: 8px; overflow: hidden; position: relative; box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);">
                                <div class="slot-symbols" style="position: absolute; top: 0; left: 0; right: 0; text-align: center; transition: top 0.1s linear;">
                                    <div style="height: 100px; display: flex; align-items: center; justify-content: center; font-size: 40px;">ğŸ‹</div>
                                </div>
                            </div>
                            <div class="slot" data-slot="2" style="width: 60px; height: 100px; background: white; border-radius: 8px; overflow: hidden; position: relative; box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);">
                                <div class="slot-symbols" style="position: absolute; top: 0; left: 0; right: 0; text-align: center; transition: top 0.1s linear;">
                                    <div style="height: 100px; display: flex; align-items: center; justify-content: center; font-size: 40px;">ğŸŠ</div>
                                </div>
                            </div>
                            <div class="slot" data-slot="3" style="width: 60px; height: 100px; background: white; border-radius: 8px; overflow: hidden; position: relative; box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);">
                                <div class="slot-symbols" style="position: absolute; top: 0; left: 0; right: 0; text-align: center; transition: top 0.1s linear;">
                                    <div style="height: 100px; display: flex; align-items: center; justify-content: center; font-size: 40px;">ğŸ‰</div>
                                </div>
                            </div>
                            <div class="slot" data-slot="4" style="width: 60px; height: 100px; background: white; border-radius: 8px; overflow: hidden; position: relative; box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);">
                                <div class="slot-symbols" style="position: absolute; top: 0; left: 0; right: 0; text-align: center; transition: top 0.1s linear;">
                                    <div style="height: 100px; display: flex; align-items: center; justify-content: center; font-size: 40px;">ğŸ””</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button id="spin-button" onclick="spinSlotMachine()" style="width: 100%; padding: 15px; background: white; color: #f5576c; border: none; border-radius: 8px; font-size: 18px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                        ğŸ° å¼€å§‹æŠ½å¥–
                    </button>
                </div>

                <!-- å¥–å“è¯´æ˜ -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px;">ğŸ ä¸­å¥–è§„åˆ™</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 8px;">
                            <span>ğŸ† 5ä¸ªç›¸åŒ</span>
                            <span style="color: #f5576c; font-weight: 600;">3888ç§¯åˆ†</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 8px;">
                            <span>ğŸ¥‡ 4ä¸ªç›¸åŒ</span>
                            <span style="color: #f5576c; font-weight: 600;">2888ç§¯åˆ†</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 8px;">
                            <span>ğŸ¥ˆ 3ä¸ªç›¸åŒ</span>
                            <span style="color: #f5576c; font-weight: 600;">1888ç§¯åˆ†</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 8px;">
                            <span>ğŸ¥‰ 2ä¸ªç›¸åŒ</span>
                            <span style="color: #f5576c; font-weight: 600;">888ç§¯åˆ†</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 8px;">
                            <span>ğŸ‰ å…¨ä¸åŒ</span>
                            <span style="color: #f5576c; font-weight: 600;">188ç§¯åˆ†</span>
                        </div>
                    </div>
                </div>

                <!-- ä¸­å¥–æ¦‚ç‡è¯´æ˜ -->
                <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 12px; color: white;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: 600;">ğŸ“Š ä¸­å¥–æ¦‚ç‡</h3>
                    <div style="display: flex; flex-direction: column; gap: 8px; font-size: 14px; line-height: 1.6;">
                        <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(255,255,255,0.2); border-radius: 6px;">
                            <span>ğŸ† 5ä¸ªç›¸åŒ</span>
                            <span style="font-weight: 600;">0.1%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(255,255,255,0.2); border-radius: 6px;">
                            <span>ğŸ¥‡ 4ä¸ªç›¸åŒ</span>
                            <span style="font-weight: 600;">1.9%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(255,255,255,0.2); border-radius: 6px;">
                            <span>ğŸ¥ˆ 3ä¸ªç›¸åŒ</span>
                            <span style="font-weight: 600;">5%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(255,255,255,0.2); border-radius: 6px;">
                            <span>ğŸ¥‰ 2ä¸ªç›¸åŒ</span>
                            <span style="font-weight: 600;">25%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(255,255,255,0.2); border-radius: 6px;">
                            <span>ğŸ‰ å…¨ä¸åŒ</span>
                            <span style="font-weight: 600;">68%</span>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 13px; opacity: 0.95;">
                        ğŸ’¡ <strong>æ¸©é¦¨æç¤ºï¼š</strong>æ¯æ¬¡æŠ½å¥–å¿…ä¸­å¥–ï¼Œæœ€ä½è·å¾—188ç§¯åˆ†ï¼è¿ç»­7å¤©å¹³å‡æ¯å¤©åŠ©è·‘3å…¬é‡Œå³å¯è·å¾—æŠ½å¥–åˆ¸ã€‚
                    </div>
                </div>
            </div>
        </div>

        <!-- èµ›äº‹é¡µ -->
        <div id="page-events" class="page">
            <div class="container">
                <h2 style="margin-bottom: 20px;">ğŸ† å®˜æ–¹èµ›äº‹</h2>

                <!-- å®˜æ–¹å®¡æ ¸å‘˜ï¼šåˆ›å»ºèµ›äº‹æŒ‰é’® -->
                <div id="create-event-section" style="display: none; margin-bottom: 20px;">
                    <button onclick="showCreateEventForm()" class="btn btn-primary btn-block">
                        â• åˆ›å»ºæ–°èµ›äº‹
                    </button>
                </div>

                <!-- è¿›è¡Œä¸­çš„èµ›äº‹ -->
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; color: #333;">ğŸ”¥ è¿›è¡Œä¸­çš„èµ›äº‹</h3>
                    <div id="active-events-list">
                        <!-- èµ›äº‹åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- æˆ‘çš„èµ›äº‹ -->
                <div id="my-events-section" style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; color: #333;">ğŸ“‹ æˆ‘çš„èµ›äº‹</h3>
                    <div id="my-events-list">
                        <!-- æˆ‘çš„èµ›äº‹åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- å·²ç»“æŸçš„èµ›äº‹ -->
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; color: #666;">âœ… å·²ç»“æŸçš„èµ›äº‹</h3>
                    <div id="finished-events-list">
                        <!-- å·²ç»“æŸèµ›äº‹åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchPage('map')" aria-label="åœ°å›¾é¡µé¢" data-roles="blind,volunteer">
            <span class="icon">ğŸ—ºï¸</span>
            <span class="label">åœ°å›¾</span>
        </button>
        <button class="nav-item" onclick="switchPage('publish')" aria-label="å‘å¸ƒéœ€æ±‚" data-roles="blind">
            <span class="icon">â•</span>
            <span class="label">å‘å¸ƒ</span>
        </button>
        <button class="nav-item" onclick="switchPage('volunteer')" aria-label="å¿—æ„¿è€…æ¥å•" data-roles="volunteer">
            <span class="icon">ğŸ’ª</span>
            <span class="label">æ¥å•</span>
        </button>
        <button class="nav-item" onclick="switchPage('ratings')" aria-label="å¿—æ„¿è€…è¯„åˆ†" data-roles="blind,volunteer">
            <span class="icon">â­</span>
            <span class="label">è¯„åˆ†</span>
        </button>
        <button class="nav-item" onclick="switchPage('lottery')" aria-label="æŠ½å¥–" data-roles="blind,volunteer">
            <span class="icon">ğŸ°</span>
            <span class="label">æŠ½å¥–</span>
        </button>
        <button class="nav-item" onclick="switchPage('events')" aria-label="èµ›äº‹" data-roles="blind,volunteer,official">
            <span class="icon">ğŸ†</span>
            <span class="label">èµ›äº‹</span>
        </button>
        <button class="nav-item" onclick="switchPage('review')" aria-label="å®¡æ ¸ç®¡ç†" data-roles="official">
            <span class="icon">ğŸ“‹</span>
            <span class="label">å®¡æ ¸</span>
        </button>
        <button class="nav-item" onclick="switchPage('warehouse')" aria-label="ä»“åº“ç®¡ç†" data-roles="official">
            <span class="nav-badge hidden" id="warehouse-badge">0</span>
            <span class="icon">ğŸ“¦</span>
            <span class="label">ä»“åº“</span>
        </button>
        <button class="nav-item" onclick="switchPage('history')" aria-label="å†å²è®°å½•" data-roles="blind,volunteer">
            <span class="icon">ğŸ“Š</span>
            <span class="label">è®°å½•</span>
        </button>
        <button class="nav-item" onclick="switchPage('profile')" aria-label="ä¸ªäººä¸­å¿ƒ" data-roles="blind,volunteer,official">
            <span class="icon">ğŸ‘¤</span>
            <span class="label">æˆ‘çš„</span>
        </button>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let selectedRole = null; // æ³¨å†Œæ—¶é€‰æ‹©çš„èº«ä»½

        // ç™»å½•æ³¨å†ŒåŠŸèƒ½
        function switchAuthTab(tab) {
            // åˆ‡æ¢æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // åˆ‡æ¢è¡¨å•æ˜¾ç¤º
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            if (tab === 'login') {
                document.getElementById('login-form').classList.add('active');
            } else {
                document.getElementById('register-form').classList.add('active');
            }
        }

        // é€‰æ‹©èº«ä»½
        function selectRole(role) {
            selectedRole = role;
            document.querySelectorAll('.role-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.closest('.role-option').classList.add('selected');
        }

        // å¤„ç†ç™»å½•
        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            // ä»localStorageè·å–æ‰€æœ‰ç”¨æˆ·
            const users = JSON.parse(localStorage.getItem('users') || '[]');

            // æŸ¥æ‰¾ç”¨æˆ·
            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                // ç™»å½•æˆåŠŸ
                localStorage.setItem('currentUser', JSON.stringify(user));
                alert('ç™»å½•æˆåŠŸï¼');

                // éšè—ç™»å½•é¡µé¢
                document.getElementById('auth-page').classList.add('hidden');

                // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
                loadUserProfile();

                // æ›´æ–°ä»“åº“å°çº¢ç‚¹
                updateWarehouseBadge();
            } else {
                alert('æ˜µç§°æˆ–å¯†ç é”™è¯¯ï¼');
            }
        }

        // å¤„ç†æ³¨å†Œ
        function handleRegister(event) {
            event.preventDefault();

            if (!selectedRole) {
                alert('è¯·é€‰æ‹©èº«ä»½ï¼');
                return;
            }

            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            const phone = document.getElementById('register-phone').value.trim();

            // éªŒè¯å¯†ç 
            if (password !== passwordConfirm) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼');
                return;
            }

            // è·å–ç°æœ‰ç”¨æˆ·
            const users = JSON.parse(localStorage.getItem('users') || '[]');

            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
            if (users.find(u => u.username === username)) {
                alert('è¯¥æ˜µç§°å·²è¢«ä½¿ç”¨ï¼');
                return;
            }

            // åˆ›å»ºæ–°ç”¨æˆ·
            const newUser = {
                id: StorageManager.generateId(),
                username: username,
                name: username, // æ·»åŠ nameå­—æ®µä»¥ä¿æŒå…¼å®¹æ€§
                password: password,
                type: selectedRole,
                phone: phone,
                points: 0, // åˆå§‹ç§¯åˆ†
                pointsHistory: [], // ç§¯åˆ†å†å²è®°å½•
                lastCheckIn: null, // æœ€åç­¾åˆ°æ—¥æœŸ
                certified: false,
                createdAt: Date.now(),
                // è¿èƒœç³»ç»Ÿå­—æ®µ
                currentStreak: 0, // å½“å‰è¿èƒœå¤©æ•°
                totalStreak: 0, // æ€»è¿èƒœå¤©æ•°ï¼ˆä¸åŒ…æ‹¬ç«ç‚¬ç»­çš„å¤©æ•°ï¼‰
                lastStreakDate: null, // æœ€åä¸€æ¬¡æ´»åŠ¨æ—¥æœŸ
                streakTorches: 0, // è¿èƒœç«ç‚¬æ•°é‡
                lotteryTickets: 1 // æ³¨å†Œèµ é€1å¼ æŠ½å¥–åˆ¸
            };

            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));

            // è‡ªåŠ¨ç™»å½•
            localStorage.setItem('currentUser', JSON.stringify(newUser));

            alert('æ³¨å†ŒæˆåŠŸï¼');

            // éšè—ç™»å½•é¡µé¢
            document.getElementById('auth-page').classList.add('hidden');

            // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
            loadUserProfile();
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkAuth() {
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                // å·²ç™»å½•ï¼Œéšè—ç™»å½•é¡µé¢
                document.getElementById('auth-page').classList.add('hidden');

                // æ ¹æ®ç”¨æˆ·èº«ä»½æ›´æ–°å¯¼èˆªæ 
                updateNavigation(JSON.parse(currentUser));
            } else {
                // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢
                document.getElementById('auth-page').classList.remove('hidden');
            }
        }

        // æ ¹æ®ç”¨æˆ·èº«ä»½æ›´æ–°å¯¼èˆªæ 
        function updateNavigation(user) {
            console.log('[DEBUG] æ›´æ–°å¯¼èˆªæ  - ç”¨æˆ·ç±»å‹:', user.type);
            const navItems = document.querySelectorAll('.nav-item');

            navItems.forEach(item => {
                const roles = item.getAttribute('data-roles');
                const label = item.querySelector('.label')?.textContent || 'æœªçŸ¥';

                if (roles) {
                    // æ£€æŸ¥å½“å‰ç”¨æˆ·ç±»å‹æ˜¯å¦åœ¨å…è®¸çš„è§’è‰²åˆ—è¡¨ä¸­
                    const allowedRoles = roles.split(',').map(r => r.trim());
                    const isAllowed = allowedRoles.includes(user.type);

                    if (isAllowed) {
                        item.style.display = 'flex'; // æ˜¾ç¤ºæŒ‰é’®
                        console.log(`[DEBUG] æ˜¾ç¤ºæŒ‰é’®: ${label} (å…è®¸è§’è‰²: ${roles})`);
                    } else {
                        item.style.display = 'none'; // éšè—æŒ‰é’®
                        console.log(`[DEBUG] éšè—æŒ‰é’®: ${label} (å…è®¸è§’è‰²: ${roles})`);
                    }
                }
            });

            console.log('[DEBUG] å¯¼èˆªæ æ›´æ–°å®Œæˆ');
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('currentUser');
                alert('å·²é€€å‡ºç™»å½•');
                location.reload();
            }
        }

        // åœ°å›¾ç®¡ç†
        let map = null;
        let markers = [];

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            // ä¸Šæµ·å¸‚ä¸­å¿ƒåæ ‡
            const shanghaiCenter = [31.2304, 121.4737];

            // åˆ›å»ºåœ°å›¾å®ä¾‹
            map = L.map('map').setView(shanghaiCenter, 12);

            // æ·»åŠ åœ°å›¾å›¾å±‚ - ä½¿ç”¨é«˜å¾·åœ°å›¾ï¼ˆå›½å†…è®¿é—®æ›´ç¨³å®šï¼‰
            L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
                attribution: 'Â© é«˜å¾·åœ°å›¾',
                maxZoom: 19,
                minZoom: 10,
                subdomains: ['1', '2', '3', '4']
            }).addTo(map);

            // æ·»åŠ åœ°å›¾æ§ä»¶è¯´æ˜
            const info = L.control({position: 'topright'});
            info.onAdd = function() {
                const div = L.DomUtil.create('div', 'map-info');
                div.innerHTML = '<div style="background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">' +
                    '<strong>ğŸ—ºï¸ ä¸Šæµ·åœ°å›¾</strong><br>' +
                    '<small>å¯ç¼©æ”¾ã€æ‹–åŠ¨æŸ¥çœ‹</small>' +
                    '</div>';
                return div;
            };
            info.addTo(map);

            // åŠ è½½éœ€æ±‚æ ‡è®°
            loadMapMarkers();
        }

        // åŠ è½½åœ°å›¾æ ‡è®°
        function loadMapMarkers() {
            if (!map) return;

            // æ¸…é™¤ç°æœ‰æ ‡è®°
            markers.forEach(marker => marker.remove());
            markers = [];

            const requests = StorageManager.getRequests();

            // ä¸ºæ¯ä¸ªéœ€æ±‚æ·»åŠ æ ‡è®°
            requests.forEach(req => {
                // æ¨¡æ‹Ÿåæ ‡ï¼ˆå®é™…åº”ç”¨ä¸­åº”è¯¥ä»éœ€æ±‚ä¸­è·å–çœŸå®åæ ‡ï¼‰
                const lat = 31.2304 + (Math.random() - 0.5) * 0.1;
                const lng = 121.4737 + (Math.random() - 0.5) * 0.1;

                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: ${req.status === 'pending' ? '#fa8c16' : '#52c41a'};
                                       color: white;
                                       padding: 8px 12px;
                                       border-radius: 20px;
                                       font-size: 14px;
                                       font-weight: 600;
                                       box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                                       white-space: nowrap;">
                            ${req.type === 'running' ? 'ğŸƒ' : req.type === 'walking' ? 'ğŸš¶' : 'ğŸšŒ'}
                            ${req.userName}
                           </div>`,
                    iconSize: [120, 40],
                    iconAnchor: [60, 40]
                });

                const marker = L.marker([lat, lng], {icon: icon}).addTo(map);

                // æ·»åŠ å¼¹çª—
                marker.bindPopup(`
                    <div style="min-width: 200px;">
                        <strong style="font-size: 16px;">${req.userName}</strong>
                        ${req.age ? `<span style="color: #666; font-size: 14px;"> (${req.age}å²)</span>` : ''}<br>
                        <span style="color: #666;">
                            ${req.type || 'æ´»åŠ¨'}
                        </span><br>
                        <strong>ğŸ“ ${req.locationTypeText || 'åœ°ç‚¹'}ï¼š</strong> ${req.location}<br>
                        <strong>ğŸ•</strong> ${req.time}<br>
                        ${req.phone ? `<strong>ğŸ“±</strong> <a href="tel:${req.phone}" style="color: #667eea;">${req.phone}</a><br>` : ''}
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0;">
                            ${req.description}
                        </div>
                        <div style="margin-top: 10px;">
                            <span style="padding: 4px 8px; background: ${req.status === 'pending' ? '#fff7e6' : '#f6ffed'};
                                         color: ${req.status === 'pending' ? '#fa8c16' : '#52c41a'};
                                         border-radius: 4px; font-size: 12px;">
                                ${req.status === 'pending' ? 'ç­‰å¾…æ¥å•' : 'å·²åŒ¹é…'}
                            </span>
                        </div>
                    </div>
                `);

                markers.push(marker);
            });
        }

        // æ•°æ®å­˜å‚¨ç®¡ç†
        class StorageManager {
            static generateId() {
                return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            static getRequests() {
                const data = localStorage.getItem('requests');
                return data ? JSON.parse(data) : [];
            }

            static saveRequests(requests) {
                localStorage.setItem('requests', JSON.stringify(requests));
            }

            static addRequest(request) {
                const requests = this.getRequests();
                request.id = this.generateId();
                request.createdAt = Date.now();
                request.status = 'pending';
                requests.unshift(request);
                this.saveRequests(requests);
                return request;
            }

            static updateRequest(id, updates) {
                const requests = this.getRequests();
                const index = requests.findIndex(r => r.id === id);
                if (index !== -1) {
                    requests[index] = { ...requests[index], ...updates };
                    this.saveRequests(requests);
                    return requests[index];
                }
                return null;
            }

            static getUserInfo() {
                const data = localStorage.getItem('userInfo');
                return data ? JSON.parse(data) : null;
            }

            static saveUserInfo(info) {
                localStorage.setItem('userInfo', JSON.stringify(info));
            }

            static getHistory() {
                const data = localStorage.getItem('history');
                return data ? JSON.parse(data) : [];
            }

            static addHistory(record) {
                const history = this.getHistory();
                record.id = this.generateId();
                record.createdAt = Date.now();
                history.unshift(record);
                localStorage.setItem('history', JSON.stringify(history));
            }

            static getExerciseRecords() {
                const data = localStorage.getItem('exerciseRecords');
                return data ? JSON.parse(data) : [];
            }

            static addExerciseRecord(record) {
                const records = this.getExerciseRecords();
                records.unshift(record);
                localStorage.setItem('exerciseRecords', JSON.stringify(records));
            }

            static updateExerciseRecord(id, updates) {
                const records = this.getExerciseRecords();
                const index = records.findIndex(r => r.id === id);
                if (index !== -1) {
                    records[index] = { ...records[index], ...updates };
                    localStorage.setItem('exerciseRecords', JSON.stringify(records));
                    return records[index];
                }
                return null;
            }

            static getShopItems() {
                const data = localStorage.getItem('shopItems');
                return data ? JSON.parse(data) : [];
            }

            static saveShopItems(items) {
                localStorage.setItem('shopItems', JSON.stringify(items));
            }

            static updateShopItem(id, updates) {
                const items = this.getShopItems();
                const index = items.findIndex(i => i.id === id);
                if (index !== -1) {
                    items[index] = { ...items[index], ...updates };
                    this.saveShopItems(items);
                    return items[index];
                }
                return null;
            }

            static addPurchaseRecord(record) {
                const purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
                record.id = this.generateId();
                record.createdAt = Date.now();
                purchases.unshift(record);
                localStorage.setItem('purchases', JSON.stringify(purchases));
            }

            static initDemoData() {
                if (this.getRequests().length === 0) {
                    const demoRequests = [
                        {
                            id: this.generateId(),
                            userName: 'å°æ˜çš„å®¶é•¿',
                            userType: 'blind',
                            type: 'running',
                            location: 'ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒºä¸–çºªå…¬å›­',
                            time: 'å‘¨å…­ä¸Šåˆ 9:00',
                            description: '8å²ç›²ç«¥ï¼Œå¸Œæœ›æœ‰å¿—æ„¿è€…é™ªè·‘ï¼Œå­©å­å¾ˆå–œæ¬¢è¿åŠ¨',
                            status: 'pending',
                            createdAt: Date.now() - 3600000
                        },
                        {
                            id: this.generateId(),
                            userName: 'æå¥³å£«',
                            userType: 'blind',
                            type: 'walking',
                            location: 'ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒºé™†å®¶å˜´',
                            time: 'å‘¨æ—¥ä¸‹åˆ 3:00',
                            description: 'æƒ³å»é™„è¿‘å…¬å›­æ•£æ­¥ï¼Œå‘¼å¸æ–°é²œç©ºæ°”',
                            status: 'pending',
                            createdAt: Date.now() - 7200000
                        },
                        {
                            id: this.generateId(),
                            userName: 'ç‹å…ˆç”Ÿ',
                            userType: 'blind',
                            type: 'travel',
                            location: 'åŒ—äº¬å¸‚æœé˜³åŒº',
                            time: 'å‘¨äº”ä¸‹åˆ 2:00',
                            description: 'éœ€è¦å»åŒ»é™¢å¤æŸ¥ï¼Œå¸Œæœ›æœ‰å¿—æ„¿è€…é™ªåŒ',
                            status: 'pending',
                            createdAt: Date.now() - 10800000
                        }
                    ];
                    this.saveRequests(demoRequests);
                }
            }

            static initShopItems() {
                const existingItems = this.getShopItems();

                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ è¿èƒœç«ç‚¬ï¼ˆè¿ç§»é€»è¾‘ï¼‰
                if (existingItems.length > 0) {
                    let needsUpdate = false;

                    // åˆ é™¤GPSå®šä½å™¨
                    const gpsIndex = existingItems.findIndex(item => item.name && item.name.includes('GPS'));
                    if (gpsIndex !== -1) {
                        existingItems.splice(gpsIndex, 1);
                        needsUpdate = true;
                        console.log('âœ… å·²åˆ é™¤GPSå®šä½å™¨');
                    }

                    // æ›´æ–°å•†å“ä»·æ ¼
                    const priceMap = {
                        'çˆ±å¿ƒå¾½ç« ': 188,
                        'è¿åŠ¨æ¯›å·¾': 388,
                        'è¿åŠ¨æ°´å£¶': 688,
                        'è¿åŠ¨å¸½å­': 888,
                        'åŠ©ç›²é™ªè·‘å¸½å­': 888,
                        'è¿åŠ¨Tæ¤': 988,
                        'å¿—æ„¿è€…Tæ¤': 988,
                        'è¿åŠ¨è…°åŒ…': 1088,
                        'è¿åŠ¨æŠ¤è†': 1288,
                        'è¿åŠ¨åå…‰èƒŒå¿ƒ': 1388,
                        'åå…‰èƒŒå¿ƒ': 1388,
                        'è¿åŠ¨æ‰‹ç¯': 5888,
                        'è·‘æ­¥æ‰‹ç¯': 5888,
                        'è¿èƒœç«ç‚¬': 50
                    };

                    existingItems.forEach(item => {
                        if (priceMap[item.name] !== undefined && item.price !== priceMap[item.name]) {
                            item.price = priceMap[item.name];
                            needsUpdate = true;
                        }
                    });

                    const hasTorch = existingItems.some(item => item.id === 'streak_torch' || item.type === 'streak_torch');
                    if (!hasTorch) {
                        // æ·»åŠ è¿èƒœç«ç‚¬åˆ°ç°æœ‰å•†å“åˆ—è¡¨
                        existingItems.push({
                            id: 'streak_torch',
                            name: 'è¿èƒœç«ç‚¬',
                            icon: 'ğŸ”¦',
                            description: 'è¿èƒœä¿æŠ¤é“å…·ï¼å½“æ‚¨å¿˜è®°æ‰“å¡æ—¶ï¼Œç«ç‚¬ä¼šè‡ªåŠ¨ä½¿ç”¨ï¼Œä¿æŒæ‚¨çš„è¿èƒœå¤©æ•°ä¸ä¸­æ–­ã€‚æ³¨æ„ï¼šç«ç‚¬åªä¿æŒè¿èƒœï¼Œä¸ä¼šå¢åŠ æ€»è¿èƒœå¤©æ•°ã€‚',
                            price: 50,
                            stock: 999,
                            type: 'streak_torch'
                        });
                        needsUpdate = true;
                        console.log('âœ… å·²è‡ªåŠ¨æ·»åŠ è¿èƒœç«ç‚¬åˆ°å•†åŸ');
                    }

                    if (needsUpdate) {
                        this.saveShopItems(existingItems);
                        console.log('âœ… å·²æ›´æ–°å•†å“ä»·æ ¼');
                    }

                    return;
                }

                // é¦–æ¬¡åˆå§‹åŒ–ï¼šåˆ›å»ºæ‰€æœ‰æ¼”ç¤ºå•†å“
                if (existingItems.length === 0) {
                    const demoItems = [
                        {
                            id: this.generateId(),
                            name: 'çˆ±å¿ƒå¾½ç« ',
                            icon: 'ğŸ…',
                            description: 'åŠ©ç›²é™ªè·‘çˆ±å¿ƒå¾½ç« ï¼Œè¡¨å½°æ‚¨çš„å¿—æ„¿æœåŠ¡ï¼Œå¯ä½©æˆ´åœ¨è¡£æœæˆ–èƒŒåŒ…ä¸Š',
                            price: 188,
                            stock: 100
                        },
                        {
                            id: this.generateId(),
                            name: 'è¿åŠ¨æ¯›å·¾',
                            icon: 'ğŸ§£',
                            description: 'å¸æ±—é€Ÿå¹²è¿åŠ¨æ¯›å·¾ï¼ŒæŸ”è½¯äº²è‚¤ï¼Œè¿åŠ¨åå¿«é€Ÿæ“¦æ±—',
                            price: 388,
                            stock: 50
                        },
                        {
                            id: this.generateId(),
                            name: 'è¿åŠ¨æ°´å£¶',
                            icon: 'ğŸ¥¤',
                            description: 'ä¾¿æºè¿åŠ¨æ°´å£¶ï¼Œä¿æ¸©ä¿å†·ï¼Œé™ªè·‘å¿…å¤‡è£…å¤‡',
                            price: 688,
                            stock: 30
                        },
                        {
                            id: this.generateId(),
                            name: 'è¿åŠ¨å¸½å­',
                            icon: 'ğŸ§¢',
                            description: 'ä¸“ä¸ºåŠ©ç›²é™ªè·‘è®¾è®¡çš„è¿åŠ¨å¸½ï¼Œé€æ°”èˆ’é€‚ï¼Œå¸¦æœ‰åå…‰æ¡ï¼Œæå‡å¤œè·‘å®‰å…¨æ€§',
                            price: 888,
                            stock: 20
                        },
                        {
                            id: this.generateId(),
                            name: 'è¿åŠ¨Tæ¤',
                            icon: 'ğŸ‘•',
                            description: 'å¿—æ„¿è€…ä¸“å±Tæ¤ï¼Œå°æœ‰åŠ©ç›²é™ªè·‘æ ‡å¿—ï¼Œè®©æ‚¨çš„çˆ±å¿ƒè¢«çœ‹è§',
                            price: 988,
                            stock: 15
                        },
                        {
                            id: this.generateId(),
                            name: 'è¿åŠ¨è…°åŒ…',
                            icon: 'ğŸ‘',
                            description: 'è½»ä¾¿è¿åŠ¨è…°åŒ…ï¼Œå¯æ”¾ç½®æ‰‹æœºã€é’¥åŒ™ç­‰å°ç‰©å“ï¼Œè·‘æ­¥ä¸æ™ƒåŠ¨',
                            price: 1088,
                            stock: 30
                        },
                        {
                            id: this.generateId(),
                            name: 'è¿åŠ¨æŠ¤è†',
                            icon: 'ğŸ¦µ',
                            description: 'ä¸“ä¸šè¿åŠ¨æŠ¤è†ï¼Œä¿æŠ¤è†ç›–ï¼Œå‡å°‘è¿åŠ¨æŸä¼¤ï¼Œé€‚åˆé•¿è·ç¦»è·‘æ­¥',
                            price: 1288,
                            stock: 25
                        },
                        {
                            id: this.generateId(),
                            name: 'è¿åŠ¨åå…‰èƒŒå¿ƒ',
                            icon: 'ğŸ¦º',
                            description: 'é«˜å¯è§åº¦åå…‰èƒŒå¿ƒï¼Œå¤œè·‘å¿…å¤‡ï¼Œ360åº¦åå…‰è®¾è®¡ï¼Œç¡®ä¿å®‰å…¨',
                            price: 1388,
                            stock: 35
                        },
                        {
                            id: this.generateId(),
                            name: 'è¿åŠ¨æ‰‹ç¯',
                            icon: 'âŒš',
                            description: 'æ™ºèƒ½è¿åŠ¨æ‰‹ç¯ï¼Œè®°å½•è¿åŠ¨æ•°æ®ï¼Œç›‘æµ‹å¿ƒç‡ï¼Œè®©é™ªè·‘æ›´ç§‘å­¦',
                            price: 5888,
                            stock: 10
                        },
                        {
                            id: 'streak_torch',
                            name: 'è¿èƒœç«ç‚¬',
                            icon: 'ğŸ”¦',
                            description: 'è¿èƒœä¿æŠ¤é“å…·ï¼å½“æ‚¨å¿˜è®°æ‰“å¡æ—¶ï¼Œç«ç‚¬ä¼šè‡ªåŠ¨ä½¿ç”¨ï¼Œä¿æŒæ‚¨çš„è¿èƒœå¤©æ•°ä¸ä¸­æ–­ã€‚æ³¨æ„ï¼šç«ç‚¬åªä¿æŒè¿èƒœï¼Œä¸ä¼šå¢åŠ æ€»è¿èƒœå¤©æ•°ã€‚',
                            price: 50,
                            stock: 999,
                            type: 'streak_torch'
                        }
                    ];
                    this.saveShopItems(demoItems);
                }
            }

            // èµ›äº‹ç›¸å…³æ–¹æ³•
            static getEvents() {
                const data = localStorage.getItem('events');
                return data ? JSON.parse(data) : [];
            }

            static saveEvents(events) {
                localStorage.setItem('events', JSON.stringify(events));
            }

            static addEvent(event) {
                const events = this.getEvents();
                event.id = this.generateId();
                event.createdAt = Date.now();
                event.status = 'active';
                events.unshift(event);
                this.saveEvents(events);
                return event;
            }

            static updateEvent(id, updates) {
                const events = this.getEvents();
                const index = events.findIndex(e => e.id === id);
                if (index !== -1) {
                    events[index] = { ...events[index], ...updates };
                    this.saveEvents(events);
                    return events[index];
                }
                return null;
            }

            static getEventParticipations() {
                const data = localStorage.getItem('eventParticipations');
                return data ? JSON.parse(data) : [];
            }

            static saveEventParticipations(participations) {
                localStorage.setItem('eventParticipations', JSON.stringify(participations));
            }

            static addEventParticipation(participation) {
                const participations = this.getEventParticipations();
                participation.id = this.generateId();
                participation.registeredAt = Date.now();
                participation.progress = { completed: 0, records: [] };
                participation.completed = false;
                participation.rewarded = false;
                participations.unshift(participation);
                this.saveEventParticipations(participations);
                return participation;
            }

            static updateEventParticipation(id, updates) {
                const participations = this.getEventParticipations();
                const index = participations.findIndex(p => p.id === id);
                if (index !== -1) {
                    participations[index] = { ...participations[index], ...updates };
                    this.saveEventParticipations(participations);
                    return participations[index];
                }
                return null;
            }

            // è¿èƒœå†°å†»è¯·æ±‚ç®¡ç†
            static getStreakFreezeRequests() {
                const data = localStorage.getItem('streakFreezeRequests');
                return data ? JSON.parse(data) : [];
            }

            static saveStreakFreezeRequests(requests) {
                localStorage.setItem('streakFreezeRequests', JSON.stringify(requests));
            }

            static addStreakFreezeRequest(request) {
                const requests = this.getStreakFreezeRequests();
                request.id = this.generateId();
                request.requestedAt = Date.now();
                request.status = 'pending';
                requests.unshift(request);
                this.saveStreakFreezeRequests(requests);
                return request;
            }

            static updateStreakFreezeRequest(id, updates) {
                const requests = this.getStreakFreezeRequests();
                const index = requests.findIndex(r => r.id === id);
                if (index !== -1) {
                    requests[index] = { ...requests[index], ...updates };
                    this.saveStreakFreezeRequests(requests);
                    return requests[index];
                }
                return null;
            }

            static getUsers() {
                const data = localStorage.getItem('users');
                return data ? JSON.parse(data) : [];
            }

            static saveUsers(users) {
                localStorage.setItem('users', JSON.stringify(users));
            }

            static getDailyStats() {
                const data = localStorage.getItem('dailyStats');
                return data ? JSON.parse(data) : { date: null, totalDistance: 0, totalUsers: 0 };
            }
        }

        // é¡µé¢åˆ‡æ¢
        function switchPage(pageName) {
            // æƒé™æ£€æŸ¥
            const currentUserStr = localStorage.getItem('currentUser');
            if (currentUserStr) {
                const currentUser = JSON.parse(currentUserStr);

                // ç›²äººç”¨æˆ·ä¸èƒ½è®¿é—®æ¥å•é¡µé¢
                if (currentUser.type === 'blind' && pageName === 'volunteer') {
                    alert('è§†éšœç”¨æˆ·æ— æ³•è®¿é—®æ¥å•é¡µé¢');
                    return;
                }

                // å¿—æ„¿è€…ä¸èƒ½è®¿é—®å‘å¸ƒé¡µé¢
                if (currentUser.type === 'volunteer' && pageName === 'publish') {
                    alert('å¿—æ„¿è€…æ— æ³•è®¿é—®å‘å¸ƒé¡µé¢');
                    return;
                }

                // åªæœ‰å®˜æ–¹è´¦å·å¯ä»¥è®¿é—®å®¡æ ¸é¡µé¢
                if (currentUser.type !== 'official' && pageName === 'review') {
                    alert('åªæœ‰å®˜æ–¹å®¡æ ¸å‘˜å¯ä»¥è®¿é—®å®¡æ ¸é¡µé¢');
                    return;
                }

                // åªæœ‰å®˜æ–¹è´¦å·å¯ä»¥è®¿é—®ä»“åº“é¡µé¢
                if (currentUser.type !== 'official' && pageName === 'warehouse') {
                    alert('åªæœ‰å®˜æ–¹å®¡æ ¸å‘˜å¯ä»¥è®¿é—®ä»“åº“é¡µé¢');
                    return;
                }
            }

            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            document.getElementById('page-' + pageName).classList.add('active');

            // æ›´æ–°å¯¼èˆªæ çŠ¶æ€
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // åˆ·æ–°é¡µé¢å†…å®¹
            if (pageName === 'map') {
                loadRequestsList();
            } else if (pageName === 'volunteer') {
                loadVolunteerRequests();
            } else if (pageName === 'history') {
                loadHistory();
            } else if (pageName === 'profile') {
                loadUserProfile();
            } else if (pageName === 'shop') {
                loadShop();
            } else if (pageName === 'ratings') {
                loadVolunteersRatings();
            } else if (pageName === 'review') {
                loadExerciseRecords();
                loadStreakFreezeRequests();
                loadPointsRequests();
            } else if (pageName === 'warehouse') {
                loadWarehouse();
            } else if (pageName === 'lottery') {
                loadLottery();
            } else if (pageName === 'events') {
                loadEvents();
            }
        }

        // åŠ è½½éœ€æ±‚åˆ—è¡¨
        function loadRequestsList() {
            const requests = StorageManager.getRequests();
            const container = document.getElementById('requests-list');
            const currentUserStr = localStorage.getItem('currentUser');
            const currentUser = currentUserStr ? JSON.parse(currentUserStr) : null;

            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“­</div>
                        <div>æš‚æ— éœ€æ±‚</div>
                        <div style="font-size: 14px; margin-top: 10px;">
                            ç‚¹å‡»ä¸‹æ–¹"å‘å¸ƒ"æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªéœ€æ±‚
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = requests.map(req => `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <strong style="font-size: 18px;">${req.userName}</strong>
                            ${req.userType === 'blind' ? '<span class="tag tag-certified">è§†éšœç”¨æˆ·</span>' : ''}
                            ${req.age ? `<span style="color: #666; font-size: 14px; margin-left: 8px;">${req.age}å²</span>` : ''}
                        </div>
                        <span class="tag tag-${req.status}">
                            ${req.status === 'pending' ? 'ç­‰å¾…æ¥å•' : req.status === 'matched' ? 'å·²åŒ¹é…' : 'å·²å®Œæˆ'}
                        </span>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <span class="tag tag-running">
                            ${req.type || 'æ´»åŠ¨'}
                        </span>
                    </div>

                    <div style="margin-bottom: 8px;">
                        <strong>ğŸ“ ${req.locationTypeText || 'åœ°ç‚¹'}ï¼š</strong>${req.location}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>ğŸ• æ—¶é—´ï¼š</strong>${req.time}
                    </div>
                    ${req.phone ? `<div style="margin-bottom: 8px;">
                        <strong>ğŸ“± è”ç³»ç”µè¯ï¼š</strong><a href="tel:${req.phone}" style="color: #667eea; text-decoration: none;">${req.phone}</a>
                    </div>` : ''}
                    <div style="margin-bottom: 15px; color: #666;">
                        ${req.description}
                    </div>

                    ${currentUser && req.userName === currentUser.username && req.status === 'matched' && req.pickupType === 'home' ? `
                        <button onclick="updatePickupLocation('${req.id}')" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;">
                            ğŸ“ æ›´æ–°æ¥é€åœ°ç‚¹
                        </button>
                    ` : ''}

                    <div style="font-size: 12px; color: #999;">
                        å‘å¸ƒäº ${formatTime(req.createdAt)}
                    </div>
                </div>
            `).join('');
        }

        // æ›´æ–°æ¥é€åœ°ç‚¹
        function updatePickupLocation(requestId) {
            const requests = StorageManager.getRequests();
            const request = requests.find(r => r.id === requestId);

            if (!request) {
                alert('æœªæ‰¾åˆ°è¯¥éœ€æ±‚');
                return;
            }

            const newLocation = prompt('è¯·è¾“å…¥æ–°çš„æ¥é€åœ°ç‚¹ï¼š', request.location);

            if (!newLocation || newLocation.trim() === '') {
                return; // ç”¨æˆ·å–æ¶ˆæˆ–æœªè¾“å…¥
            }

            if (newLocation.trim() === request.location) {
                alert('åœ°ç‚¹æœªå‘ç”Ÿå˜åŒ–');
                return;
            }

            // æ›´æ–°è¯·æ±‚ä¿¡æ¯
            StorageManager.updateRequest(requestId, {
                location: newLocation.trim(),
                destinationChanged: true
            });

            alert('âœ… åœ°ç‚¹æ›´æ–°æˆåŠŸï¼\n\nå¿—æ„¿è€…å°†æ”¶åˆ°é€šçŸ¥å¹¶æ›´æ–°å¯¼èˆªè·¯çº¿ã€‚');
            loadRequestsList();
        }

        // æ—¶é—´æ ¼å¼åŒ–
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 3600000) {
                return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            } else if (diff < 86400000) {
                return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            } else {
                return Math.floor(diff / 86400000) + 'å¤©å‰';
            }
        }

        // åŠ è½½å¿—æ„¿è€…æ¥å•é¡µé¢
        function loadVolunteerRequests() {
            const requests = StorageManager.getRequests().filter(r => r.status === 'pending');
            const container = document.getElementById('volunteer-requests-list');

            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">âœ…</div>
                        <div>æš‚æ— å¾…æ¥å•éœ€æ±‚</div>
                        <div style="font-size: 14px; margin-top: 10px;">
                            æ‰€æœ‰éœ€æ±‚éƒ½å·²è¢«æ¥å•
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = requests.map(req => `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <strong style="font-size: 18px;">${req.userName}</strong>
                            ${req.userType === 'blind' ? '<span class="tag tag-certified">è§†éšœç”¨æˆ·</span>' : ''}
                            ${req.age ? `<span style="color: #666; font-size: 14px; margin-left: 8px;">${req.age}å²</span>` : ''}
                        </div>
                        <span class="tag tag-pending">ç­‰å¾…æ¥å•</span>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <span class="tag tag-running">
                            ${req.type || 'æ´»åŠ¨'}
                        </span>
                    </div>

                    <div style="margin-bottom: 8px;">
                        <strong>ğŸ“ ${req.locationTypeText || 'åœ°ç‚¹'}ï¼š</strong>${req.location}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>ğŸ• æ—¶é—´ï¼š</strong>${req.time}
                    </div>
                    ${req.phone ? `<div style="margin-bottom: 8px;">
                        <strong>ğŸ“± è”ç³»ç”µè¯ï¼š</strong><a href="tel:${req.phone}" style="color: #667eea; text-decoration: none; font-weight: 600;">${req.phone}</a>
                    </div>` : ''}
                    <div style="margin-bottom: 15px; color: #666;">
                        ${req.description}
                    </div>

                    <div style="font-size: 12px; color: #999; margin-bottom: 15px;">
                        å‘å¸ƒäº ${formatTime(req.createdAt)}
                    </div>

                    <button class="btn btn-success btn-block" onclick="acceptRequest('${req.id}')">
                        æ¥å•å¹¶è”ç³»
                    </button>
                </div>
            `).join('');
        }

        // æ¥å•åŠŸèƒ½
        function acceptRequest(requestId) {
            const currentUserStr = localStorage.getItem('currentUser');
            if (!currentUserStr) {
                alert('è¯·å…ˆç™»å½•');
                location.reload();
                return;
            }

            const userInfo = JSON.parse(currentUserStr);

            if (userInfo.type !== 'volunteer') {
                alert('åªæœ‰å¿—æ„¿è€…å¯ä»¥æ¥å•');
                return;
            }

            const request = StorageManager.updateRequest(requestId, {
                status: 'matched',
                volunteerId: userInfo.id,
                volunteerName: userInfo.username,
                matchedAt: Date.now()
            });

            if (request) {
                // æ·»åŠ åˆ°å†å²è®°å½•
                StorageManager.addHistory({
                    requestId: request.id,
                    userName: request.userName,
                    volunteerName: userInfo.username,
                    type: request.type,
                    location: request.location,
                    time: request.time,
                    status: 'matched'
                });

                // å¥–åŠ±å¿—æ„¿è€…5ç§¯åˆ†
                userInfo.points = (userInfo.points || 0) + 5;
                localStorage.setItem('currentUser', JSON.stringify(userInfo));

                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIndex = users.findIndex(u => u.id === userInfo.id);
                if (userIndex !== -1) {
                    users[userIndex].points = userInfo.points;
                    localStorage.setItem('users', JSON.stringify(users));
                }

                alert('æ¥å•æˆåŠŸï¼æ‚¨è·å¾— 5 ç§¯åˆ†');

                // ä¿å­˜å½“å‰æ¥å•ä¿¡æ¯åˆ°localStorage
                localStorage.setItem('currentNavigation', JSON.stringify({
                    requestId: request.id,
                    userName: request.userName,
                    userPhone: request.userPhone,
                    destination: request.location,
                    destinationCoords: request.coordinates || [31.2404, 121.4837],
                    pickupType: request.pickupType || 'normal', // normal: æ­£å¸¸æ¥é€, home: åˆ°å®¶æ¥
                    startTime: Date.now()
                }));

                // æ˜¾ç¤ºå¯¼èˆªé€‰æ‹©å¼¹çª—
                showNavigationChoice();
            }
        }

        // å¯åŠ¨å¯¼èˆªåŠŸèƒ½
        function startNavigation(request) {
            if (!map) {
                initMap();
            }

            // è·å–å½“å‰ä½ç½®ï¼ˆæ¨¡æ‹Ÿï¼‰
            const currentLocation = [31.2304, 121.4737]; // å®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨GPSè·å–
            const destination = request.coordinates || [31.2404, 121.4837]; // ç›®çš„åœ°åæ ‡

            // æ¸…é™¤ç°æœ‰æ ‡è®°
            markers.forEach(marker => marker.remove());
            markers = [];

            // æ·»åŠ èµ·ç‚¹æ ‡è®°ï¼ˆå¿—æ„¿è€…å½“å‰ä½ç½®ï¼‰
            const startMarker = L.marker(currentLocation, {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background: #28a745; color: white; padding: 8px 12px; border-radius: 20px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">ğŸ“ æˆ‘çš„ä½ç½®</div>',
                    iconSize: [120, 40]
                })
            }).addTo(map);
            markers.push(startMarker);

            // æ·»åŠ ç»ˆç‚¹æ ‡è®°ï¼ˆç›²äººä½ç½®ï¼‰
            const endMarker = L.marker(destination, {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #dc3545; color: white; padding: 8px 12px; border-radius: 20px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">ğŸ¯ ${request.userName}</div>`,
                    iconSize: [120, 40]
                })
            }).addTo(map);
            markers.push(endMarker);

            // ç»˜åˆ¶è·¯çº¿ï¼ˆç®€å•ç›´çº¿ï¼Œå®é™…åº”ä½¿ç”¨è·¯çº¿è§„åˆ’APIï¼‰
            const routeLine = L.polyline([currentLocation, destination], {
                color: '#667eea',
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);
            markers.push(routeLine);

            // è°ƒæ•´åœ°å›¾è§†å›¾ä»¥æ˜¾ç¤ºå®Œæ•´è·¯çº¿
            map.fitBounds([currentLocation, destination], { padding: [50, 50] });

            // æ˜¾ç¤ºå¯¼èˆªä¿¡æ¯é¢æ¿
            showNavigationPanel(request);
        }

        // æ˜¾ç¤ºå¯¼èˆªé€‰æ‹©å¼¹çª—
        function showNavigationChoice() {
            document.getElementById('navigation-choice-modal').style.display = 'flex';
        }

        // å…³é—­å¯¼èˆªé€‰æ‹©å¼¹çª—
        function closeNavigationChoice() {
            document.getElementById('navigation-choice-modal').style.display = 'none';
        }

        // æ‰“å¼€å¤–éƒ¨åœ°å›¾æˆ–å†…ç½®åœ°å›¾
        function openExternalMap(mapType) {
            const navigationStr = localStorage.getItem('currentNavigation');
            if (!navigationStr) {
                alert('å¯¼èˆªä¿¡æ¯ä¸å­˜åœ¨');
                return;
            }

            const navigation = JSON.parse(navigationStr);
            const destination = navigation.destination;
            const coords = navigation.destinationCoords || [31.2404, 121.4837];
            const lat = coords[0];
            const lng = coords[1];

            // å…³é—­å¯¼èˆªé€‰æ‹©å¼¹çª—
            closeNavigationChoice();

            if (mapType === 'builtin') {
                // ä½¿ç”¨å†…ç½®åœ°å›¾
                switchPage('map');
                const request = {
                    userName: navigation.userName,
                    location: destination,
                    coordinates: coords
                };
                startNavigation(request);
            } else if (mapType === 'baidu') {
                // ç™¾åº¦åœ°å›¾
                const baiduUrl = `https://api.map.baidu.com/marker?location=${lat},${lng}&title=${encodeURIComponent(destination)}&content=${encodeURIComponent('ç›®çš„åœ°')}&output=html&src=webapp.baidu.openAPIdemo`;
                window.open(baiduUrl, '_blank');
            } else if (mapType === 'amap') {
                // é«˜å¾·åœ°å›¾
                const amapUrl = `https://uri.amap.com/navigation?to=${lng},${lat},${encodeURIComponent(destination)}&mode=walk&coordinate=gaode&callnative=1`;
                window.open(amapUrl, '_blank');
            } else if (mapType === 'tencent') {
                // è…¾è®¯åœ°å›¾
                const tencentUrl = `https://apis.map.qq.com/uri/v1/routeplan?type=walk&to=${encodeURIComponent(destination)}&tocoord=${lat},${lng}&policy=0&referer=myapp`;
                window.open(tencentUrl, '_blank');
            }
        }

        // æ˜¾ç¤ºå¯¼èˆªä¿¡æ¯é¢æ¿
        function showNavigationPanel(request) {
            // åˆ›å»ºå¯¼èˆªé¢æ¿
            const navPanel = document.createElement('div');
            navPanel.id = 'navigationPanel';
            navPanel.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 20px;
                right: 20px;
                background: white;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 1000;
            `;

            navPanel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #333;">ğŸ§­ å¯¼èˆªä¸­</h3>
                    <button onclick="stopNavigation()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                        ç»“æŸå¯¼èˆª
                    </button>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                    <div style="margin-bottom: 10px;">
                        <strong>ğŸ‘¤ æœåŠ¡å¯¹è±¡ï¼š</strong>${request.userName}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>ğŸ“ ç›®çš„åœ°ï¼š</strong>${request.location}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>ğŸ“ è”ç³»ç”µè¯ï¼š</strong>${request.userPhone || 'æœªæä¾›'}
                    </div>
                    <div>
                        <strong>ğŸ·ï¸ æ¥é€ç±»å‹ï¼š</strong>
                        <span style="padding: 4px 10px; background: ${request.pickupType === 'home' ? '#ffc107' : '#28a745'}; color: white; border-radius: 12px; font-size: 13px;">
                            ${request.pickupType === 'home' ? 'åˆ°å®¶æ¥' : 'æ­£å¸¸æ¥é€'}
                        </span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="openExternalNavigation('${request.location}')" class="btn btn-primary" style="flex: 1;">
                        ğŸ—ºï¸ æ‰“å¼€å¤–éƒ¨å¯¼èˆª
                    </button>
                    <button onclick="callUser('${request.userPhone}')" class="btn btn-success" style="flex: 1;">
                        ğŸ“ æ‹¨æ‰“ç”µè¯
                    </button>
                </div>
            `;

            // ç§»é™¤æ—§çš„å¯¼èˆªé¢æ¿ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const oldPanel = document.getElementById('navigationPanel');
            if (oldPanel) {
                oldPanel.remove();
            }

            document.body.appendChild(navPanel);

            // ç›‘å¬ç›®çš„åœ°å˜æ›´
            checkDestinationChanges(request.id);
        }

        // ç»“æŸå¯¼èˆª
        function stopNavigation() {
            if (confirm('ç¡®å®šè¦ç»“æŸå¯¼èˆªå—ï¼Ÿ')) {
                const navPanel = document.getElementById('navigationPanel');
                if (navPanel) {
                    navPanel.remove();
                }
                localStorage.removeItem('currentNavigation');
                alert('å¯¼èˆªå·²ç»“æŸ');
                loadMapMarkers(); // é‡æ–°åŠ è½½åœ°å›¾æ ‡è®°
            }
        }

        // æ‰“å¼€å¤–éƒ¨å¯¼èˆªåº”ç”¨
        function openExternalNavigation(destination) {
            // å°è¯•æ‰“å¼€é«˜å¾·åœ°å›¾ã€ç™¾åº¦åœ°å›¾æˆ–å…¶ä»–å¯¼èˆªåº”ç”¨
            const encodedDest = encodeURIComponent(destination);

            // é«˜å¾·åœ°å›¾URL scheme
            const gaodeUrl = `androidamap://route?sourceApplication=ç›²äººï¿½ï¿½ï¿½è¡Œ&dlat=&dlon=&dname=${encodedDest}&dev=0&t=0`;

            // ç™¾åº¦åœ°å›¾URL scheme
            const baiduUrl = `baidumap://map/direction?destination=name:${encodedDest}&coord_type=bd09ll&mode=driving`;

            // å°è¯•æ‰“å¼€å¯¼èˆªåº”ç”¨
            alert(`æ­£åœ¨å°è¯•æ‰“å¼€å¤–éƒ¨å¯¼èˆªåº”ç”¨...\nç›®çš„åœ°ï¼š${destination}\n\nå¦‚æœæ²¡æœ‰è‡ªåŠ¨æ‰“å¼€ï¼Œè¯·æ‰‹åŠ¨åœ¨åœ°å›¾åº”ç”¨ä¸­æœç´¢è¯¥åœ°å€ã€‚`);

            // å°è¯•æ‰“å¼€é«˜å¾·åœ°å›¾
            window.location.href = gaodeUrl;

            // å¦‚æœå¤±è´¥ï¼Œ2ç§’åå°è¯•ç™¾åº¦åœ°å›¾
            setTimeout(() => {
                window.location.href = baiduUrl;
            }, 2000);
        }

        // æ‹¨æ‰“ç”µè¯
        function callUser(phone) {
            if (!phone || phone === 'æœªæä¾›') {
                alert('è¯¥ç”¨æˆ·æœªæä¾›è”ç³»ç”µè¯');
                return;
            }
            window.location.href = `tel:${phone}`;
        }

        // ç›‘å¬ç›®çš„åœ°å˜æ›´
        function checkDestinationChanges(requestId) {
            // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡ç›®çš„åœ°æ˜¯å¦å˜æ›´
            const checkInterval = setInterval(() => {
                const currentNav = localStorage.getItem('currentNavigation');
                if (!currentNav) {
                    clearInterval(checkInterval);
                    return;
                }

                const requests = StorageManager.getRequests();
                const request = requests.find(r => r.id === requestId);

                if (request && request.destinationChanged) {
                    clearInterval(checkInterval);
                    alert(`âš ï¸ ç›®çš„åœ°å·²å˜æ›´ï¼\næ–°ç›®çš„åœ°ï¼š${request.location}\n\nè¯·æ³¨æ„æŸ¥çœ‹æ–°çš„å¯¼èˆªè·¯çº¿ã€‚`);

                    // é‡æ–°å¯åŠ¨å¯¼èˆª
                    startNavigation(request);

                    // æ¸…é™¤å˜æ›´æ ‡è®°
                    StorageManager.updateRequest(requestId, { destinationChanged: false });
                }
            }, 5000);
        }

        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            const history = StorageManager.getHistory();
            const container = document.getElementById('history-list');
            const currentUserStr = localStorage.getItem('currentUser');
            const currentUser = currentUserStr ? JSON.parse(currentUserStr) : null;

            if (history.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“</div>
                        <div>æš‚æ— é™ªè·‘è®°å½•</div>
                        <div style="font-size: 14px; margin-top: 10px;">
                            å®Œæˆé™ªè·‘åä¼šåœ¨è¿™é‡Œæ˜¾ç¤ºè®°å½•
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = history.map(record => {
                const hasFeedback = record.feedback && record.feedback.rating;
                const isBlindUser = currentUser && currentUser.type === 'blind' && currentUser.username === record.userName;

                return `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <strong style="font-size: 18px;">é™ªè·‘è®°å½•</strong>
                        </div>
                        <span class="tag tag-${record.status}">
                            ${record.status === 'matched' ? 'å·²åŒ¹é…' : 'å·²å®Œæˆ'}
                        </span>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <span class="tag tag-running">
                            ${record.type || 'æ´»åŠ¨'}
                        </span>
                    </div>

                    <div style="margin-bottom: 8px;">
                        <strong>ğŸ‘¤ è§†éšœç”¨æˆ·ï¼š</strong>${record.userName}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>ğŸ’ª å¿—æ„¿è€…ï¼š</strong>${record.volunteerName}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>ğŸ“ åœ°ç‚¹ï¼š</strong>${record.location}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>ğŸ• æ—¶é—´ï¼š</strong>${record.time}
                    </div>

                    ${hasFeedback ? `
                        <div style="margin-top: 15px; padding: 15px; background: #f6ffed; border-radius: 8px; border-left: 4px solid #52c41a;">
                            <div style="margin-bottom: 8px;">
                                <strong>â­ è¯„åˆ†ï¼š</strong>
                                ${'â­'.repeat(record.feedback.rating)}
                                <span style="color: #666;">(${record.feedback.rating}/5)</span>
                            </div>
                            ${record.feedback.comment ? `
                                <div style="margin-bottom: 8px;">
                                    <strong>ğŸ’¬ è¯„ä»·ï¼š</strong>${record.feedback.comment}
                                </div>
                            ` : ''}
                            <div style="font-size: 12px; color: #999;">
                                è¯„ä»·äº ${formatTime(record.feedback.createdAt)}
                            </div>
                        </div>
                    ` : ''}

                    <div style="font-size: 12px; color: #999; margin-top: 15px;">
                        è®°å½•äº ${formatTime(record.createdAt)}
                    </div>

                    ${record.status === 'matched' && isBlindUser ? `
                        <button class="btn btn-success btn-block" style="margin-top: 15px;"
                                onclick="completeRecord('${record.id}')">
                            æ ‡è®°ä¸ºå·²å®Œæˆ
                        </button>
                    ` : ''}

                    ${record.status === 'completed' && isBlindUser && !hasFeedback ? `
                        <button class="btn btn-primary btn-block" style="margin-top: 15px;"
                                onclick="showFeedbackForm('${record.id}')">
                            â­ è¯„ä»·å¿—æ„¿è€…
                        </button>
                    ` : ''}
                </div>
            `;
            }).join('');
        }

        // æ›´æ–°ç”¨æˆ·è¿èƒœ
        // æ®µä½ç³»ç»Ÿé…ç½®
        const STREAK_RANKS = {
            iron: { name: 'é»‘é“', minDays: 0, maxDays: 13, requiredDistance: 0.4, dailyReward: 0, icon: 'âš«', color: '#666' },
            bronze: { name: 'é’é“œ', minDays: 14, maxDays: 29, requiredDistance: 0.4, dailyReward: 10, icon: 'ğŸŸ¤', color: '#cd7f32' },
            silver: { name: 'ç™½é“¶', minDays: 30, maxDays: 60, requiredDistance: 0.4, dailyReward: 10, icon: 'âšª', color: '#c0c0c0' },
            gold: { name: 'é»„é‡‘', minDays: 61, maxDays: 89, requiredDistance: 0.8, dailyReward: 25, icon: 'ğŸŸ¡', color: '#ffd700' },
            diamond: { name: 'é’»çŸ³', minDays: 90, maxDays: 179, requiredDistance: 0.8, dailyReward: 25, icon: 'ğŸ’', color: '#b9f2ff' },
            king: { name: 'ç‹è€…', minDays: 180, maxDays: Infinity, requiredDistance: 1.0, dailyReward: 50, icon: 'ğŸ‘‘', color: '#ff6b6b' }
        };

        // æ ¹æ®è¿èƒœå¤©æ•°è·å–æ®µä½
        function getStreakRank(streakDays) {
            for (let rankKey in STREAK_RANKS) {
                const rank = STREAK_RANKS[rankKey];
                if (streakDays >= rank.minDays && streakDays <= rank.maxDays) {
                    return { key: rankKey, ...rank };
                }
            }
            return { key: 'iron', ...STREAK_RANKS.iron };
        }

        // æ£€æŸ¥å¹¶æ›´æ–°è·ç¦»åˆ¸è¿›åº¦
        function checkDistanceMasterTicket(user, users) {
            // åˆå§‹åŒ–è·ç¦»åˆ¸ç›¸å…³å­—æ®µ
            if (user.distanceChallengeProgress === undefined) user.distanceChallengeProgress = 0;
            if (user.distanceChallengeLastDate === undefined) user.distanceChallengeLastDate = null;
            if (user.distanceMasterTickets === undefined) user.distanceMasterTickets = 0;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTimestamp = today.getTime();

            // è®¡ç®—ç”¨æˆ·ä»Šå¤©çš„æ€»è·ç¦»ï¼ˆæ±‡æ€»æ‰€æœ‰å®¡æ ¸é€šè¿‡çš„è¿åŠ¨è®°å½•ï¼‰
            const exerciseRecords = StorageManager.getExerciseRecords();
            let todayTotalDistance = 0;

            exerciseRecords.forEach(record => {
                if (record.status !== 'approved') return;
                const recordDate = new Date(record.approvedAt || record.submittedAt);
                recordDate.setHours(0, 0, 0, 0);

                if (recordDate.getTime() === todayTimestamp) {
                    // æ£€æŸ¥è¿™æ¡è®°å½•æ˜¯å¦å±äºå½“å‰ç”¨æˆ·
                    const history = StorageManager.getHistory();
                    const historyRecord = history.find(h => h.id === record.recordId);
                    if (historyRecord) {
                        if ((user.type === 'volunteer' && historyRecord.volunteerName === user.username) ||
                            (user.type === 'blind' && historyRecord.userName === user.username)) {
                            todayTotalDistance += parseFloat(record.distance) || 0;
                        }
                    }
                }
            });

            let message = '';

            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°7å…¬é‡Œ
            if (todayTotalDistance >= 7) {
                // æ£€æŸ¥æ˜¯å¦è¿ç»­
                let isConsecutive = false;
                if (user.distanceChallengeLastDate) {
                    const lastDate = new Date(user.distanceChallengeLastDate);
                    lastDate.setHours(0, 0, 0, 0);
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    yesterday.setHours(0, 0, 0, 0);

                    isConsecutive = lastDate.getTime() === yesterday.getTime();
                }

                if (isConsecutive) {
                    // è¿ç»­çš„ï¼Œå¢åŠ è¿›åº¦
                    user.distanceChallengeProgress += 1;
                } else {
                    // ä¸è¿ç»­æˆ–ç¬¬ä¸€æ¬¡ï¼Œé‡ç½®ä¸º1
                    user.distanceChallengeProgress = 1;
                }

                user.distanceChallengeLastDate = todayTimestamp;

                // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°3å¤©
                if (user.distanceChallengeProgress >= 3) {
                    user.distanceMasterTickets += 1;
                    message = `ğŸ« è¿ç»­3å¤©è·‘è¶…7å…¬é‡Œï¼è·å¾—ç¬¬${user.distanceMasterTickets}å¼ è·ç¦»åˆ¸`;
                    // é‡ç½®è¿›åº¦ï¼Œé˜²æ­¢éª—åˆ¸
                    user.distanceChallengeProgress = 0;
                    user.distanceChallengeLastDate = null;
                }
            } else {
                // æ²¡è¾¾åˆ°7å…¬é‡Œï¼Œé‡ç½®è¿›åº¦
                if (user.distanceChallengeProgress > 0) {
                    user.distanceChallengeProgress = 0;
                    user.distanceChallengeLastDate = null;
                }
            }

            return { message, ticketAwarded: message !== '' };
        }

        function updateUserStreak(user, users, distance = 0) {
            // åˆå§‹åŒ–è¿èƒœå­—æ®µï¼ˆå…¼å®¹æ—§ç”¨æˆ·ï¼‰
            if (user.currentStreak === undefined) user.currentStreak = 0;
            if (user.totalStreak === undefined) user.totalStreak = 0;
            if (user.lastStreakDate === undefined) user.lastStreakDate = null;
            if (user.streakTorches === undefined) user.streakTorches = 0;
            if (user.streakMasterTickets === undefined) user.streakMasterTickets = 0;
            if (user.dailyDistance === undefined) user.dailyDistance = 0;
            if (user.dailyDistanceDate === undefined) user.dailyDistanceDate = null;
            if (user.streakRank === undefined) user.streakRank = 'iron';
            if (user.streakFrozen === undefined) user.streakFrozen = false;
            if (user.streakFreezeStartDate === undefined) user.streakFreezeStartDate = null;

            // æ£€æŸ¥è¿èƒœæ˜¯å¦è¢«å†°å†»
            if (user.streakFrozen) {
                console.log('[DEBUG] ç”¨æˆ·è¿èƒœå·²å†°å†»ï¼Œè·³è¿‡è¿èƒœæ›´æ–°');
                const currentRank = getStreakRank(user.currentStreak);
                return {
                    message: `â„ï¸ è¿èƒœå·²å†°å†»ï¼Œå½“å‰ä¿æŒï¼š${user.currentStreak}å¤© ${currentRank.icon}${currentRank.name}`,
                    streakUpdated: false
                };
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTimestamp = today.getTime();

            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„ä¸€å¤©ï¼Œå¦‚æœæ˜¯åˆ™é‡ç½®å½“å¤©è·ç¦»
            if (!user.dailyDistanceDate || new Date(user.dailyDistanceDate).setHours(0, 0, 0, 0) !== todayTimestamp) {
                user.dailyDistance = 0;
                user.dailyDistanceDate = todayTimestamp;
            }

            // ç´¯åŠ å½“å¤©è·ç¦»
            user.dailyDistance += distance;

            // è·å–å½“å‰æ®µä½å’Œæ‰€éœ€è·ç¦»
            const currentRank = getStreakRank(user.currentStreak);
            const requiredDistance = currentRank.requiredDistance;
            const requiredMeters = requiredDistance * 1000;

            // æ£€æŸ¥ç´¯è®¡è·ç¦»æ˜¯å¦è¾¾åˆ°æ®µä½è¦æ±‚
            if (user.dailyDistance < requiredDistance) {
                return {
                    message: `ä»Šæ—¥å·²è·‘${(user.dailyDistance * 1000).toFixed(0)}ç±³ï¼Œè¿˜éœ€${(requiredMeters - user.dailyDistance * 1000).toFixed(0)}ç±³è¾¾åˆ°${currentRank.icon}${currentRank.name}è¿èƒœè¦æ±‚`,
                    streakUpdated: false
                };
            }

            // å¦‚æœä»Šå¤©å·²ç»æ‰“å¡è¿‡è¿èƒœï¼Œä¸é‡å¤è®¡ç®—
            if (user.lastStreakDate && new Date(user.lastStreakDate).setHours(0, 0, 0, 0) === todayTimestamp) {
                return { message: 'ä»Šæ—¥è¿èƒœå·²è®°å½•', streakUpdated: false };
            }

            let message = '';
            let usedTorch = false;
            let rankUpMessage = '';
            let dailyRewardPoints = 0;

            if (!user.lastStreakDate) {
                // ç¬¬ä¸€æ¬¡æ´»åŠ¨
                user.currentStreak = 1;
                user.totalStreak = 1;
                user.streakRank = 'iron';
                message = 'ğŸ‰ å¼€å§‹è¿èƒœï¼å½“å‰è¿èƒœï¼š1å¤© âš«é»‘é“';
            } else {
                const lastDate = new Date(user.lastStreakDate);
                lastDate.setHours(0, 0, 0, 0);
                const lastTimestamp = lastDate.getTime();
                const daysDiff = Math.floor((todayTimestamp - lastTimestamp) / (1000 * 60 * 60 * 24));

                if (daysDiff === 1) {
                    // è¿ç»­çš„ç¬¬äºŒå¤©
                    const oldRank = getStreakRank(user.currentStreak);
                    user.currentStreak += 1;
                    user.totalStreak += 1;
                    const newRank = getStreakRank(user.currentStreak);
                    user.streakRank = newRank.key;

                    message = `ğŸ”¥ è¿èƒœç»§ç»­ï¼å½“å‰è¿èƒœï¼š${user.currentStreak}å¤© ${newRank.icon}${newRank.name}`;

                    // æ£€æŸ¥æ˜¯å¦æ®µä½æ™‹å‡
                    if (oldRank.key !== newRank.key) {
                        rankUpMessage = `\nğŸŠ æ®µä½æ™‹å‡ï¼${oldRank.icon}${oldRank.name} â†’ ${newRank.icon}${newRank.name}`;
                        if (newRank.requiredDistance > oldRank.requiredDistance) {
                            rankUpMessage += `\næ¯æ—¥è¦æ±‚æå‡è‡³${(newRank.requiredDistance * 1000).toFixed(0)}ç±³`;
                        }
                    }

                    // å‘æ”¾æ¯æ—¥ç§¯åˆ†å¥–åŠ±ï¼ˆé»‘é“æ— å¥–åŠ±ï¼‰
                    if (newRank.dailyReward > 0) {
                        dailyRewardPoints = newRank.dailyReward;
                        const earnedAt = Date.now();
                        const expiresAt = earnedAt + 365 * 24 * 60 * 60 * 1000;

                        if (!user.pointsHistory) {
                            user.pointsHistory = [];
                        }
                        user.pointsHistory.push({
                            points: dailyRewardPoints,
                            earnedAt: earnedAt,
                            expiresAt: expiresAt,
                            source: 'daily_streak',
                            description: `${newRank.icon}${newRank.name}è¿èƒœæ¯æ—¥å¥–åŠ±`
                        });

                        // é‡æ–°è®¡ç®—æ€»ç§¯åˆ†
                        const now = Date.now();
                        user.points = user.pointsHistory
                            .filter(p => (!p.expiresAt || p.expiresAt > now) && !p.spent)
                            .reduce((sum, p) => sum + p.points, 0);

                        message += `\nğŸ’° è·å¾—æ¯æ—¥å¥–åŠ±ï¼š${dailyRewardPoints}ç§¯åˆ†`;
                    }

                    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç›²è·‘å¤§å¸ˆåˆ¸é‡Œç¨‹ç¢‘
                    if (user.currentStreak === 30 && user.streakMasterTickets === 0) {
                        user.streakMasterTickets = 1;
                        message += '\nğŸ« è·å¾—ç¬¬1å¼ "è¿èƒœç›²è·‘å¤§å¸ˆ"åˆ¸ï¼';
                    } else if (user.currentStreak === 61 && user.streakMasterTickets === 1) {
                        user.streakMasterTickets = 2;
                        message += '\nğŸ« è·å¾—ç¬¬2å¼ "è¿èƒœç›²è·‘å¤§å¸ˆ"åˆ¸ï¼';
                    } else if (user.currentStreak === 180 && user.streakMasterTickets === 2) {
                        user.streakMasterTickets = 3;
                        message += '\nğŸ« è·å¾—ç¬¬3å¼ "è¿èƒœç›²è·‘å¤§å¸ˆ"åˆ¸ï¼';
                    }

                    if (rankUpMessage) {
                        message += rankUpMessage;
                    }
                } else if (daysDiff > 1) {
                    // ä¸­æ–­äº†ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç«ç‚¬
                    if (user.streakTorches > 0) {
                        // è‡ªåŠ¨ä½¿ç”¨ç«ç‚¬
                        user.streakTorches -= 1;
                        usedTorch = true;
                        const currentRank = getStreakRank(user.currentStreak);
                        // ç«ç‚¬åªä¿æŒè¿èƒœï¼Œä¸å¢åŠ æ€»å¤©æ•°
                        message = `ğŸ”¦ è‡ªåŠ¨ä½¿ç”¨è¿èƒœç«ç‚¬ï¼ä¿æŒè¿èƒœï¼š${user.currentStreak}å¤© ${currentRank.icon}${currentRank.name}\nå‰©ä½™ç«ç‚¬ï¼š${user.streakTorches}ä¸ª`;
                    } else {
                        // æ²¡æœ‰ç«ç‚¬ï¼Œè¿èƒœä¸­æ–­
                        const oldStreak = user.currentStreak;
                        const oldRank = getStreakRank(user.currentStreak);
                        const oldTickets = user.streakMasterTickets;
                        user.currentStreak = 1;
                        user.totalStreak = 1;
                        user.streakRank = 'iron';
                        user.streakMasterTickets = 0; // æ”¶å›æ‰€æœ‰åˆ¸
                        message = `ğŸ’” è¿èƒœä¸­æ–­ï¼ˆä¹‹å‰${oldStreak}å¤© ${oldRank.icon}${oldRank.name}ï¼‰\né‡æ–°å¼€å§‹ï¼š1å¤© âš«é»‘é“`;
                        if (oldTickets > 0) {
                            message += `\nğŸ« æ”¶å›${oldTickets}å¼ "è¿èƒœç›²è·‘å¤§å¸ˆ"åˆ¸`;
                        }
                    }
                }
            }

            user.lastStreakDate = todayTimestamp;

            // æ›´æ–°usersæ•°ç»„ä¸­çš„ç”¨æˆ·æ•°æ®
            const userIndex = users.findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                users[userIndex] = user;
            }

            return { message, streakUpdated: true, usedTorch };
        }

        // å®Œæˆé™ªè·‘è®°å½•
        function completeRecord(recordId, rating, comment, imageData) {
            // ä½¿ç”¨APIæ›´æ–°è®°å½•çŠ¶æ€
            fetch('/api/history/' + recordId + '/complete', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // å¼¹å‡ºè¿åŠ¨è®°å½•æäº¤è¡¨å•
                    showExerciseRecordForm(recordId, rating, comment, imageData);
                } else {
                    alert('æ“ä½œå¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('å®Œæˆè®°å½•é”™è¯¯:', error);
                // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œå›é€€åˆ°localStorageæ–¹å¼
                const history = StorageManager.getHistory();
                const index = history.findIndex(r => r.id === recordId);
                if (index !== -1) {
                    history[index].status = 'pending_review';
                    history[index].completedAt = Date.now();
                    // ä¿å­˜è¯„åˆ†
                    if (rating) {
                        history[index].feedback = {
                            rating: rating,
                            comment: comment,
                            image: imageData,
                            createdAt: Date.now(),
                            hasRealFeedback: comment && comment.length >= 5
                        };
                    }
                    localStorage.setItem('history', JSON.stringify(history));
                    showExerciseRecordForm(recordId);
                } else {
                    alert('è®°å½•ä¸å­˜åœ¨');
                }
            });
        }

        // å®¡æ ¸é€šè¿‡åå¥–åŠ±ç§¯åˆ†å’Œè¿èƒœ
        function approveExerciseRecord(exerciseRecordId) {
            const exerciseRecord = StorageManager.getExerciseRecords().find(r => r.id === exerciseRecordId);
            if (!exerciseRecord) {
                alert('è¿åŠ¨è®°å½•ä¸å­˜åœ¨');
                return;
            }

            // æ›´æ–°è¿åŠ¨è®°å½•çŠ¶æ€ä¸ºå·²é€šè¿‡
            StorageManager.updateExerciseRecord(exerciseRecordId, {
                status: 'approved',
                approvedAt: Date.now()
            });

            // æ›´æ–°å†å²è®°å½•çŠ¶æ€
            const history = StorageManager.getHistory();
            const historyIndex = history.findIndex(r => r.id === exerciseRecord.recordId);
            if (historyIndex !== -1) {
                history[historyIndex].status = 'completed';
                localStorage.setItem('history', JSON.stringify(history));

                const record = history[historyIndex];
                const users = JSON.parse(localStorage.getItem('users') || '[]');

                // æ‰¾åˆ°å¿—æ„¿è€…å’Œç›²äººç”¨æˆ·
                const volunteer = users.find(u => u.username === record.volunteerName && u.type === 'volunteer');
                const blindUser = users.find(u => u.username === record.userName && u.type === 'blind');

                let streakMessages = [];

                // ç§¯åˆ†æœ‰æ•ˆæœŸè®¾ç½®ï¼ˆ1å¹´ï¼‰
                const earnedAt = Date.now();
                const expiresAt = earnedAt + 365 * 24 * 60 * 60 * 1000;

                // æ ¹æ®è·ç¦»è®¡ç®—ç§¯åˆ†
                const pointsReward = calculatePoints(exerciseRecord.distance);

                // å¥–åŠ±å¿—æ„¿è€…ç§¯åˆ†å’Œè¿èƒœ
                if (volunteer) {
                    // ä½¿ç”¨pointsHistoryæ·»åŠ ç§¯åˆ†
                    if (!volunteer.pointsHistory) {
                        volunteer.pointsHistory = [];
                    }
                    volunteer.pointsHistory.push({
                        points: pointsReward.volunteer,
                        earnedAt: earnedAt,
                        expiresAt: expiresAt,
                        source: 'exercise',
                        recordId: exerciseRecord.id,
                        description: `é™ªè·‘${exerciseRecord.distance.toFixed(2)}kmå¥–åŠ±`
                    });

                    // è®¡ç®—æœ‰æ•ˆç§¯åˆ†æ€»å’Œï¼ˆæ’é™¤è¿‡æœŸç§¯åˆ†ï¼‰
                    const now = Date.now();
                    volunteer.points = volunteer.pointsHistory
                        .filter(p => p.expiresAt > now)
                        .reduce((sum, p) => sum + p.points, 0);

                    // ç´¯åŠ åŠ©è·‘è·ç¦»
                    volunteer.totalDistance = (volunteer.totalDistance || 0) + exerciseRecord.distance;
                    const volunteerStreakResult = updateUserStreak(volunteer, users, exerciseRecord.distance);
                    if (volunteerStreakResult.streakUpdated && volunteerStreakResult.message) {
                        streakMessages.push('å¿—æ„¿è€…ï¼š' + volunteerStreakResult.message);
                    } else if (!volunteerStreakResult.streakUpdated && volunteerStreakResult.message) {
                        streakMessages.push('å¿—æ„¿è€…ï¼š' + volunteerStreakResult.message);
                    }
                }

                // å¥–åŠ±ç›²äººç§¯åˆ†å’Œè¿èƒœ
                if (blindUser) {
                    // ä½¿ç”¨pointsHistoryæ·»åŠ ç§¯åˆ†
                    if (!blindUser.pointsHistory) {
                        blindUser.pointsHistory = [];
                    }
                    blindUser.pointsHistory.push({
                        points: pointsReward.blind,
                        earnedAt: earnedAt,
                        expiresAt: expiresAt,
                        source: 'exercise',
                        recordId: exerciseRecord.id,
                        description: `è·‘æ­¥${exerciseRecord.distance.toFixed(2)}kmå¥–åŠ±`
                    });

                    // è®¡ç®—æœ‰æ•ˆç§¯åˆ†æ€»å’Œï¼ˆæ’é™¤è¿‡æœŸç§¯åˆ†ï¼‰
                    const now = Date.now();
                    blindUser.points = blindUser.pointsHistory
                        .filter(p => p.expiresAt > now)
                        .reduce((sum, p) => sum + p.points, 0);

                    // ç´¯åŠ è¢«åŠ©è·‘è·ç¦»
                    blindUser.totalDistance = (blindUser.totalDistance || 0) + exerciseRecord.distance;
                    const blindStreakResult = updateUserStreak(blindUser, users, exerciseRecord.distance);
                    if (blindStreakResult.streakUpdated && blindStreakResult.message) {
                        streakMessages.push('ç›²äººï¼š' + blindStreakResult.message);
                    } else if (!blindStreakResult.streakUpdated && blindStreakResult.message) {
                        streakMessages.push('ç›²äººï¼š' + blindStreakResult.message);
                    }
                }

                // æ£€æŸ¥è·ç¦»åˆ¸ï¼ˆå¿—æ„¿è€…å’Œç›²äººï¼‰
                if (volunteer) {
                    const volunteerTicketResult = checkDistanceMasterTicket(volunteer, users);
                    if (volunteerTicketResult.message) {
                        streakMessages.push('å¿—æ„¿è€…ï¼š' + volunteerTicketResult.message);
                    }
                }

                if (blindUser) {
                    const blindTicketResult = checkDistanceMasterTicket(blindUser, users);
                    if (blindTicketResult.message) {
                        streakMessages.push('ç›²äººï¼š' + blindTicketResult.message);
                    }
                }

                // æ£€æŸ¥èµ›äº‹è¿›åº¦
                if (volunteer) {
                    checkEventProgress(volunteer.id, exerciseRecord);
                }
                if (blindUser) {
                    checkEventProgress(blindUser.id, exerciseRecord);
                }

                localStorage.setItem('users', JSON.stringify(users));

                // å¦‚æœå½“å‰ç”¨æˆ·æ˜¯å¿—æ„¿è€…æˆ–ç›²äººï¼Œæ›´æ–°currentUser
                const currentUserStr = localStorage.getItem('currentUser');
                if (currentUserStr) {
                    const currentUser = JSON.parse(currentUserStr);
                    const updatedUser = users.find(u => u.id === currentUser.id);
                    if (updatedUser) {
                        localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                    }
                }

                alert('å®¡æ ¸é€šè¿‡ï¼\nå¿—æ„¿è€…è·å¾— ' + pointsReward.volunteer + ' ç§¯åˆ†ï¼Œç´¯è®¡åŠ©è·‘ ' + exerciseRecord.distance.toFixed(2) + ' å…¬é‡Œ\nç›²äººè·å¾— ' + pointsReward.blind + ' ç§¯åˆ†ï¼Œç´¯è®¡è¢«åŠ©è·‘ ' + exerciseRecord.distance.toFixed(2) + ' å…¬é‡Œ\n' +
                      (streakMessages.length > 0 ? '\n' + streakMessages.join('\n') : ''));
            }
        }

        // åŠ è½½ç”¨æˆ·ä¸­å¿ƒ
        function loadUserProfile() {
            const currentUserStr = localStorage.getItem('currentUser');
            const container = document.getElementById('user-info-section');

            if (!currentUserStr) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ”</div>
                        <p style="color: #666; margin-bottom: 20px;">è¯·å…ˆç™»å½•ä»¥æŸ¥çœ‹ä¸ªäººä¿¡æ¯</p>
                        <button class="btn btn-primary" onclick="location.reload()">
                            å‰å¾€ç™»å½•
                        </button>
                    </div>
                `;
                return;
            }

            const userInfo = JSON.parse(currentUserStr);

            // å®˜æ–¹è´¦å·æ˜¾ç¤ºä¸åŒçš„ç»Ÿè®¡ä¿¡æ¯
            if (userInfo.type === 'official') {
                const officialStats = calculateOfficialStats();

                container.innerHTML = `
                    <div style="text-align: center; padding: 30px 0; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px;">
                        <div style="font-size: 64px; margin-bottom: 10px;">ğŸ”</div>
                        <h3 style="font-size: 24px; margin-bottom: 5px;">${userInfo.username}</h3>
                        <div style="color: #666;">å®˜æ–¹å®¡æ ¸å‘˜</div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <div style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 12px;">
                            <div style="font-size: 56px; font-weight: 600;">${officialStats.totalDistance}</div>
                            <div style="font-size: 18px; opacity: 0.9; margin-top: 10px;">ä»Šæ—¥åŠ©è·‘æ€»è·ç¦»(km)</div>
                        </div>
                    </div>

                    <button class="btn btn-secondary btn-block" onclick="logout()">
                        é€€å‡ºç™»å½•
                    </button>
                `;
                return;
            }

            const stats = calculateUserStats(userInfo);

            container.innerHTML = `
                <div style="text-align: center; padding: 30px 0; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px;">
                    <div style="font-size: 64px; margin-bottom: 10px;">
                        ${userInfo.type === 'official' ? 'ğŸ”' : (userInfo.type === 'volunteer' ? 'ğŸ’ª' : 'ğŸ‘ï¸')}
                    </div>
                    <h3 style="font-size: 24px; margin-bottom: 5px;">${userInfo.username}</h3>
                    <div style="color: #666;">
                        ${userInfo.type === 'official' ? 'å®˜æ–¹å®¡æ ¸å‘˜' : (userInfo.type === 'volunteer' ? 'å¿—æ„¿è€…' : 'è§†éšœäººå£«')}
                        ${userInfo.certified ? '<span class="tag tag-certified" style="margin-left: 10px;">å·²è®¤è¯</span>' : ''}
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px;">
                        <div style="font-size: 32px; font-weight: 600;">â­ ${userInfo.points || 0}</div>
                        <div style="font-size: 14px; opacity: 0.9;">ç§¯åˆ†</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f5f5f5; border-radius: 8px;">
                        <div style="font-size: 32px; font-weight: 600; color: #667eea;">${stats.totalRecords}</div>
                        <div style="color: #666; font-size: 14px;">æ´»åŠ¨æ¬¡æ•°</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f5f5f5; border-radius: 8px;">
                        <div style="font-size: 32px; font-weight: 600; color: #52c41a;">${stats.completedRecords}</div>
                        <div style="color: #666; font-size: 14px;">å·²å®Œæˆ</div>
                    </div>
                </div>

                <!-- è¿èƒœç³»ç»Ÿ -->
                <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%); border-radius: 12px; padding: 20px; margin-bottom: 15px; color: white;">
                    ${(() => {
                        const currentRank = getStreakRank(userInfo.currentStreak || 0);
                        const requiredMeters = (currentRank.requiredDistance * 1000).toFixed(0);
                        return `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <strong style="font-size: 18px;">ğŸ”¥ è¿èƒœç³»ç»Ÿ</strong>
                        <div style="text-align: right;">
                            <div style="font-size: 20px; font-weight: 600;">${currentRank.icon} ${currentRank.name}</div>
                            <div style="font-size: 12px; opacity: 0.9;">æ¯æ—¥${requiredMeters}ç±³${currentRank.dailyReward > 0 ? ` +${currentRank.dailyReward}ç§¯åˆ†` : ''}</div>
                        </div>
                    </div>
                        `;
                    })()}

                    <!-- æ´»åŠ¨è¿èƒœ -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 28px; font-weight: 600;">${userInfo.currentStreak || 0}</div>
                            <div style="font-size: 12px; opacity: 0.9;">å½“å‰è¿èƒœ</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 28px; font-weight: 600;">${userInfo.totalStreak || 0}</div>
                            <div style="font-size: 12px; opacity: 0.9;">æ€»è¿èƒœå¤©æ•°</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 28px; font-weight: 600;">ğŸ”¦ ${userInfo.streakTorches || 0}</div>
                            <div style="font-size: 12px; opacity: 0.9;">è¿èƒœç«ç‚¬</div>
                        </div>
                    </div>

                    <!-- æ®µä½è¿›åº¦ -->
                    <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; text-align: center;">æ®µä½è¿›åº¦</div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${Object.keys(STREAK_RANKS).map(rankKey => {
                                const rank = STREAK_RANKS[rankKey];
                                const currentStreak = userInfo.currentStreak || 0;
                                const isCurrentRank = currentStreak >= rank.minDays && currentStreak <= rank.maxDays;
                                const isPassed = currentStreak > rank.maxDays;
                                const opacity = isPassed ? '0.6' : (isCurrentRank ? '1' : '0.4');
                                const bgColor = isCurrentRank ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.1)';
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: ${bgColor}; border-radius: 6px; opacity: ${opacity};">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 18px;">${rank.icon}</span>
                                            <span style="font-size: 13px; font-weight: ${isCurrentRank ? '600' : '400'};">${rank.name}</span>
                                        </div>
                                        <div style="text-align: right; font-size: 11px;">
                                            <div>${rank.minDays}${rank.maxDays === Infinity ? '+' : '-' + rank.maxDays}å¤©</div>
                                            <div style="opacity: 0.8;">${(rank.requiredDistance * 1000).toFixed(0)}ç±³/å¤©${rank.dailyReward > 0 ? ' +' + rank.dailyReward + 'åˆ†' : ''}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- è¿èƒœå†°å†»ï¼ˆä»…å¿—æ„¿è€…ï¼‰ -->
                    ${userInfo.type === 'volunteer' ? `
                        <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            ${userInfo.streakFrozen ? `
                                <div style="text-align: center; margin-bottom: 12px;">
                                    <div style="font-size: 32px; margin-bottom: 8px;">â„ï¸</div>
                                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 5px;">è¿èƒœå·²å†°å†»</div>
                                    <div style="font-size: 12px; opacity: 0.9;">å†°å†»æœŸé—´è¿èƒœä¸ä¼šå¢åŠ æˆ–å‡å°‘</div>
                                </div>
                                <button class="btn btn-secondary btn-block" onclick="unfreezeStreak()" style="background: rgba(255,255,255,0.3); border: none; color: white;">
                                    ğŸ”¥ è§£å†»è¿èƒœ
                                </button>
                            ` : `
                                <div style="text-align: center; margin-bottom: 12px;">
                                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">è¿èƒœå†°å†»</div>
                                    <div style="font-size: 12px; opacity: 0.9; line-height: 1.5;">
                                        å¦‚æœ‰è€ƒè¯•ã€æ—…æ¸¸ç­‰ç‰¹æ®Šæƒ…å†µï¼Œ<br>å¯ç”³è¯·å†°å†»è¿èƒœä¿æŠ¤æ‚¨çš„è¿èƒœè®°å½•
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-block" onclick="showRequestFreezeModal()" style="background: rgba(255,255,255,0.3); border: none; color: white;">
                                    â„ï¸ ç”³è¯·å†°å†»è¿èƒœ
                                </button>
                            `}
                        </div>
                    ` : ''}

                    <!-- ç­¾åˆ°è¿èƒœ -->
                    <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <div style="font-size: 32px; font-weight: 600;">ğŸ”¥ ${userInfo.checkInStreak || 0}</div>
                            <div style="font-size: 13px; opacity: 0.9;">è¿ç»­ç­¾åˆ°å¤©æ•°</div>
                        </div>

                        <!-- ç­¾åˆ°æˆå°± -->
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">å·²è§£é”æˆå°±ï¼š</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; justify-content: center;">
                            ${(userInfo.achievements || []).length > 0 ?
                                userInfo.achievements.map(achievement => {
                                    const achievementIcons = {
                                        '3æ—¥å¯èˆª': 'ğŸš€',
                                        'ä¸€å‘¨æå‡': 'ğŸ“ˆ',
                                        '2å‘¨åšæŒ': 'ğŸ’ª',
                                        'æœˆä¹‹åšæŒ': 'ğŸŒŸ'
                                    };
                                    return `<span style="background: rgba(255,255,255,0.3); padding: 6px 10px; border-radius: 15px; font-size: 12px; font-weight: 500;">
                                        ${achievementIcons[achievement] || 'ğŸ†'} ${achievement}
                                    </span>`;
                                }).join('')
                                : '<span style="opacity: 0.8; font-size: 12px;">æš‚æ— æˆå°±</span>'
                            }
                        </div>
                    </div>

                    <!-- ç›²è·‘å¤§å¸ˆè¿›åº¦ -->
                    <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 15px;">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">ğŸ† ç›²è·‘å¤§å¸ˆè¿›åº¦</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.2); border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 600;">ğŸ« ${userInfo.streakMasterTickets || 0}/3</div>
                                <div style="font-size: 11px; opacity: 0.9; margin-top: 4px;">è¿èƒœåˆ¸</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.2); border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 600;">ğŸ« ${userInfo.distanceMasterTickets || 0}/3</div>
                                <div style="font-size: 11px; opacity: 0.9; margin-top: 4px;">è·ç¦»åˆ¸</div>
                            </div>
                        </div>
                        <div style="font-size: 11px; margin-top: 10px; opacity: 0.85; text-align: center;">
                            ğŸ’¡ é›†é½3å¼ è¿èƒœåˆ¸+3å¼ è·ç¦»åˆ¸=ç›²è·‘å¤§å¸ˆæˆå°±
                        </div>
                    </div>

                    <div style="font-size: 12px; margin-top: 12px; opacity: 0.9; text-align: center;">
                        ğŸ’¡ æç¤ºï¼šç«ç‚¬å¯åœ¨ç§¯åˆ†å•†åŸè´­ä¹°ï¼Œå½“è¿èƒœä¸­æ–­æ—¶è‡ªåŠ¨ä½¿ç”¨
                    </div>
                </div>

                <!-- æ—¥å¸¸ç­¾åˆ° -->
                <div style="background: #f6ffed; border: 2px solid #52c41a; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <strong style="font-size: 18px;">ğŸ“… æ—¥å¸¸è®­ç»ƒç­¾åˆ°</strong>
                            <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                ç¬¬1-3å¤©ï¼š15-25ç§¯åˆ† | ç¬¬4-6å¤©ï¼š25-35ç§¯åˆ† | ç¬¬7å¤©ï¼š50ç§¯åˆ†
                            </div>
                        </div>
                    </div>
                    <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                        æœ€åç­¾åˆ°ï¼š${userInfo.lastCheckIn ? new Date(userInfo.lastCheckIn).toLocaleDateString('zh-CN') : 'æœªç­¾åˆ°'}
                    </div>
                    <button class="btn btn-success btn-block" onclick="dailyCheckIn()">
                        ç«‹å³ç­¾åˆ°
                    </button>
                </div>

                <div style="margin-bottom: 15px;">
                    <strong>ğŸ“± è”ç³»æ–¹å¼ï¼š</strong>${userInfo.phone || 'æœªè®¾ç½®'}
                </div>

                <button class="btn btn-primary btn-block" onclick="showPointsManagement()" style="margin-bottom: 10px;">
                    ğŸ¯ ç§¯åˆ†ç®¡ç†
                </button>
                <button class="btn btn-primary btn-block" onclick="showLeaderboard()" style="margin-bottom: 10px;">
                    ğŸ† åŠ©è·‘æ’è¡Œæ¦œ
                </button>
                ${userInfo.type === 'official' ? `
                <button class="btn btn-primary btn-block" onclick="switchPage('review')" style="margin-bottom: 10px;">
                    ğŸ“‹ å®¡æ ¸ç®¡ç†
                </button>
                ` : ''}
                <button class="btn btn-primary btn-block" onclick="switchPage('shop')" style="margin-bottom: 10px;">
                    ğŸ›’ ç§¯åˆ†å•†åŸ
                </button>
                <button class="btn btn-secondary btn-block" onclick="logout()">
                    é€€å‡ºç™»å½•
                </button>
            `;
        }

        // è®¡ç®—ç”¨æˆ·ç»Ÿè®¡æ•°æ®
        function calculateUserStats(userInfo) {
            const history = StorageManager.getHistory();
            const userHistory = history.filter(h =>
                h.userName === userInfo.name || h.volunteerName === userInfo.name
            );
            return {
                totalRecords: userHistory.length,
                completedRecords: userHistory.filter(h => h.status === 'completed').length
            };
        }

        // è®¡ç®—å®˜æ–¹ç»Ÿè®¡æ•°æ®
        function calculateOfficialStats() {
            const exerciseRecords = StorageManager.getExerciseRecords();
            const today = new Date().toISOString().split('T')[0];

            // è®¡ç®—ä»Šæ—¥åŠ©è·‘æ€»è·ç¦»ï¼ˆå¿—æ„¿è€…è·ç¦» * 2ï¼‰
            let totalDistance = 0;
            exerciseRecords.forEach(record => {
                if (record.status === 'approved') {
                    const recordDate = new Date(record.createdAt).toISOString().split('T')[0];
                    if (recordDate === today) {
                        totalDistance += (parseFloat(record.distance) || 0) * 2;
                    }
                }
            });

            return {
                totalDistance: totalDistance.toFixed(2)
            };
        }

        // æ—¥å¸¸ç­¾åˆ°åŠŸèƒ½
        function dailyCheckIn() {
            const currentUserStr = localStorage.getItem('currentUser');
            if (!currentUserStr) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const userInfo = JSON.parse(currentUserStr);
            const today = new Date().toISOString().split('T')[0];

            // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»ç­¾åˆ°
            if (userInfo.lastCheckIn === today) {
                alert('ä»Šå¤©å·²ç»ç­¾åˆ°è¿‡äº†ï¼');
                return;
            }

            // åˆå§‹åŒ–æˆå°±å’Œç­¾åˆ°è¿èƒœå­—æ®µ
            if (!userInfo.achievements) userInfo.achievements = [];
            if (!userInfo.checkInStreak) userInfo.checkInStreak = 0;

            // è®¡ç®—è¿ç»­ç­¾åˆ°å¤©æ•°
            const lastCheckIn = userInfo.lastCheckIn ? new Date(userInfo.lastCheckIn) : null;
            const todayDate = new Date(today);

            if (lastCheckIn) {
                const daysDiff = Math.floor((todayDate - lastCheckIn) / (1000 * 60 * 60 * 24));
                if (daysDiff === 1) {
                    userInfo.checkInStreak += 1;
                } else if (daysDiff > 1) {
                    userInfo.checkInStreak = 1;
                }
            } else {
                userInfo.checkInStreak = 1;
            }

            // æ ¹æ®ç­¾åˆ°å‘¨æœŸè®¡ç®—ç§¯åˆ†ï¼ˆä»¥7å¤©ä¸ºå‘¨æœŸï¼‰
            const dayInCycle = ((userInfo.checkInStreak - 1) % 7) + 1;
            let pointsToAdd;

            if (dayInCycle >= 1 && dayInCycle <= 3) {
                // ç¬¬1-3å¤©ï¼š15-25ç§¯åˆ†ï¼ˆéšæœºï¼‰
                pointsToAdd = Math.floor(Math.random() * 11) + 15;
            } else if (dayInCycle >= 4 && dayInCycle <= 6) {
                // ç¬¬4-6å¤©ï¼š25-35ç§¯åˆ†ï¼ˆéšæœºï¼‰
                pointsToAdd = Math.floor(Math.random() * 11) + 25;
            } else {
                // ç¬¬7å¤©ï¼š50ç§¯åˆ†ï¼ˆå›ºå®šï¼‰
                pointsToAdd = 50;
            }

            userInfo.points = (userInfo.points || 0) + pointsToAdd;
            userInfo.lastCheckIn = today;

            // æ£€æŸ¥æˆå°±å’Œåˆ¸
            const achievementMessages = [];
            const streak = userInfo.checkInStreak;

            if (streak === 3 && !userInfo.achievements.includes('3æ—¥å¯èˆª')) {
                userInfo.achievements.push('3æ—¥å¯èˆª');
                achievementMessages.push('ğŸ‰ è§£é”æˆå°±ï¼š3æ—¥å¯èˆª');
            }
            if (streak === 7 && !userInfo.achievements.includes('ä¸€å‘¨æå‡')) {
                userInfo.achievements.push('ä¸€å‘¨æå‡');
                achievementMessages.push('ğŸ‰ è§£é”æˆå°±ï¼šä¸€å‘¨æå‡');
            }
            if (streak === 14 && !userInfo.achievements.includes('2å‘¨åšæŒ')) {
                userInfo.achievements.push('2å‘¨åšæŒ');
                achievementMessages.push('ğŸ‰ è§£é”æˆå°±ï¼š2å‘¨åšæŒ');
            }
            if (streak === 30 && !userInfo.achievements.includes('æœˆä¹‹åšæŒ')) {
                userInfo.achievements.push('æœˆä¹‹åšæŒ');
                achievementMessages.push('ğŸ‰ è§£é”æˆå°±ï¼šæœˆä¹‹åšæŒ');
            }

            // æ·»åŠ ç§¯åˆ†å†å²è®°å½•
            if (!userInfo.pointsHistory) {
                userInfo.pointsHistory = [];
            }
            const earnedAt = Date.now();
            const expiresAt = earnedAt + 365 * 24 * 60 * 60 * 1000; // 1å¹´åè¿‡æœŸ
            userInfo.pointsHistory.push({
                type: 'daily_training',
                points: pointsToAdd,
                description: `æ—¥å¸¸è®­ç»ƒç­¾åˆ°ï¼ˆç¬¬${userInfo.checkInStreak}å¤©ï¼‰`,
                date: new Date().toISOString(),
                status: 'approved',
                earnedAt: earnedAt,
                expiresAt: expiresAt
            });

            // è®¡ç®—æœ‰æ•ˆç§¯åˆ†æ€»å’Œï¼ˆæ’é™¤è¿‡æœŸç§¯åˆ†ï¼‰
            const now = Date.now();
            userInfo.points = userInfo.pointsHistory
                .filter(p => !p.expiresAt || p.expiresAt > now)
                .reduce((sum, p) => sum + p.points, 0);

            // æ›´æ–°localStorageä¸­çš„ç”¨æˆ·ä¿¡æ¯
            localStorage.setItem('currentUser', JSON.stringify(userInfo));

            // æ›´æ–°usersæ•°ç»„ä¸­çš„ç”¨æˆ·ä¿¡æ¯
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.name === userInfo.name);
            if (userIndex !== -1) {
                users[userIndex] = userInfo;
                localStorage.setItem('users', JSON.stringify(users));
            }

            let message = `ç­¾åˆ°æˆåŠŸï¼\nè·å¾— ${pointsToAdd} ç§¯åˆ†\nè¿ç»­ç­¾åˆ°ï¼š${userInfo.checkInStreak}å¤©`;
            if (achievementMessages.length > 0) {
                message += '\n\n' + achievementMessages.join('\n');
            }
            alert(message);
            loadUserProfile();
        }

        // æ˜¾ç¤ºç§¯åˆ†ç®¡ç†é¡µé¢
        function showPointsManagement() {
            const currentUserStr = localStorage.getItem('currentUser');
            if (!currentUserStr) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const userInfo = JSON.parse(currentUserStr);
            const pointsHistory = userInfo.pointsHistory || [];

            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2 style="margin: 0; color: #333;">ğŸ¯ ç§¯åˆ†ç®¡ç†</h2>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999;">Ã—</button>
                    </div>

                    <!-- ç§¯åˆ†æ¦‚è§ˆ -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 25px; margin-bottom: 25px; color: white; text-align: center;">
                        <div style="font-size: 16px; opacity: 0.9; margin-bottom: 10px;">æˆ‘çš„æ€»ç§¯åˆ†</div>
                        <div style="font-size: 48px; font-weight: 700;">${userInfo.points || 0}</div>
                        <div style="font-size: 14px; opacity: 0.8; margin-top: 10px;">
                            ${userInfo.type === 'blind' ? 'ç›²äººç”¨æˆ·ï¼ˆæ¯æ—¥20åˆ†ï¼‰' : 'å¿—æ„¿è€…ï¼ˆæ¯æ—¥15åˆ†ï¼‰'}
                        </div>
                    </div>

                    <!-- æ´»åŠ¨ç”³è¯·è¡¨å• -->
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; margin-bottom: 25px;">
                        <h3 style="color: #333; margin-bottom: 20px;">ğŸƒ æ´»åŠ¨ç§¯åˆ†ç”³è¯·</h3>
                        <form id="eventApplicationForm" onsubmit="handleEventApplication(event); return false;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-weight: 600; color: #333; margin-bottom: 8px;">æ´»åŠ¨ç±»å‹</label>
                                <select id="eventType" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                    <option value="">è¯·é€‰æ‹©æ´»åŠ¨ç±»å‹</option>
                                    <option value="marathon">ç›²äººé©¬æ‹‰æ¾ï¼ˆ500-1000åˆ†ï¼‰</option>
                                    <option value="online_event">çº¿ä¸Šèµ›äº‹ï¼ˆ150-300åˆ†ï¼‰</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-weight: 600; color: #333; margin-bottom: 8px;">æ´»åŠ¨åç§°</label>
                                <input type="text" id="eventName" required placeholder="ä¾‹å¦‚ï¼š2024æ˜¥å­£é©¬æ‹‰æ¾" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-weight: 600; color: #333; margin-bottom: 8px;">ç”³è¯·ç§¯åˆ†</label>
                                <input type="number" id="eventPoints" required min="150" max="1000" placeholder="æ ¹æ®æ´»åŠ¨ç±»å‹å¡«å†™" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                                <small style="color: #999; font-size: 12px; display: block; margin-top: 5px;">é©¬æ‹‰æ¾ï¼š500-1000åˆ† | çº¿ä¸Šèµ›äº‹ï¼š150-300åˆ†</small>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block" style="width: 100%; padding: 14px; font-size: 16px; font-weight: 600;">
                                æäº¤ç”³è¯·
                            </button>
                        </form>
                    </div>

                    <!-- ç§¯åˆ†å†å² -->
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px;">
                        <h3 style="color: #333; margin-bottom: 20px;">ğŸ“Š ç§¯åˆ†å†å²è®°å½•</h3>
                        <div id="pointsHistoryList" style="max-height: 400px; overflow-y: auto;">
                            ${pointsHistory.length === 0 ? `
                                <div style="text-align: center; color: #999; padding: 40px; font-style: italic;">
                                    æš‚æ— ç§¯åˆ†è®°å½•
                                </div>
                            ` : pointsHistory.slice().reverse().map(record => {
                                const date = new Date(record.date);
                                const dateStr = date.toLocaleDateString('zh-CN');
                                const timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

                                let typeText = '';
                                if (record.type === 'daily_training') typeText = 'æ—¥å¸¸è®­ç»ƒç­¾åˆ°';
                                else if (record.type === 'marathon') typeText = 'ç›²äººé©¬æ‹‰æ¾';
                                else if (record.type === 'online_event') typeText = 'çº¿ä¸Šèµ›äº‹';

                                let statusClass = '';
                                let statusText = '';
                                if (record.status === 'approved') {
                                    statusClass = 'background: #d4edda; color: #155724;';
                                    statusText = 'å·²é€šè¿‡';
                                } else if (record.status === 'pending') {
                                    statusClass = 'background: #fff3cd; color: #856404;';
                                    statusText = 'å¾…å®¡æ ¸';
                                } else if (record.status === 'rejected') {
                                    statusClass = 'background: #f8d7da; color: #721c24;';
                                    statusText = 'å·²æ‹’ç»';
                                }

                                return `
                                    <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px; border-left: 4px solid #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <span style="font-weight: 600; color: #333; font-size: 16px;">${typeText}</span>
                                            <span style="font-size: 18px; font-weight: 700; color: ${record.status === 'approved' ? '#28a745' : '#666'};">
                                                ${record.status === 'approved' ? '+' : ''}${record.points}åˆ†
                                            </span>
                                        </div>
                                        <div style="color: #555; margin-bottom: 10px; line-height: 1.5;">
                                            ${record.description}
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid #eee;">
                                            <span style="color: #999; font-size: 13px;">${dateStr} ${timeStr}</span>
                                            <span style="padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 600; ${statusClass}">
                                                ${statusText}
                                            </span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // å¤„ç†æ´»åŠ¨ç”³è¯·
        function handleEventApplication(event) {
            event.preventDefault();

            const currentUserStr = localStorage.getItem('currentUser');
            if (!currentUserStr) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const eventType = document.getElementById('eventType').value;
            const eventName = document.getElementById('eventName').value.trim();
            const eventPoints = parseInt(document.getElementById('eventPoints').value);

            // éªŒè¯æ´»åŠ¨ç±»å‹å’Œç§¯åˆ†èŒƒå›´
            if (eventType === 'marathon' && (eventPoints < 500 || eventPoints > 1000)) {
                alert('ç›²äººé©¬æ‹‰æ¾ç§¯åˆ†èŒƒå›´åº”ä¸º 500-1000 åˆ†');
                return;
            }
            if (eventType === 'online_event' && (eventPoints < 150 || eventPoints > 300)) {
                alert('çº¿ä¸Šèµ›äº‹ç§¯åˆ†èŒƒå›´åº”ä¸º 150-300 åˆ†');
                return;
            }

            const userInfo = JSON.parse(currentUserStr);

            // æ·»åŠ ç§¯åˆ†å†å²è®°å½•ï¼ˆå¾…å®¡æ ¸çŠ¶æ€ï¼‰
            if (!userInfo.pointsHistory) {
                userInfo.pointsHistory = [];
            }

            const typeText = eventType === 'marathon' ? 'ç›²äººé©¬æ‹‰æ¾' : 'çº¿ä¸Šèµ›äº‹';
            userInfo.pointsHistory.push({
                type: eventType,
                points: eventPoints,
                description: `${typeText} - ${eventName}`,
                date: new Date().toISOString(),
                status: 'pending'
            });

            // æ›´æ–°localStorage
            localStorage.setItem('currentUser', JSON.stringify(userInfo));

            // æ›´æ–°usersæ•°ç»„
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.name === userInfo.name);
            if (userIndex !== -1) {
                users[userIndex] = userInfo;
                localStorage.setItem('users', JSON.stringify(users));
            }

            alert('ç”³è¯·å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸');

            // å…³é—­å¹¶é‡æ–°æ‰“å¼€æ¨¡æ€æ¡†ä»¥åˆ·æ–°æ˜¾ç¤º
            document.querySelector('div[style*="position: fixed"]')?.remove();
            showPointsManagement();
        }

        // æ˜¾ç¤ºåŠ©è·‘æ’è¡Œæ¦œ
        function showLeaderboard() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');

            if (users.length === 0) {
                alert('æš‚æ— ç”¨æˆ·æ•°æ®');
                return;
            }

            // è®¡ç®—ç›²äººå’Œå¿—æ„¿è€…çš„ä¸åŒæ—¶é—´æ®µæ’è¡Œæ¦œ
            const blindDailyRanking = calculateRanking(users, 'daily', 'blind');
            const blindWeeklyRanking = calculateRanking(users, 'weekly', 'blind');
            const blindMonthlyRanking = calculateRanking(users, 'monthly', 'blind');

            const volunteerDailyRanking = calculateRanking(users, 'daily', 'volunteer');
            const volunteerWeeklyRanking = calculateRanking(users, 'weekly', 'volunteer');
            const volunteerMonthlyRanking = calculateRanking(users, 'monthly', 'volunteer');

            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;

            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2 style="margin: 0; color: #333;">ğŸ† åŠ©è·‘æ’è¡Œæ¦œ</h2>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999;">Ã—</button>
                    </div>

                    <!-- ç”¨æˆ·ç±»å‹åˆ‡æ¢æ ‡ç­¾ -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="user-type-tab active" data-type="blind" style="flex: 1; padding: 12px; border: 2px solid #667eea; background: #667eea; color: white; cursor: pointer; font-weight: 600; border-radius: 8px;">
                            ğŸ‘ï¸ ç›²äººæ¦œ
                        </button>
                        <button class="user-type-tab" data-type="volunteer" style="flex: 1; padding: 12px; border: 2px solid #667eea; background: white; color: #667eea; cursor: pointer; font-weight: 600; border-radius: 8px;">
                            ğŸ’ª å¿—æ„¿è€…æ¦œ
                        </button>
                    </div>

                    <!-- æ—¶é—´æ®µåˆ‡æ¢æ ‡ç­¾ -->
                    <div style="display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #f0f0f0;">
                        <button class="ranking-tab active" data-period="daily" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer; font-weight: 600; color: #667eea; border-bottom: 3px solid #667eea;">
                            ğŸ“… ä»Šæ—¥
                        </button>
                        <button class="ranking-tab" data-period="weekly" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer; font-weight: 600; color: #999; border-bottom: 3px solid transparent;">
                            ğŸ“Š æœ¬å‘¨
                        </button>
                        <button class="ranking-tab" data-period="monthly" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer; font-weight: 600; color: #999; border-bottom: 3px solid transparent;">
                            ğŸ“ˆ æœ¬æœˆ
                        </button>
                    </div>

                    <!-- ç›²äººæ’è¡Œæ¦œ -->
                    <div id="blindRankings" class="user-type-content" style="display: block;">
                        <div id="blindDailyRanking" class="ranking-content" style="display: block;">
                            ${generateRankingHTML(blindDailyRanking, 'ä»Šæ—¥')}
                        </div>
                        <div id="blindWeeklyRanking" class="ranking-content" style="display: none;">
                            ${generateRankingHTML(blindWeeklyRanking, 'æœ¬å‘¨')}
                        </div>
                        <div id="blindMonthlyRanking" class="ranking-content" style="display: none;">
                            ${generateRankingHTML(blindMonthlyRanking, 'æœ¬æœˆ')}
                        </div>
                    </div>

                    <!-- å¿—æ„¿è€…æ’è¡Œæ¦œ -->
                    <div id="volunteerRankings" class="user-type-content" style="display: none;">
                        <div id="volunteerDailyRanking" class="ranking-content" style="display: block;">
                            ${generateRankingHTML(volunteerDailyRanking, 'ä»Šæ—¥')}
                        </div>
                        <div id="volunteerWeeklyRanking" class="ranking-content" style="display: none;">
                            ${generateRankingHTML(volunteerWeeklyRanking, 'æœ¬å‘¨')}
                        </div>
                        <div id="volunteerMonthlyRanking" class="ranking-content" style="display: none;">
                            ${generateRankingHTML(volunteerMonthlyRanking, 'æœ¬æœˆ')}
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // è®¾ç½®ç”¨æˆ·ç±»å‹æ ‡ç­¾åˆ‡æ¢äº‹ä»¶
            const userTypeTabs = modal.querySelectorAll('.user-type-tab');
            userTypeTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    userTypeTabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.background = 'white';
                        t.style.color = '#667eea';
                    });

                    // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
                    tab.classList.add('active');
                    tab.style.background = '#667eea';
                    tab.style.color = 'white';

                    // éšè—æ‰€æœ‰ç”¨æˆ·ç±»å‹å†…å®¹
                    modal.querySelectorAll('.user-type-content').forEach(content => {
                        content.style.display = 'none';
                    });

                    // æ˜¾ç¤ºå¯¹åº”çš„ç”¨æˆ·ç±»å‹æ’è¡Œæ¦œ
                    const userType = tab.dataset.type;
                    modal.querySelector(`#${userType}Rankings`).style.display = 'block';
                });
            });

            // è®¾ç½®æ—¶é—´æ®µæ ‡ç­¾åˆ‡æ¢äº‹ä»¶
            const tabs = modal.querySelectorAll('.ranking-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.color = '#999';
                        t.style.borderBottom = '3px solid transparent';
                    });

                    // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
                    tab.classList.add('active');
                    tab.style.color = '#667eea';
                    tab.style.borderBottom = '3px solid #667eea';

                    // è·å–å½“å‰é€‰ä¸­çš„ç”¨æˆ·ç±»å‹
                    const activeUserType = modal.querySelector('.user-type-tab.active').dataset.type;
                    const period = tab.dataset.period;

                    // éšè—å½“å‰ç”¨æˆ·ç±»å‹ä¸‹çš„æ‰€æœ‰æ—¶é—´æ®µå†…å®¹
                    modal.querySelectorAll(`#${activeUserType}Rankings .ranking-content`).forEach(content => {
                        content.style.display = 'none';
                    });

                    // æ˜¾ç¤ºå¯¹åº”çš„æ’è¡Œæ¦œ
                    const capitalizedPeriod = period.charAt(0).toUpperCase() + period.slice(1);
                    modal.querySelector(`#${activeUserType}${capitalizedPeriod}Ranking`).style.display = 'block';
                });
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // è®¡ç®—æ’è¡Œæ¦œï¼ˆæŒ‰åŠ©è·‘è·ç¦»ï¼‰
        function calculateRanking(users, period, userType) {
            const now = new Date();
            let startTime;

            // è®¡ç®—æ—¶é—´èŒƒå›´
            if (period === 'daily') {
                // ä»Šæ—¥ï¼šä»Šå¤©00:00å¼€å§‹
                startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
            } else if (period === 'weekly') {
                // æœ¬å‘¨ï¼šæœ¬å‘¨ä¸€00:00å¼€å§‹
                const dayOfWeek = now.getDay();
                const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // å‘¨æ—¥æ˜¯0ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
                startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate() - diff, 0, 0, 0);
            } else if (period === 'monthly') {
                // æœ¬æœˆï¼šæœ¬æœˆ1å·00:00å¼€å§‹
                startTime = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0);
            }

            // è·å–è¿åŠ¨è®°å½•
            const exerciseRecords = StorageManager.getExerciseRecords();

            // è®¡ç®—æ¯ä¸ªç”¨æˆ·åœ¨æ—¶é—´èŒƒå›´å†…çš„åŠ©è·‘è·ç¦»
            const rankings = users
                .filter(user => user.type === userType) // åªæ˜¾ç¤ºæŒ‡å®šç±»å‹çš„ç”¨æˆ·
                .map(user => {
                    let periodDistance = 0;

                    // éå†è¿åŠ¨è®°å½•ï¼Œç´¯åŠ ç¬¦åˆæ—¶é—´èŒƒå›´ä¸”å·²å®¡æ ¸é€šè¿‡çš„è·ç¦»
                    exerciseRecords.forEach(record => {
                        if (record.status !== 'approved') return;

                        const recordDate = new Date(record.createdAt);
                        if (recordDate >= startTime && recordDate <= now) {
                            // ç›²äººï¼šè®¡ç®—è¢«åŠ©è·‘çš„è·ç¦»
                            if (userType === 'blind' && record.blindUserId === user.id) {
                                periodDistance += parseFloat(record.distance) || 0;
                            }
                            // å¿—æ„¿è€…ï¼šè®¡ç®—åŠ©è·‘çš„è·ç¦»
                            else if (userType === 'volunteer' && record.volunteerId === user.id) {
                                periodDistance += parseFloat(record.distance) || 0;
                            }
                        }
                    });

                    return {
                        username: user.username || user.name,
                        type: user.type,
                        periodDistance: periodDistance,
                        totalPoints: user.points || 0
                    };
                });

            // æŒ‰æ—¶é—´æ®µè·ç¦»é™åºæ’åº
            rankings.sort((a, b) => b.periodDistance - a.periodDistance);

            return rankings;
        }

        // ç”Ÿæˆæ’è¡Œæ¦œHTML
        function generateRankingHTML(rankings, periodName) {
            if (rankings.length === 0 || rankings.every(r => r.periodDistance === 0)) {
                return `
                    <div style="text-align: center; color: #999; padding: 60px 20px; font-style: italic;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“Š</div>
                        <div>${periodName}æš‚æ— åŠ©è·‘è®°å½•</div>
                    </div>
                `;
            }

            // è¿‡æ»¤å‡ºæœ‰è·ç¦»çš„ç”¨æˆ·
            const activeRankings = rankings.filter(r => r.periodDistance > 0);

            if (activeRankings.length === 0) {
                return `
                    <div style="text-align: center; color: #999; padding: 60px 20px; font-style: italic;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“Š</div>
                        <div>${periodName}æš‚æ— åŠ©è·‘è®°å½•</div>
                    </div>
                `;
            }

            return activeRankings.map((user, index) => {
                const rank = index + 1;
                let rankIcon = '';
                let rankColor = '#666';
                let bgColor = 'white';

                // å‰ä¸‰åç‰¹æ®Šæ ·å¼
                if (rank === 1) {
                    rankIcon = 'ğŸ¥‡';
                    rankColor = '#FFD700';
                    bgColor = '#FFF9E6';
                } else if (rank === 2) {
                    rankIcon = 'ğŸ¥ˆ';
                    rankColor = '#C0C0C0';
                    bgColor = '#F5F5F5';
                } else if (rank === 3) {
                    rankIcon = 'ğŸ¥‰';
                    rankColor = '#CD7F32';
                    bgColor = '#FFF5EE';
                }

                const typeText = user.type === 'blind' ? 'ç›²äºº' : 'å¿—æ„¿è€…';
                const typeBadgeColor = user.type === 'blind' ? '#1976d2' : '#7b1fa2';
                const typeBadgeBg = user.type === 'blind' ? '#e3f2fd' : '#f3e5f5';

                return `
                    <div style="background: ${bgColor}; border-radius: 12px; padding: 20px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                                <div style="font-size: 32px; font-weight: 700; color: ${rankColor}; min-width: 50px; text-align: center;">
                                    ${rankIcon || rank}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-size: 18px; font-weight: 600; color: #333; margin-bottom: 5px;">
                                        ${user.username}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="padding: 3px 10px; border-radius: 10px; font-size: 12px; font-weight: 600; background: ${typeBadgeBg}; color: ${typeBadgeColor};">
                                            ${typeText}
                                        </span>
                                        <span style="font-size: 13px; color: #999;">
                                            æ€»ç§¯åˆ†: ${user.totalPoints}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 28px; font-weight: 700; color: #667eea;">
                                    ${user.periodDistance.toFixed(2)}
                                </div>
                                <div style="font-size: 12px; color: #999;">
                                    ${periodName}åŠ©è·‘(km)
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åŠ è½½ç§¯åˆ†å•†åŸ
        function loadShop() {
            const currentUserStr = localStorage.getItem('currentUser');

            if (!currentUserStr) {
                document.getElementById('shop-items-list').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ”</div>
                        <div>è¯·å…ˆç™»å½•ä»¥è®¿é—®å•†åŸ</div>
                    </div>
                `;
                return;
            }

            const userInfo = JSON.parse(currentUserStr);
            document.getElementById('shop-user-points').textContent = userInfo.points || 0;

            const shopItems = StorageManager.getShopItems();
            const container = document.getElementById('shop-items-list');

            if (shopItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸª</div>
                        <div>å•†åŸæš‚æ— å•†å“</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = shopItems.map(item => `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 36px; margin-bottom: 10px;">${item.icon}</div>
                            <strong style="font-size: 18px;">${item.name}</strong>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 24px; font-weight: 600; color: #667eea;">
                                â­ ${item.price}
                            </div>
                            <div style="font-size: 12px; color: #999;">ç§¯åˆ†</div>
                        </div>
                    </div>

                    <div style="color: #666; margin-bottom: 15px; line-height: 1.6;">
                        ${item.description}
                    </div>

                    ${item.stock > 0 ? `
                        <div style="font-size: 14px; color: #999; margin-bottom: 10px;">
                            åº“å­˜ï¼š${item.stock} ä»¶
                        </div>
                    ` : ''}

                    <button class="btn ${(userInfo.points || 0) >= item.price && item.stock > 0 ? 'btn-primary' : 'btn-secondary'} btn-block"
                            onclick="purchaseItem('${item.id}')"
                            ${(userInfo.points || 0) < item.price || item.stock <= 0 ? 'disabled' : ''}>
                        ${(userInfo.points || 0) < item.price ? 'ç§¯åˆ†ä¸è¶³' : item.stock <= 0 ? 'å·²å”®ç½„' : 'ç«‹å³å…‘æ¢'}
                    </button>
                </div>
            `).join('');
        }

        // åŠ è½½å¿—æ„¿è€…è¯„åˆ†é¡µé¢
        function loadVolunteersRatings() {
            console.log('[DEBUG] åŠ è½½è¯„åˆ†æ’è¡Œæ¦œ');

            // è·å–å½“å‰ç”¨æˆ·
            const currentUserStr = localStorage.getItem('currentUser');
            if (!currentUserStr) {
                console.warn('[WARN] ç”¨æˆ·æœªç™»å½•');
                return;
            }

            const currentUser = JSON.parse(currentUserStr);
            console.log('[DEBUG] å½“å‰ç”¨æˆ·ç±»å‹:', currentUser.type);

            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const container = document.getElementById('volunteers-ratings-list');

            // æ ¹æ®å½“å‰ç”¨æˆ·ç±»å‹ç­›é€‰è¦æ˜¾ç¤ºçš„ç”¨æˆ·
            let targetUsers;
            let pageTitle;
            let emptyIcon;
            let emptyText;

            if (currentUser.type === 'blind') {
                // ç›²äººç”¨æˆ·åªçœ‹ç›²äººæ¦œ
                targetUsers = users.filter(u => u.type === 'blind');
                pageTitle = 'ğŸ‘¥ ç›²äººæ’è¡Œæ¦œ';
                emptyIcon = 'ğŸ‘¥';
                emptyText = 'æš‚æ— ç›²äººç”¨æˆ·';
                console.log('[DEBUG] æ˜¾ç¤ºç›²äººæ’è¡Œæ¦œ');
            } else if (currentUser.type === 'volunteer') {
                // å¿—æ„¿è€…åªçœ‹å¿—æ„¿è€…æ¦œ
                targetUsers = users.filter(u => u.type === 'volunteer');
                pageTitle = 'ğŸ’ª å¿—æ„¿è€…æ’è¡Œæ¦œ';
                emptyIcon = 'ğŸ’ª';
                emptyText = 'æš‚æ— å¿—æ„¿è€…';
                console.log('[DEBUG] æ˜¾ç¤ºå¿—æ„¿è€…æ’è¡Œæ¦œ');
            } else {
                // å®˜æ–¹è´¦å·å¯ä»¥çœ‹æ‰€æœ‰äººï¼ˆæˆ–è€…ä¹Ÿå¯ä»¥åˆ†å¼€æ˜¾ç¤ºï¼‰
                targetUsers = users.filter(u => u.type === 'volunteer' || u.type === 'blind');
                pageTitle = 'â­ ç”¨æˆ·æ’è¡Œæ¦œ';
                emptyIcon = 'â­';
                emptyText = 'æš‚æ— ç”¨æˆ·';
                console.log('[DEBUG] æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·æ’è¡Œæ¦œ');
            }

            // æ›´æ–°é¡µé¢æ ‡é¢˜
            const pageTitleElement = document.querySelector('#page-ratings h2');
            if (pageTitleElement) {
                pageTitleElement.textContent = pageTitle;
            }

            if (targetUsers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">${emptyIcon}</div>
                        <div>${emptyText}</div>
                    </div>
                `;
                return;
            }

            // è®¡ç®—æ¯ä¸ªç”¨æˆ·çš„ç»Ÿè®¡æ•°æ®
            const history = StorageManager.getHistory();
            const usersWithStats = targetUsers.map(user => {
                let userRecords;
                if (user.type === 'volunteer') {
                    // å¿—æ„¿è€…ï¼šæŸ¥æ‰¾ä½œä¸ºå¿—æ„¿è€…çš„è®°å½•
                    userRecords = history.filter(h =>
                        h.volunteerName === user.username &&
                        h.feedback &&
                        h.feedback.rating
                    );
                } else {
                    // ç›²äººï¼šæŸ¥æ‰¾ä½œä¸ºç›²äººçš„è®°å½•
                    userRecords = history.filter(h =>
                        h.userName === user.username &&
                        h.feedback &&
                        h.feedback.rating
                    );
                }

                const totalRating = userRecords.reduce((sum, r) => sum + r.feedback.rating, 0);
                const avgRating = userRecords.length > 0 ? (totalRating / userRecords.length).toFixed(1) : 0;
                const reviewCount = userRecords.length;

                return {
                    ...user,
                    avgRating: parseFloat(avgRating),
                    reviewCount: reviewCount,
                    records: userRecords
                };
            });

            // æŒ‰è¯„åˆ†æ’åº
            usersWithStats.sort((a, b) => {
                if (b.avgRating !== a.avgRating) return b.avgRating - a.avgRating;
                return b.reviewCount - a.reviewCount;
            });

            // æ‰¾åˆ°å½“å‰ç”¨æˆ·çš„æ’å
            const currentUserRank = usersWithStats.findIndex(u => u.id === currentUser.id) + 1;
            console.log('[DEBUG] å½“å‰ç”¨æˆ·æ’å:', currentUserRank);

            container.innerHTML = usersWithStats.map((user, index) => {
                const rank = index + 1;
                const isCurrentUser = user.id === currentUser.id;
                const rankEmoji = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : `${rank}.`;
                const userIcon = user.type === 'volunteer' ? 'ğŸ’ª' : 'ğŸ‘¥';

                return `
                    <div class="card" style="${isCurrentUser ? 'border: 2px solid #ffc107; background: #fff3cd;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="font-size: 24px; font-weight: 600; min-width: 40px;">${rankEmoji}</div>
                                <div>
                                    <div style="font-size: 36px; margin-bottom: 5px;">${userIcon}</div>
                                    <strong style="font-size: 20px;">${user.username}${isCurrentUser ? ' (æˆ‘)' : ''}</strong>
                                    ${user.certified ? '<span class="tag tag-certified" style="margin-left: 10px;">å·²è®¤è¯</span>' : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 32px; font-weight: 600; color: #667eea;">
                                    ${user.avgRating > 0 ? user.avgRating : '-'}
                                </div>
                                <div style="font-size: 14px; color: #999;">
                                    ${user.avgRating > 0 ? 'â­'.repeat(Math.round(user.avgRating)) : 'æš‚æ— è¯„åˆ†'}
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="text-align: center; padding: 15px; background: ${isCurrentUser ? '#fff' : '#f5f5f5'}; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 600; color: #667eea;">${user.reviewCount}</div>
                                <div style="font-size: 14px; color: #666;">è¯„ä»·æ•°</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: ${isCurrentUser ? '#fff' : '#f5f5f5'}; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 600; color: #52c41a;">${user.points || 0}</div>
                                <div style="font-size: 14px; color: #666;">ç§¯åˆ†</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: ${isCurrentUser ? '#fff' : '#f5f5f5'}; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 600; color: #ff6b6b;">${(user.totalDistance || 0).toFixed(1)}</div>
                                <div style="font-size: 14px; color: #666;">æ€»è·ç¦»(km)</div>
                            </div>
                        </div>

                        ${user.reviewCount > 0 ? `
                            <button class="btn btn-primary btn-block" onclick="showVolunteerDetails('${user.id}')">
                                æŸ¥çœ‹è¯¦æƒ…
                            </button>
                        ` : `
                            <div style="text-align: center; color: #999; padding: 10px;">
                                è¯¥ç”¨æˆ·æš‚æ— è¯„ä»·
                            </div>
                        `}
                    </div>
                `;
            }).join('');

            console.log('[DEBUG] æ’è¡Œæ¦œåŠ è½½å®Œæˆ');
        }

        // åŠ è½½è¿åŠ¨è®°å½•å®¡æ ¸é¡µé¢ - ä»æœåŠ¡å™¨è·å–æ‰€æœ‰è®°å½•
        async function loadExerciseRecords() {
            const container = document.getElementById('exercise-records-list');
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch('/api/exercise-records');
                const result = await response.json();

                if (!result.success) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">âŒ</div>
                            <div>åŠ è½½å¤±è´¥: ${result.message}</div>
                        </div>
                    `;
                    return;
                }

                const records = result.data || [];
                renderExerciseRecords(records, container);
            } catch (error) {
                console.error('è·å–è¿åŠ¨è®°å½•å¤±è´¥:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">âŒ</div>
                        <div>ç½‘ç»œé”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•</div>
                    </div>
                `;
            }
        }

        // è®¡ç®—ç§¯åˆ†ï¼ˆä¸æœåŠ¡å™¨ä¿æŒä¸€è‡´ï¼‰
        function calculatePreviewPoints(distance) {
            let volunteerPoints = 0;
            let blindPoints = 0;

            if (distance <= 1) {
                volunteerPoints = 25;
                blindPoints = 15;
            } else if (distance <= 5) {
                const extraDistance = distance - 1;
                const extraPoints = extraDistance * 15;
                volunteerPoints = 25 + extraPoints;
                blindPoints = 15 + extraPoints;
            } else {
                const longRunPoints = 4 * 15;
                const ultraDistance = distance - 5;
                const ultraPoints = ultraDistance * 20;
                volunteerPoints = 25 + longRunPoints + ultraPoints;
                blindPoints = 15 + longRunPoints + ultraPoints;
            }

            const maxPoints = 70;
            return {
                volunteer: Math.min(Math.round(volunteerPoints), maxPoints),
                blind: Math.min(Math.round(blindPoints), maxPoints)
            };
        }

        // æ¸²æŸ“è¿åŠ¨è®°å½•åˆ—è¡¨
        function renderExerciseRecords(records, container) {
            if (records.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“‹</div>
                        <div>æš‚æ— è¿åŠ¨è®°å½•</div>
                    </div>
                `;
                return;
            }

            // æŒ‰çŠ¶æ€åˆ†ç»„
            const pendingRecords = records.filter(r => r.status === 'pending');
            const approvedRecords = records.filter(r => r.status === 'approved');
            const rejectedRecords = records.filter(r => r.status === 'rejected');

            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <div style="flex: 1; text-align: center; padding: 15px; background: #fff3cd; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: #856404;">${pendingRecords.length}</div>
                            <div style="font-size: 14px; color: #856404;">å¾…å®¡æ ¸</div>
                        </div>
                        <div style="flex: 1; text-align: center; padding: 15px; background: #d4edda; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: #155724;">${approvedRecords.length}</div>
                            <div style="font-size: 14px; color: #155724;">å·²é€šè¿‡</div>
                        </div>
                        <div style="flex: 1; text-align: center; padding: 15px; background: #f8d7da; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: #721c24;">${rejectedRecords.length}</div>
                            <div style="font-size: 14px; color: #721c24;">å·²æ‹’ç»</div>
                        </div>
                    </div>
                    ${pendingRecords.length > 0 ? `
                        <button class="btn btn-primary" style="width: 100%;" onclick="awardAllPendingPoints()">
                            ğŸ’° æ‰¹é‡å®¡æ ¸å¹¶å‘æ”¾ç§¯åˆ†
                        </button>
                    ` : ''}
                </div>

                ${pendingRecords.length > 0 ? `
                    <h3 style="margin-bottom: 15px;">â³ å¾…å®¡æ ¸è®°å½•</h3>
                    ${pendingRecords.map(record => {
                        const minutes = Math.floor(record.pace);
                        const seconds = Math.round((record.pace - minutes) * 60);
                        const points = calculatePreviewPoints(record.distance);
                        return `
                            <div class="card" style="border-left: 4px solid #ffc107;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                    <div>
                                        <strong style="font-size: 18px;">${record.submittedBy}</strong>
                                        <div style="color: #999; font-size: 14px; margin-top: 5px;">
                                            ${new Date(record.submittedAt).toLocaleString('zh-CN')}
                                        </div>
                                    </div>
                                    <span class="tag" style="background: #fff3cd; color: #856404;">å¾…å®¡æ ¸</span>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                    <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                                        <div style="font-size: 24px; font-weight: 600; color: #667eea;">${record.duration}</div>
                                        <div style="font-size: 12px; color: #666;">æ—¶é•¿(åˆ†é’Ÿ)</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                                        <div style="font-size: 24px; font-weight: 600; color: #52c41a;">${record.distance}</div>
                                        <div style="font-size: 12px; color: #666;">è·ç¦»(å…¬é‡Œ)</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                                        <div style="font-size: 18px; font-weight: 600; color: #fa8c16;">${minutes}åˆ†${seconds.toString().padStart(2, '0')}ç§’/å…¬é‡Œ</div>
                                        <div style="font-size: 12px; color: #666;">${minutes}'${seconds.toString().padStart(2, '0')}''/km</div>
                                    </div>
                                </div>

                                <div style="padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; margin-bottom: 15px; color: white;">
                                    <div style="font-size: 14px; margin-bottom: 8px;">ğŸ¯ å®¡æ ¸é€šè¿‡åå°†å‘æ”¾ï¼š</div>
                                    <div style="display: flex; gap: 20px;">
                                        <div>å¿—æ„¿è€…: <strong>+${points.volunteer} ç§¯åˆ†</strong></div>
                                        <div>ç›²äººç”¨æˆ·: <strong>+${points.blind} ç§¯åˆ†</strong></div>
                                    </div>
                                </div>

                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-success" style="flex: 1;" onclick="approveRecord('${record.id}')">
                                        âœ“ é€šè¿‡
                                    </button>
                                    <button class="btn btn-secondary" style="flex: 1;" onclick="rejectRecord('${record.id}')">
                                        âœ— æ‹’ç»
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                ` : ''}

                ${approvedRecords.length > 0 ? `
                    <h3 style="margin: 20px 0 15px 0;">âœ“ å·²é€šè¿‡è®°å½•</h3>
                    ${approvedRecords.slice(0, 5).map(record => {
                        const minutes = Math.floor(record.pace);
                        const seconds = Math.round((record.pace - minutes) * 60);
                        return `
                            <div class="card" style="border-left: 4px solid #28a745; opacity: 0.8;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${record.submittedBy}</strong>
                                        <span style="color: #999; margin-left: 10px;">${record.duration}åˆ†é’Ÿ | ${record.distance}å…¬é‡Œ | ${minutes}:${seconds.toString().padStart(2, '0')}/å…¬é‡Œ</span>
                                    </div>
                                    <span class="tag" style="background: #d4edda; color: #155724;">å·²é€šè¿‡</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                ` : ''}
            `;
        }

        // å®¡æ ¸é€šè¿‡ - è°ƒç”¨æœåŠ¡å™¨API
        function approveRecord(recordId) {
            if (confirm('ç¡®å®šé€šè¿‡æ­¤è¿åŠ¨è®°å½•å—ï¼Ÿ\né€šè¿‡åå°†å¥–åŠ±ç”¨æˆ·ç§¯åˆ†å’Œè¿èƒœã€‚')) {
                fetch('/api/exercise-records/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: recordId,
                        status: 'approved',
                        approvedAt: Date.now()
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        // æ˜¾ç¤ºç§¯åˆ†å‘æ”¾è¯¦æƒ…
                        if (result.pointsAwarded) {
                            const { volunteer, volunteerPoints, blindUser, blindPoints } = result.pointsAwarded;
                            alert(`å·²é€šè¿‡è¯¥è¿åŠ¨è®°å½•ï¼\n\nç§¯åˆ†å‘æ”¾ï¼š\nå¿—æ„¿è€… ${volunteer}ï¼š+${volunteerPoints} ç§¯åˆ†\nç›²äººç”¨æˆ· ${blindUser}ï¼š+${blindPoints} ç§¯åˆ†`);
                        } else {
                            alert('å·²é€šè¿‡è¯¥è¿åŠ¨è®°å½•');
                        }
                        loadExerciseRecords();
                    } else {
                        alert('æ“ä½œå¤±è´¥: ' + result.message);
                    }
                })
                .catch(error => {
                    console.error('æ“ä½œå¤±è´¥:', error);
                    alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
                });
            }
        }

        // å®¡æ ¸æ‹’ç» - è°ƒç”¨æœåŠ¡å™¨API
        function rejectRecord(recordId) {
            if (confirm('ç¡®å®šæ‹’ç»æ­¤è¿åŠ¨è®°å½•å—ï¼Ÿ\næ‹’ç»åç”¨æˆ·å°†ä¸ä¼šè·å¾—ç§¯åˆ†å’Œè¿èƒœå¥–åŠ±ã€‚')) {
                fetch('/api/exercise-records/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: recordId,
                        status: 'rejected',
                        rejectedAt: Date.now()
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('å·²æ‹’ç»è¯¥è¿åŠ¨è®°å½•');
                        loadExerciseRecords();
                    } else {
                        alert('æ“ä½œå¤±è´¥: ' + result.message);
                    }
                })
                .catch(error => {
                    console.error('æ“ä½œå¤±è´¥:', error);
                    alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
                });
            }
        }

        // æ‰¹é‡å®¡æ ¸å¹¶å‘æ”¾ç§¯åˆ†
        function awardAllPendingPoints() {
            if (!confirm('ç¡®å®šè¦å®¡æ ¸é€šè¿‡æ‰€æœ‰å¾…å®¡æ ¸è®°å½•å¹¶å‘æ”¾ç§¯åˆ†å—ï¼Ÿ')) {
                return;
            }

            fetch('/api/exercise-records/award-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    loadExerciseRecords();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + result.message);
                }
            })
            .catch(error => {
                console.error('æ‰¹é‡å®¡æ ¸å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            });
        }

        // æ˜¾ç¤ºå¿—æ„¿è€…è¯¦æƒ…
        function showVolunteerDetails(volunteerId) {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const volunteer = users.find(u => u.id === volunteerId);

            if (!volunteer) {
                alert('å¿—æ„¿è€…ä¸å­˜åœ¨');
                return;
            }

            const history = StorageManager.getHistory();
            const volunteerRecords = history.filter(h =>
                h.volunteerName === volunteer.username &&
                h.feedback &&
                h.feedback.rating
            );

            const totalRating = volunteerRecords.reduce((sum, r) => sum + r.feedback.rating, 0);
            const avgRating = volunteerRecords.length > 0 ? (totalRating / volunteerRecords.length).toFixed(1) : 0;

            const content = document.getElementById('volunteer-details-content');
            content.innerHTML = `
                <div style="text-align: center; padding: 20px 0; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ’ª</div>
                    <h3 style="font-size: 24px; margin-bottom: 5px;">${volunteer.username}</h3>
                    <div style="font-size: 32px; font-weight: 600; color: #667eea; margin-top: 10px;">
                        ${avgRating} â­
                    </div>
                    <div style="color: #666; margin-top: 5px;">
                        åŸºäº ${volunteerRecords.length} æ¡è¯„ä»·
                    </div>
                </div>

                <h4 style="margin-bottom: 15px; font-size: 18px;">ğŸ“ æ‰€æœ‰è¯„ä»·</h4>

                ${volunteerRecords.length > 0 ? volunteerRecords.map(record => `
                    <div style="padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong>${record.userName}</strong>
                                ${record.feedback.hasRealFeedback ? '<span style="color: #52c41a; font-size: 12px; margin-left: 8px;">âœ“ çœŸå®è¯„ä»·</span>' : ''}
                            </div>
                            <div style="color: #667eea; font-weight: 600;">
                                ${'â­'.repeat(record.feedback.rating)}
                            </div>
                        </div>
                        ${record.feedback.comment ? `
                            <div style="color: #666; line-height: 1.6; margin-bottom: 8px;">
                                ${record.feedback.comment}
                            </div>
                        ` : ''}
                        ${record.feedback.image ? `
                            <div style="margin-top: 10px;">
                                <img src="${record.feedback.image}" style="max-width: 100%; max-height: 200px; border-radius: 8px; cursor: pointer;" onclick="window.open(this.src)">
                            </div>
                        ` : ''}
                        <div style="font-size: 12px; color: #999; margin-top: 8px;">
                            ${formatTime(record.feedback.createdAt)}
                        </div>
                    </div>
                `).join('') : '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— è¯„ä»·</div>'}
            `;

            document.getElementById('volunteer-details-modal').style.display = 'flex';
        }

        // å…³é—­å¿—æ„¿è€…è¯¦æƒ…
        function closeVolunteerDetails() {
            document.getElementById('volunteer-details-modal').style.display = 'none';
        }

        // æ˜¾ç¤ºåé¦ˆè¡¨å•
        function showFeedbackForm(recordId) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»è¯„ä»·è¿‡
            const history = StorageManager.getHistory();
            const record = history.find(r => r.id === recordId);
            if (record && record.feedback && record.feedback.rating) {
                alert('æ‚¨å·²ç»è¯„ä»·è¿‡è¿™æ¡è®°å½•äº†ï¼');
                return;
            }

            document.getElementById('feedback-record-id').value = recordId;
            document.getElementById('feedback-rating').value = '';
            document.getElementById('feedback-comment').value = '';
            document.getElementById('feedback-image').value = '';
            document.getElementById('feedback-image-preview').style.display = 'none';

            // é‡ç½®æ˜Ÿæ˜Ÿæ˜¾ç¤º
            document.querySelectorAll('.star-rating').forEach(star => {
                star.style.opacity = '0.3';
            });

            const modal = document.getElementById('feedback-modal');
            modal.style.display = 'flex';
        }

        // å…³é—­åé¦ˆè¡¨å•
        function closeFeedbackForm() {
            document.getElementById('feedback-modal').style.display = 'none';
        }

        // æ˜¾ç¤ºè¿åŠ¨è®°å½•æäº¤è¡¨å•
        function showExerciseRecordForm(recordId) {
            document.getElementById('exercise-record-id').value = recordId;
            document.getElementById('exercise-duration').value = '';
            document.getElementById('exercise-distance').value = '';
            document.getElementById('exercise-pace').textContent = '--:-- åˆ†é’Ÿ/å…¬é‡Œ';
            document.getElementById('volunteer-points').textContent = '--';
            document.getElementById('blind-points').textContent = '--';
            document.getElementById('points-breakdown').textContent = 'è¾“å…¥è·ç¦»åè‡ªåŠ¨è®¡ç®—';
            document.getElementById('exercise-record-modal').style.display = 'flex';
        }

        // å…³é—­è¿åŠ¨è®°å½•è¡¨å•
        function closeExerciseRecordForm() {
            document.getElementById('exercise-record-modal').style.display = 'none';
        }

        // è®¡ç®—ç§¯åˆ†ï¼ˆæ ¹æ®è·ç¦»ï¼‰
        function calculatePoints(distance) {
            let volunteerPoints = 0;
            let blindPoints = 0;
            let breakdown = '';

            if (distance <= 1) {
                // 1kmä»¥ä¸‹ï¼šåŸºç¡€ç§¯åˆ†
                volunteerPoints = 25;
                blindPoints = 15;
                breakdown = `1kmä»¥ä¸‹ï¼šå¿—æ„¿è€…25ç§¯åˆ†ï¼Œç›²äºº15ç§¯åˆ†`;
            } else if (distance <= 5) {
                // 1km-5kmï¼ˆé•¿è·‘ï¼‰ï¼šåŸºç¡€ç§¯åˆ† + è¶…å‡ºéƒ¨åˆ†15ç§¯åˆ†/km
                const extraDistance = distance - 1;
                const extraPoints = extraDistance * 15;
                volunteerPoints = 25 + extraPoints;
                blindPoints = 15 + extraPoints;
                breakdown = `åŸºç¡€(1km)ï¼šå¿—æ„¿è€…25+ç›²äºº15\né•¿è·‘åŠ æˆ(${extraDistance.toFixed(2)}kmÃ—15)ï¼š+${extraPoints.toFixed(0)}ç§¯åˆ†`;
            } else {
                // 5kmä»¥ä¸Šï¼ˆè¶…é•¿è·‘ï¼‰ï¼šåŸºç¡€ç§¯åˆ† + 1-5kméƒ¨åˆ†(4kmÃ—15) + è¶…å‡º5kméƒ¨åˆ†20ç§¯åˆ†/km
                const longRunPoints = 4 * 15; // 1-5kmçš„éƒ¨åˆ†
                const ultraDistance = distance - 5;
                const ultraPoints = ultraDistance * 20;
                volunteerPoints = 25 + longRunPoints + ultraPoints;
                blindPoints = 15 + longRunPoints + ultraPoints;
                breakdown = `åŸºç¡€(1km)ï¼šå¿—æ„¿è€…25+ç›²äºº15\né•¿è·‘(1-5kmï¼Œ4kmÃ—15)ï¼š+60ç§¯åˆ†\nè¶…é•¿è·‘(${ultraDistance.toFixed(2)}kmÃ—20)ï¼š+${ultraPoints.toFixed(0)}ç§¯åˆ†`;
            }

            // è®¾ç½®ç§¯åˆ†ä¸Šé™ä¸º70
            const maxPoints = 70;
            const volunteerCapped = Math.min(Math.round(volunteerPoints), maxPoints);
            const blindCapped = Math.min(Math.round(blindPoints), maxPoints);

            // å¦‚æœè¾¾åˆ°ä¸Šé™ï¼Œæ·»åŠ æç¤º
            if (volunteerPoints > maxPoints || blindPoints > maxPoints) {
                breakdown += `\nâš ï¸ å·²è¾¾åˆ°å•æ¬¡ç§¯åˆ†ä¸Šé™70åˆ†`;
            }

            return {
                volunteer: volunteerCapped,
                blind: blindCapped,
                breakdown: breakdown
            };
        }

        // è®¡ç®—é…é€Ÿï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
        function calculatePace() {
            const duration = parseFloat(document.getElementById('exercise-duration').value);
            const distance = parseFloat(document.getElementById('exercise-distance').value);

            if (duration > 0 && distance > 0) {
                const paceMinutes = duration / distance;
                const minutes = Math.floor(paceMinutes);
                const seconds = Math.round((paceMinutes - minutes) * 60);
                document.getElementById('exercise-pace').textContent =
                    `${minutes}åˆ†${seconds.toString().padStart(2, '0')}ç§’/å…¬é‡Œ (${minutes}'${seconds.toString().padStart(2, '0')}''/km)`;
            } else {
                document.getElementById('exercise-pace').textContent = '--åˆ†--ç§’/å…¬é‡Œ';
            }

            // è®¡ç®—å¹¶æ˜¾ç¤ºç§¯åˆ†é¢„è§ˆ
            if (distance > 0) {
                const points = calculatePoints(distance);
                document.getElementById('volunteer-points').textContent = points.volunteer;
                document.getElementById('blind-points').textContent = points.blind;
                document.getElementById('points-breakdown').innerHTML = points.breakdown.replace(/\n/g, '<br>');
            } else {
                document.getElementById('volunteer-points').textContent = '--';
                document.getElementById('blind-points').textContent = '--';
                document.getElementById('points-breakdown').textContent = 'è¾“å…¥è·ç¦»åè‡ªåŠ¨è®¡ç®—';
            }
        }

        // é¢„è§ˆè¿åŠ¨æˆªå›¾
        function previewScreenshot(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('screenshot-preview').style.display = 'block';
                    document.getElementById('screenshot-preview-img').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // é¢„è§ˆè¯„ä»·å›¾ç‰‡
        function previewExerciseFeedbackImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('exercise-feedback-image-preview').style.display = 'block';
                    document.getElementById('exercise-feedback-image-img').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // é€‰æ‹©è¯„åˆ†ï¼ˆè¿åŠ¨è®°å½•è¡¨å•ï¼‰
        function selectExerciseRating(rating) {
            document.getElementById('exercise-feedback-rating').value = rating;
            document.querySelectorAll('.exercise-star-rating').forEach(star => {
                const starRating = parseInt(star.getAttribute('data-rating'));
                star.style.opacity = starRating <= rating ? '1' : '0.3';
            });
        }

        // æäº¤è¿åŠ¨è®°å½•
        function submitExerciseRecord(event) {
            event.preventDefault();

            const recordId = document.getElementById('exercise-record-id').value;
            const duration = parseFloat(document.getElementById('exercise-duration').value);
            const distance = parseFloat(document.getElementById('exercise-distance').value);
            const screenshotFile = document.getElementById('exercise-screenshot').files[0];
            const feedbackRating = parseInt(document.getElementById('exercise-feedback-rating').value);
            const feedbackComment = document.getElementById('exercise-feedback-comment').value.trim();
            const feedbackImageFile = document.getElementById('exercise-feedback-image').files[0];

            if (!duration || !distance) {
                alert('è¯·å¡«å†™å®Œæ•´çš„è¿åŠ¨æ•°æ®');
                return;
            }

            if (!screenshotFile) {
                alert('è¯·ä¸Šä¼ è¿åŠ¨æˆªå›¾');
                return;
            }

            if (!feedbackRating) {
                alert('è¯·é€‰æ‹©è¯„åˆ†');
                return;
            }

            if (!feedbackComment || feedbackComment.length < 5) {
                alert('è¯·å¡«å†™è‡³å°‘5ä¸ªå­—çš„çœŸå®æ„Ÿå—');
                return;
            }

            // å…ˆå¤„ç†è¿åŠ¨æˆªå›¾
            const screenshotReader = new FileReader();
            screenshotReader.onload = function(screenshotResult) {
                // è®¡ç®—é…é€Ÿ
                const pace = duration / distance;

                // å‡†å¤‡è¯„ä»·æ•°æ®
                const feedbackData = {
                    rating: feedbackRating,
                    comment: feedbackComment,
                    createdAt: Date.now(),
                    hasRealFeedback: true
                };

                // å¦‚æœæœ‰è¯„ä»·å›¾ç‰‡ï¼Œå¤„ç†å®ƒ
                if (feedbackImageFile) {
                    const imageReader = new FileReader();
                    imageReader.onload = function(imageResult) {
                        feedbackData.image = imageResult.target.result;
                        saveAllData(screenshotResult.target.result, pace, recordId, duration, distance, feedbackData);
                    };
                    imageReader.readAsDataURL(feedbackImageFile);
                } else {
                    saveAllData(screenshotResult.target.result, pace, recordId, duration, distance, feedbackData);
                }
            };
            screenshotReader.readAsDataURL(screenshotFile);

            function saveAllData(screenshotData, pace, recordId, duration, distance, feedbackData) {
                // ä¿å­˜è¿åŠ¨è®°å½•åˆ°å®¡æ ¸åˆ—è¡¨
                const exerciseRecord = {
                    id: StorageManager.generateId(),
                    recordId: recordId,
                    duration: duration,
                    distance: distance,
                    pace: pace,
                    screenshot: screenshotData,
                    submittedAt: Date.now(),
                    status: 'pending',
                    submittedBy: JSON.parse(localStorage.getItem('currentUser')).username,
                    feedback: feedbackData
                };

                // å…ˆä¿å­˜åˆ°æœåŠ¡å™¨
                fetch('/api/exercise-records', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(exerciseRecord)
                })
                .then(response => response.json())
                .then(result => {
                    if (!result.success) {
                        console.warn('ä¿å­˜åˆ°æœåŠ¡å™¨å¤±è´¥ï¼Œä¿ç•™æœ¬åœ°å‰¯æœ¬');
                    }
                })
                .catch(error => {
                    console.warn('ç½‘ç»œé”™è¯¯ï¼Œä¿ç•™æœ¬åœ°å‰¯æœ¬:', error);
                })
                .finally(() => {
                    // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä½œä¸ºå¤‡ç”¨
                    StorageManager.addExerciseRecord(exerciseRecord);

                    // æ›´æ–°å†å²è®°å½•ä¸­çš„è¯„ä»·
                    const history = StorageManager.getHistory();
                    const historyIndex = history.findIndex(h => h.id === recordId);
                    if (historyIndex !== -1) {
                        history[historyIndex].feedback = feedbackData;
                        localStorage.setItem('history', JSON.stringify(history));

                        // å¥–åŠ±ç›²äºº +5 ç§¯åˆ†
                        const currentUserStr = localStorage.getItem('currentUser');
                        if (currentUserStr) {
                            const userInfo = JSON.parse(currentUserStr);
                            if (userInfo.type === 'blind') {
                                userInfo.points = (userInfo.points || 0) + 5;
                                localStorage.setItem('currentUser', JSON.stringify(userInfo));

                                // æ›´æ–°æœ¬åœ°ç”¨æˆ·åˆ—è¡¨
                                const users = JSON.parse(localStorage.getItem('users') || '[]');
                                const userIdx = users.findIndex(u => u.name === userInfo.name);
                                if (userIdx !== -1) {
                                    users[userIdx].points = userInfo.points;
                                    localStorage.setItem('users', JSON.stringify(users));
                                }
                            }
                        }
                    }

                    alert('è¿åŠ¨è®°å½•å·²æäº¤ï¼\nçœŸå®æ„Ÿå— +5 ç§¯åˆ†å¥–åŠ±å·²åˆ°è´¦ï¼\nç­‰å¾…å®˜æ–¹å®¡æ ¸é€šè¿‡åï¼Œå°†è·å¾—ç§¯åˆ†å’Œè¿èƒœå¥–åŠ±ã€‚');
                    closeExerciseRecordForm();
                    loadHistory();
                });
            }
        }

        // é€‰æ‹©è¯„åˆ†
        function selectRating(rating) {
            document.getElementById('feedback-rating').value = rating;

            // æ›´æ–°æ˜Ÿæ˜Ÿæ˜¾ç¤º
            document.querySelectorAll('.star-rating').forEach(star => {
                const starRating = parseInt(star.getAttribute('data-rating'));
                star.style.opacity = starRating <= rating ? '1' : '0.3';
            });
        }

        // æäº¤åé¦ˆ
        function submitFeedback(event) {
            event.preventDefault();

            const recordId = document.getElementById('feedback-record-id').value;
            const rating = parseInt(document.getElementById('feedback-rating').value);
            const comment = document.getElementById('feedback-comment').value.trim();

            if (!rating) {
                alert('è¯·é€‰æ‹©è¯„åˆ†');
                return;
            }

            if (!comment || comment.length < 5) {
                alert('è¯·å¡«å†™è‡³å°‘5ä¸ªå­—çš„çœŸå®æ„Ÿå—ï¼Œå¯è·å¾—5ç§¯åˆ†å¥–åŠ±ï¼');
                return;
            }

            // è·å–å›¾ç‰‡
            const imageInput = document.getElementById('feedback-image');
            const imageData = imageInput.files[0];

            // æ›´æ–°å†å²è®°å½•
            const history = StorageManager.getHistory();
            const index = history.findIndex(r => r.id === recordId);

            if (index !== -1) {
                const feedbackData = {
                    rating: rating,
                    comment: comment,
                    createdAt: Date.now(),
                    hasRealFeedback: true
                };

                // å¦‚æœæœ‰å›¾ç‰‡ï¼Œè½¬æ¢ä¸ºbase64
                if (imageData) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        feedbackData.image = e.target.result;

                        // ä¿å­˜åé¦ˆ
                        history[index].feedback = feedbackData;
                        StorageManager.saveHistory(history);

                        // å¥–åŠ±ç§¯åˆ†
                        const currentUserStr = localStorage.getItem('currentUser');
                        if (currentUserStr) {
                            const userInfo = JSON.parse(currentUserStr);
                            userInfo.points = (userInfo.points || 0) + 5;
                            localStorage.setItem('currentUser', JSON.stringify(userInfo));

                            // æ›´æ–°æœ¬åœ°ç”¨æˆ·åˆ—è¡¨
                            const users = JSON.parse(localStorage.getItem('users') || '[]');
                            const userIdx = users.findIndex(u => u.name === userInfo.name);
                            if (userIdx !== -1) {
                                users[userIdx].points = userInfo.points;
                                localStorage.setItem('users', JSON.stringify(users));
                            }
                        }

                        alert('æ„Ÿè°¢æ‚¨çš„è¯„ä»·ï¼\nçœŸå®æ„Ÿå— +5 ç§¯åˆ†å¥–åŠ±å·²åˆ°è´¦ï¼');
                        closeFeedbackForm();
                        loadHistory();
                    };
                    reader.readAsDataURL(imageData);
                } else {
                    // æ²¡æœ‰å›¾ç‰‡ä¹Ÿå¥–åŠ±ç§¯åˆ†
                    history[index].feedback = feedbackData;
                    StorageManager.saveHistory(history);

                    // å¥–åŠ±ç§¯åˆ†
                    const currentUserStr = localStorage.getItem('currentUser');
                    if (currentUserStr) {
                        const userInfo = JSON.parse(currentUserStr);
                        userInfo.points = (userInfo.points || 0) + 5;
                        localStorage.setItem('currentUser', JSON.stringify(userInfo));

                        // æ›´æ–°æœ¬åœ°ç”¨æˆ·åˆ—è¡¨
                        const users = JSON.parse(localStorage.getItem('users') || '[]');
                        const userIdx = users.findIndex(u => u.name === userInfo.name);
                        if (userIdx !== -1) {
                            users[userIdx].points = userInfo.points;
                            localStorage.setItem('users', JSON.stringify(users));
                        }
                    }

                    alert('æ„Ÿè°¢æ‚¨çš„è¯„ä»·ï¼\nçœŸå®æ„Ÿå— +5 ç§¯åˆ†å¥–åŠ±å·²åˆ°è´¦ï¼');
                    closeFeedbackForm();
                    loadHistory();
                }
            }
        }

        // é¢„è§ˆè¯„ä»·å›¾ç‰‡
        function previewFeedbackImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('feedback-image-img').src = e.target.result;
                    document.getElementById('feedback-image-preview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // è´­ä¹°å•†å“
        function purchaseItem(itemId) {
            const currentUserStr = localStorage.getItem('currentUser');
            if (!currentUserStr) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const userInfo = JSON.parse(currentUserStr);
            const shopItems = StorageManager.getShopItems();
            const item = shopItems.find(i => i.id === itemId);

            if (!item) {
                alert('å•†å“ä¸å­˜åœ¨');
                return;
            }

            if (item.stock <= 0) {
                alert('å•†å“å·²å”®ç½„');
                return;
            }

            if ((userInfo.points || 0) < item.price) {
                alert('ç§¯åˆ†ä¸è¶³');
                return;
            }

            // æ£€æŸ¥è¿èƒœç«ç‚¬çš„æ¯å‘¨é™è´­
            if (item.type === 'streak_torch' || item.id === 'streak_torch') {
                // åˆå§‹åŒ–ç«ç‚¬è´­ä¹°è®°å½•
                if (!userInfo.torchPurchaseHistory) {
                    userInfo.torchPurchaseHistory = [];
                }

                // è·å–æœ¬å‘¨çš„å¼€å§‹æ—¶é—´ï¼ˆå‘¨ä¸€00:00:00ï¼‰
                const now = new Date();
                const dayOfWeek = now.getDay(); // 0æ˜¯å‘¨æ—¥ï¼Œ1æ˜¯å‘¨ä¸€
                const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // è®¡ç®—è·ç¦»å‘¨ä¸€çš„å¤©æ•°
                const thisWeekStart = new Date(now);
                thisWeekStart.setDate(now.getDate() - daysToMonday);
                thisWeekStart.setHours(0, 0, 0, 0);
                const weekStartTimestamp = thisWeekStart.getTime();

                // æ£€æŸ¥æœ¬å‘¨æ˜¯å¦å·²ç»è´­ä¹°è¿‡
                const purchasedThisWeek = userInfo.torchPurchaseHistory.some(purchase => {
                    return purchase.timestamp >= weekStartTimestamp;
                });

                if (purchasedThisWeek) {
                    alert('è¿èƒœç«ç‚¬æ¯å‘¨é™è´­1ä¸ª\nè¯·ä¸‹å‘¨å†æ¥è´­ä¹°ï¼');
                    return;
                }
            }

            if (confirm(`ç¡®å®šè¦å…‘æ¢ ${item.name} å—ï¼Ÿ\néœ€è¦æ¶ˆè€— ${item.price} ç§¯åˆ†`)) {
                // æ”¶é›†æ”¶è´§åœ°å€ä¿¡æ¯
                const receiverName = prompt('è¯·è¾“å…¥æ”¶è´§äººå§“åï¼š');
                if (!receiverName || receiverName.trim() === '') {
                    alert('æ”¶è´§äººå§“åä¸èƒ½ä¸ºç©º');
                    return;
                }

                const receiverPhone = prompt('è¯·è¾“å…¥æ”¶è´§äººæ‰‹æœºå·ï¼š');
                if (!receiverPhone || receiverPhone.trim() === '') {
                    alert('æ”¶è´§äººæ‰‹æœºå·ä¸èƒ½ä¸ºç©º');
                    return;
                }

                const receiverAddress = prompt('è¯·è¾“å…¥è¯¦ç»†æ”¶è´§åœ°å€ï¼š');
                if (!receiverAddress || receiverAddress.trim() === '') {
                    alert('æ”¶è´§åœ°å€ä¸èƒ½ä¸ºç©º');
                    return;
                }

                // æ‰£é™¤ç§¯åˆ† - ä»æœ€æ—©çš„æœ‰æ•ˆç§¯åˆ†å¼€å§‹æ‰£é™¤
                if (!userInfo.pointsHistory) {
                    userInfo.pointsHistory = [];
                }

                // æŒ‰æ—¶é—´æ’åºï¼Œä»æœ€æ—©çš„å¼€å§‹æ‰£é™¤
                const now = Date.now();
                const validPoints = userInfo.pointsHistory
                    .filter(p => (!p.expiresAt || p.expiresAt > now) && !p.spent)
                    .sort((a, b) => (a.earnedAt || a.timestamp || 0) - (b.earnedAt || b.timestamp || 0));

                let remainingCost = item.price;
                for (let pointEntry of validPoints) {
                    if (remainingCost <= 0) break;

                    if (pointEntry.points <= remainingCost) {
                        // å®Œå…¨ä½¿ç”¨è¿™ä¸ªç§¯åˆ†è®°å½•
                        pointEntry.spent = true;
                        pointEntry.spentAt = now;
                        remainingCost -= pointEntry.points;
                    } else {
                        // éƒ¨åˆ†ä½¿ç”¨è¿™ä¸ªç§¯åˆ†è®°å½• - æ‹†åˆ†æˆå·²ä½¿ç”¨å’Œå‰©ä½™éƒ¨åˆ†
                        const usedPoints = remainingCost;
                        pointEntry.points -= usedPoints;

                        // æ·»åŠ ä¸€ä¸ªå·²ä½¿ç”¨çš„è®°å½•
                        userInfo.pointsHistory.push({
                            points: usedPoints,
                            earnedAt: pointEntry.earnedAt || pointEntry.timestamp,
                            expiresAt: pointEntry.expiresAt,
                            source: pointEntry.source || pointEntry.type,
                            spent: true,
                            spentAt: now
                        });

                        remainingCost = 0;
                    }
                }

                // é‡æ–°è®¡ç®—æ€»ç§¯åˆ†
                userInfo.points = userInfo.pointsHistory
                    .filter(p => (!p.expiresAt || p.expiresAt > now) && !p.spent)
                    .reduce((sum, p) => sum + p.points, 0);

                // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯è¿èƒœç«ç‚¬ï¼Œå¢åŠ ç”¨æˆ·çš„ç«ç‚¬æ•°é‡å¹¶è®°å½•è´­ä¹°æ—¶é—´
                if (item.type === 'streak_torch' || item.id === 'streak_torch') {
                    userInfo.streakTorches = (userInfo.streakTorches || 0) + 1;

                    // è®°å½•è´­ä¹°æ—¶é—´
                    if (!userInfo.torchPurchaseHistory) {
                        userInfo.torchPurchaseHistory = [];
                    }
                    userInfo.torchPurchaseHistory.push({
                        timestamp: Date.now(),
                        itemId: item.id
                    });
                }

                // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
                localStorage.setItem('currentUser', JSON.stringify(userInfo));
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIndex = users.findIndex(u => u.id === userInfo.id);
                if (userIndex !== -1) {
                    users[userIndex].points = userInfo.points;
                    // åŒæ­¥ç«ç‚¬æ•°é‡
                    if (item.type === 'streak_torch' || item.id === 'streak_torch') {
                        users[userIndex].streakTorches = userInfo.streakTorches;
                    }
                    localStorage.setItem('users', JSON.stringify(users));
                }

                // å‡å°‘åº“å­˜
                item.stock -= 1;
                StorageManager.updateShopItem(itemId, { stock: item.stock });

                // åˆ›å»ºå…‘æ¢è®¢å•
                const order = {
                    id: Date.now().toString(),
                    userId: userInfo.id,
                    userName: userInfo.username,
                    itemId: item.id,
                    itemName: item.name,
                    itemIcon: item.icon,
                    price: item.price,
                    receiverName: receiverName.trim(),
                    receiverPhone: receiverPhone.trim(),
                    receiverAddress: receiverAddress.trim(),
                    status: 'pending', // pending: å¾…å‘è´§, shipped: å·²å‘è´§, completed: å·²å®Œæˆ
                    createdAt: Date.now()
                };

                // ä¿å­˜è®¢å•
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                orders.push(order);
                localStorage.setItem('orders', JSON.stringify(orders));

                // æ›´æ–°ä»“åº“å°çº¢ç‚¹
                updateWarehouseBadge();

                // æ·»åŠ è´­ä¹°è®°å½•
                StorageManager.addPurchaseRecord({
                    userId: userInfo.id,
                    userName: userInfo.username,
                    itemId: item.id,
                    itemName: item.name,
                    price: item.price
                });

                // æ„å»ºæç¤ºæ¶ˆæ¯
                let alertMessage = `å…‘æ¢æˆåŠŸï¼\næ‚¨è·å¾—äº†ï¼š${item.name}\nå‰©ä½™ç§¯åˆ†ï¼š${userInfo.points}\n\nå•†å“å°†å‘é€è‡³ï¼š\n${receiverName} ${receiverPhone}\n${receiverAddress}`;
                if (item.type === 'streak_torch' || item.id === 'streak_torch') {
                    alertMessage += `\n\nå½“å‰æ‹¥æœ‰ç«ç‚¬ï¼š${userInfo.streakTorches}ä¸ª`;
                }
                alert(alertMessage);
                loadShop();
            }
        }

        // åŠ è½½ä»“åº“ç®¡ç†é¡µé¢
        function loadWarehouse() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const container = document.getElementById('warehouse-orders-list');

            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“¦</div>
                        <div>æš‚æ— å…‘æ¢è®¢å•</div>
                    </div>
                `;
                return;
            }

            // æŒ‰çŠ¶æ€åˆ†ç»„
            const pendingOrders = orders.filter(o => o.status === 'pending');
            const shippedOrders = orders.filter(o => o.status === 'shipped');
            const completedOrders = orders.filter(o => o.status === 'completed');

            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <div style="flex: 1; text-align: center; padding: 15px; background: #fff3cd; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: #856404;">${pendingOrders.length}</div>
                            <div style="font-size: 14px; color: #856404;">å¾…å‘è´§</div>
                        </div>
                        <div style="flex: 1; text-align: center; padding: 15px; background: #d1ecf1; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: #0c5460;">${shippedOrders.length}</div>
                            <div style="font-size: 14px; color: #0c5460;">å·²å‘è´§</div>
                        </div>
                        <div style="flex: 1; text-align: center; padding: 15px; background: #d4edda; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: #155724;">${completedOrders.length}</div>
                            <div style="font-size: 14px; color: #155724;">å·²å®Œæˆ</div>
                        </div>
                    </div>
                </div>

                ${pendingOrders.length > 0 ? `
                    <h3 style="margin-bottom: 15px;">ğŸ“¦ å¾…å‘è´§è®¢å•</h3>
                    ${pendingOrders.map(order => `
                        <div class="card" style="border-left: 4px solid #ffc107;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 32px; margin-bottom: 5px;">${order.itemIcon || 'ğŸ'}</div>
                                    <strong style="font-size: 18px;">${order.itemName}</strong>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 20px; font-weight: 600; color: #667eea;">â­ ${order.price}</div>
                                    <div style="font-size: 12px; color: #999;">ç§¯åˆ†</div>
                                </div>
                            </div>

                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                    <strong>ç”¨æˆ·ï¼š</strong>${order.userName}
                                </div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                    <strong>æ”¶è´§äººï¼š</strong>${order.receiverName} ${order.receiverPhone}
                                </div>
                                <div style="font-size: 14px; color: #666;">
                                    <strong>åœ°å€ï¼š</strong>${order.receiverAddress}
                                </div>
                            </div>

                            <div style="font-size: 12px; color: #999; margin-bottom: 12px;">
                                è®¢å•æ—¶é—´ï¼š${new Date(order.createdAt).toLocaleString('zh-CN')}
                            </div>

                            <button class="btn btn-primary btn-block" onclick="updateOrderStatus('${order.id}', 'shipped')">
                                æ ‡è®°ä¸ºå·²å‘è´§
                            </button>
                        </div>
                    `).join('')}
                ` : ''}

                ${shippedOrders.length > 0 ? `
                    <h3 style="margin-bottom: 15px; margin-top: 20px;">ğŸšš å·²å‘è´§è®¢å•</h3>
                    ${shippedOrders.map(order => `
                        <div class="card" style="border-left: 4px solid #17a2b8;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 32px; margin-bottom: 5px;">${order.itemIcon || 'ğŸ'}</div>
                                    <strong style="font-size: 18px;">${order.itemName}</strong>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 20px; font-weight: 600; color: #667eea;">â­ ${order.price}</div>
                                    <div style="font-size: 12px; color: #999;">ç§¯åˆ†</div>
                                </div>
                            </div>

                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                    <strong>ç”¨æˆ·ï¼š</strong>${order.userName}
                                </div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                    <strong>æ”¶è´§äººï¼š</strong>${order.receiverName} ${order.receiverPhone}
                                </div>
                                <div style="font-size: 14px; color: #666;">
                                    <strong>åœ°å€ï¼š</strong>${order.receiverAddress}
                                </div>
                            </div>

                            <div style="font-size: 12px; color: #999; margin-bottom: 12px;">
                                è®¢å•æ—¶é—´ï¼š${new Date(order.createdAt).toLocaleString('zh-CN')}
                            </div>

                            <button class="btn btn-success btn-block" onclick="updateOrderStatus('${order.id}', 'completed')">
                                æ ‡è®°ä¸ºå·²å®Œæˆ
                            </button>
                        </div>
                    `).join('')}
                ` : ''}

                ${completedOrders.length > 0 ? `
                    <h3 style="margin-bottom: 15px; margin-top: 20px;">âœ… å·²å®Œæˆè®¢å•</h3>
                    ${completedOrders.map(order => `
                        <div class="card" style="border-left: 4px solid #28a745; opacity: 0.8;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 32px; margin-bottom: 5px;">${order.itemIcon || 'ğŸ'}</div>
                                    <strong style="font-size: 18px;">${order.itemName}</strong>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 20px; font-weight: 600; color: #667eea;">â­ ${order.price}</div>
                                    <div style="font-size: 12px; color: #999;">ç§¯åˆ†</div>
                                </div>
                            </div>

                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                    <strong>ç”¨æˆ·ï¼š</strong>${order.userName}
                                </div>
                                <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                    <strong>æ”¶è´§äººï¼š</strong>${order.receiverName} ${order.receiverPhone}
                                </div>
                                <div style="font-size: 14px; color: #666;">
                                    <strong>åœ°å€ï¼š</strong>${order.receiverAddress}
                                </div>
                            </div>

                            <div style="font-size: 12px; color: #999;">
                                è®¢å•æ—¶é—´ï¼š${new Date(order.createdAt).toLocaleString('zh-CN')}
                            </div>
                        </div>
                    `).join('')}
                ` : ''}
            `;
        }

        // æ›´æ–°è®¢å•çŠ¶æ€
        function updateOrderStatus(orderId, newStatus) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const order = orders.find(o => o.id === orderId);

            if (!order) {
                alert('è®¢å•ä¸å­˜åœ¨');
                return;
            }

            const statusText = {
                'shipped': 'å·²å‘è´§',
                'completed': 'å·²å®Œæˆ'
            };

            if (confirm(`ç¡®å®šè¦å°†è®¢å•æ ‡è®°ä¸º"${statusText[newStatus]}"å—ï¼Ÿ`)) {
                order.status = newStatus;
                order.updatedAt = Date.now();
                localStorage.setItem('orders', JSON.stringify(orders));
                alert(`è®¢å•å·²æ ‡è®°ä¸º"${statusText[newStatus]}"`);
                loadWarehouse();
                updateWarehouseBadge();
            }
        }

        // æ›´æ–°ä»“åº“å°çº¢ç‚¹
        function updateWarehouseBadge() {
            const badge = document.getElementById('warehouse-badge');
            if (!badge) return;

            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const pendingCount = orders.filter(o => o.status === 'pending').length;

            if (pendingCount > 0) {
                badge.textContent = pendingCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // è€è™æœºæŠ½å¥–
        let isSpinning = false;

        function spinSlotMachine() {
            if (isSpinning) {
                alert('è€è™æœºæ­£åœ¨è¿è¡Œä¸­ï¼Œè¯·ç¨å€™');
                return;
            }

            const currentUserStr = localStorage.getItem('currentUser');
            if (!currentUserStr) return;

            const currentUser = JSON.parse(currentUserStr);
            const users = StorageManager.getUsers();
            const user = users.find(u => u.id === currentUser.id);

            if (!user) return;

            // æ£€æŸ¥æŠ½å¥–åˆ¸æ•°é‡
            const tickets = user.lotteryTickets || 0;
            if (tickets <= 0) {
                alert('æ‚¨æ²¡æœ‰æŠ½å¥–åˆ¸ï¼\nè¿ç»­7å¤©å¹³å‡æ¯å¤©åŠ©è·‘/è¢«åŠ©è·‘è¶…è¿‡3å…¬é‡Œå¯è·å¾—1å¼ æŠ½å¥–åˆ¸');
                return;
            }

            // æ‰£é™¤æŠ½å¥–åˆ¸
            user.lotteryTickets = tickets - 1;

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('lottery-tickets-count').textContent = user.lotteryTickets;

            // ä¿å­˜ç”¨æˆ·æ•°æ®
            StorageManager.saveUsers(users);

            // é€‰æ‹©å¥–å“ï¼ˆåŸºäºæ¦‚ç‡ï¼‰
            const prize = selectSlotPrize();

            // ç”ŸæˆåŒ¹é…å¥–å“çš„è€è™æœºç»“æœ
            const slotResults = generateSlotResults(prize);

            // å¼€å§‹åŠ¨ç”»
            isSpinning = true;
            const spinButton = document.getElementById('spin-button');
            spinButton.disabled = true;
            spinButton.style.opacity = '0.5';
            spinButton.style.cursor = 'not-allowed';

            animateSlots(slotResults, prize, user);
        }

        function loadLottery() {
            const currentUserStr = localStorage.getItem('currentUser');
            if (!currentUserStr) return;

            const currentUser = JSON.parse(currentUserStr);
            const users = StorageManager.getUsers();
            const user = users.find(u => u.id === currentUser.id);

            if (!user) return;

            // è®¡ç®—æŠ½å¥–åˆ¸æ•°é‡
            const tickets = calculateLotteryTickets(currentUser.id);

            // æ›´æ–°æ˜¾ç¤º
            const ticketCountElement = document.getElementById('lottery-tickets-count');
            ticketCountElement.textContent = tickets;
            ticketCountElement.style.fontSize = '48px';

            // åˆå§‹åŒ–è€è™æœºæ˜¾ç¤º
            initSlotMachine();
        }

        // åˆå§‹åŒ–è€è™æœºæ˜¾ç¤º
        function initSlotMachine() {
            const symbols = ['ğŸ’', 'ğŸ‹', 'ğŸŠ', 'ğŸ‰', 'ğŸ””', 'ğŸ’', '7ï¸âƒ£'];
            const slots = document.querySelectorAll('.slot');

            slots.forEach((slot, index) => {
                const symbolsContainer = slot.querySelector('.slot-symbols');
                const randomSymbol = symbols[Math.floor(Math.random() * symbols.length)];
                symbolsContainer.innerHTML = `<div style="height: 100px; display: flex; align-items: center; justify-content: center; font-size: 40px;">${randomSymbol}</div>`;
            });
        }

        function calculateLotteryTickets(userId) {
            const exerciseRecords = StorageManager.getExerciseRecords();
            const users = StorageManager.getUsers();
            const user = users.find(u => u.id === userId);

            if (!user) return 0;

            // è·å–ç”¨æˆ·çš„æŠ½å¥–åˆ¸æ•°é‡ï¼ˆå¦‚æœå·²å­˜å‚¨ï¼‰
            if (user.lotteryTickets !== undefined) {
                return user.lotteryTickets;
            }

            // è®¡ç®—ç”¨æˆ·çš„è¿åŠ¨è®°å½•
            const userRecords = exerciseRecords.filter(record => {
                return record.status === 'approved' &&
                       (record.blindUserId === userId || record.volunteerId === userId);
            });

            if (userRecords.length === 0) {
                user.lotteryTickets = 0;
                StorageManager.saveUsers(users);
                return 0;
            }

            // æŒ‰æ—¥æœŸåˆ†ç»„ç»Ÿè®¡æ¯å¤©çš„æ€»è·ç¦»
            const dailyDistances = {};
            userRecords.forEach(record => {
                const date = new Date(record.createdAt).toISOString().split('T')[0];
                if (!dailyDistances[date]) {
                    dailyDistances[date] = 0;
                }
                dailyDistances[date] += parseFloat(record.distance) || 0;
            });

            // è·å–æ‰€æœ‰æ—¥æœŸå¹¶æ’åº
            const dates = Object.keys(dailyDistances).sort();

            // æ£€æŸ¥è¿ç»­7å¤©çš„æƒ…å†µï¼ˆä¸é‡å è®¡ç®—ï¼‰
            let tickets = 0;
            let i = 0;
            while (i <= dates.length - 7) {
                let isConsecutive = true;
                let totalDistance = 0;

                // æ£€æŸ¥æ˜¯å¦è¿ç»­7å¤©
                for (let j = 0; j < 7; j++) {
                    const currentDate = new Date(dates[i + j]);
                    const nextDate = j < 6 ? new Date(dates[i + j + 1]) : null;

                    totalDistance += dailyDistances[dates[i + j]];

                    // æ£€æŸ¥æ—¥æœŸæ˜¯å¦è¿ç»­
                    if (nextDate) {
                        const dayDiff = (nextDate - currentDate) / (1000 * 60 * 60 * 24);
                        if (dayDiff !== 1) {
                            isConsecutive = false;
                            break;
                        }
                    }
                }

                // å¦‚æœè¿ç»­7å¤©ä¸”æ€»è·ç¦»â‰¥21å…¬é‡Œï¼Œè·å¾—1å¼ æŠ½å¥–åˆ¸
                if (isConsecutive && totalDistance >= 21) {
                    tickets++;
                    i += 7; // è·³è¿‡è¿™7å¤©ï¼Œé¿å…é‡å¤è®¡ç®—
                } else {
                    i++; // å¦‚æœä¸ç¬¦åˆæ¡ä»¶ï¼Œç§»åŠ¨åˆ°ä¸‹ä¸€å¤©
                }
            }

            // ä¿å­˜æŠ½å¥–åˆ¸æ•°é‡
            user.lotteryTickets = tickets;
            StorageManager.saveUsers(users);

            return tickets;
        }

        // é€‰æ‹©è€è™æœºå¥–å“ï¼ˆåŸºäºæ¦‚ç‡ï¼‰
        function selectSlotPrize() {
            const random = Math.random();

            // ç´¯ç§¯æ¦‚ç‡åˆ†å¸ƒ
            if (random < 0.001) {
                return { points: 3888, label: '5ä¸ªç›¸åŒ', matchCount: 5 };
            } else if (random < 0.001 + 0.019) {
                return { points: 2888, label: '4ä¸ªç›¸åŒ', matchCount: 4 };
            } else if (random < 0.001 + 0.019 + 0.05) {
                return { points: 1888, label: '3ä¸ªç›¸åŒ', matchCount: 3 };
            } else if (random < 0.001 + 0.019 + 0.05 + 0.25) {
                return { points: 888, label: '2ä¸ªç›¸åŒ', matchCount: 2 };
            } else {
                return { points: 188, label: 'å…¨ä¸åŒ', matchCount: 0 };
            }
        }

        // ç”ŸæˆåŒ¹é…å¥–å“çš„è€è™æœºç»“æœ
        function generateSlotResults(prize) {
            const symbols = ['ğŸ’', 'ğŸ‹', 'ğŸŠ', 'ğŸ‰', 'ğŸ””', 'ğŸ’', '7ï¸âƒ£'];
            const results = [];

            if (prize.matchCount === 5) {
                // 5ä¸ªç›¸åŒ
                const symbol = symbols[Math.floor(Math.random() * symbols.length)];
                return [symbol, symbol, symbol, symbol, symbol];
            } else if (prize.matchCount === 4) {
                // 4ä¸ªç›¸åŒ
                const matchSymbol = symbols[Math.floor(Math.random() * symbols.length)];
                const differentSymbol = symbols.filter(s => s !== matchSymbol)[Math.floor(Math.random() * (symbols.length - 1))];
                const arr = [matchSymbol, matchSymbol, matchSymbol, matchSymbol, differentSymbol];
                // éšæœºæ‰“ä¹±ä½ç½®
                return arr.sort(() => Math.random() - 0.5);
            } else if (prize.matchCount === 3) {
                // 3ä¸ªç›¸åŒ
                const matchSymbol = symbols[Math.floor(Math.random() * symbols.length)];
                const otherSymbols = symbols.filter(s => s !== matchSymbol);
                const diff1 = otherSymbols[Math.floor(Math.random() * otherSymbols.length)];
                const diff2 = otherSymbols.filter(s => s !== diff1)[Math.floor(Math.random() * (otherSymbols.length - 1))];
                const arr = [matchSymbol, matchSymbol, matchSymbol, diff1, diff2];
                return arr.sort(() => Math.random() - 0.5);
            } else if (prize.matchCount === 2) {
                // 2ä¸ªç›¸åŒ
                const matchSymbol = symbols[Math.floor(Math.random() * symbols.length)];
                const otherSymbols = symbols.filter(s => s !== matchSymbol);
                const diff1 = otherSymbols[Math.floor(Math.random() * otherSymbols.length)];
                const diff2 = otherSymbols.filter(s => s !== diff1)[Math.floor(Math.random() * (otherSymbols.length - 1))];
                const diff3 = otherSymbols.filter(s => s !== diff1 && s !== diff2)[Math.floor(Math.random() * (otherSymbols.length - 2))];
                const arr = [matchSymbol, matchSymbol, diff1, diff2, diff3];
                return arr.sort(() => Math.random() - 0.5);
            } else {
                // å…¨ä¸åŒ
                const shuffled = [...symbols].sort(() => Math.random() - 0.5);
                return shuffled.slice(0, 5);
            }
        }

        // è€è™æœºåŠ¨ç”»
        function animateSlots(finalResults, prize, user) {
            const symbols = ['ğŸ’', 'ğŸ‹', 'ğŸŠ', 'ğŸ‰', 'ğŸ””', 'ğŸ’', '7ï¸âƒ£'];
            const slots = document.querySelectorAll('.slot');
            const duration = 2000; // 2ç§’åŠ¨ç”»
            const spinSpeed = 50; // æ¯50msæ›´æ¢ä¸€æ¬¡ç¬¦å·

            let elapsed = 0;
            const interval = setInterval(() => {
                elapsed += spinSpeed;

                // éšæœºæ›´æ¢æ¯ä¸ªæ§½ä½çš„ç¬¦å·
                slots.forEach((slot, index) => {
                    const symbolsContainer = slot.querySelector('.slot-symbols');
                    const randomSymbol = symbols[Math.floor(Math.random() * symbols.length)];
                    symbolsContainer.innerHTML = `<div style="height: 100px; display: flex; align-items: center; justify-content: center; font-size: 40px;">${randomSymbol}</div>`;
                });

                // åŠ¨ç”»ç»“æŸ
                if (elapsed >= duration) {
                    clearInterval(interval);

                    // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                    slots.forEach((slot, index) => {
                        const symbolsContainer = slot.querySelector('.slot-symbols');
                        symbolsContainer.innerHTML = `<div style="height: 100px; display: flex; align-items: center; justify-content: center; font-size: 40px;">${finalResults[index]}</div>`;
                    });

                    // å»¶è¿Ÿæ˜¾ç¤ºç»“æœï¼Œè®©ç”¨æˆ·çœ‹æ¸…æ¥š
                    setTimeout(() => {
                        awardSlotPrize(prize, user);
                    }, 500);
                }
            }, spinSpeed);
        }

        // å‘æ”¾è€è™æœºå¥–å“
        function awardSlotPrize(prize, user) {
            const users = StorageManager.getUsers();
            const currentUser = users.find(u => u.id === user.id);

            if (!currentUser) return;

            // è®°å½•ç§¯åˆ†å†å²
            if (!currentUser.pointsHistory) {
                currentUser.pointsHistory = [];
            }

            currentUser.pointsHistory.push({
                points: prize.points,
                reason: `è€è™æœºæŠ½å¥–-${prize.label}`,
                timestamp: Date.now(),
                earnedAt: Date.now(),
                expiresAt: Date.now() + 365 * 24 * 60 * 60 * 1000 // 1å¹´åè¿‡æœŸ
            });

            // è®¡ç®—æœ‰æ•ˆç§¯åˆ†æ€»å’Œï¼ˆæ’é™¤è¿‡æœŸç§¯åˆ†ï¼‰
            const now = Date.now();
            currentUser.points = currentUser.pointsHistory
                .filter(p => !p.expiresAt || p.expiresAt > now)
                .reduce((sum, p) => sum + p.points, 0);

            StorageManager.saveUsers(users);

            // æ›´æ–°localStorageä¸­çš„currentUser
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            // æ˜¾ç¤ºä¸­å¥–ä¿¡æ¯
            alert(`ğŸ‰ æ­å–œæ‚¨ï¼\n\n${prize.label}ï¼Œè·å¾— ${prize.points} ç§¯åˆ†ï¼\n\nå½“å‰ç§¯åˆ†ï¼š${currentUser.points}`);

            // é‡ç½®æŒ‰é’®çŠ¶æ€
            isSpinning = false;
            const spinButton = document.getElementById('spin-button');
            spinButton.disabled = false;
            spinButton.style.opacity = '1';
            spinButton.style.cursor = 'pointer';
        }

        // é€‰æ‹©ç”¨æˆ·ç±»å‹
        function selectUserType(type) {
            const container = document.getElementById('user-form-container');
            container.innerHTML = `
                <div class="form-group">
                    <label class="form-label">å§“å</label>
                    <input type="text" id="user-name" class="form-input" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required>
                </div>
                <div class="form-group">
                    <label class="form-label">è”ç³»ç”µè¯</label>
                    <input type="tel" id="user-phone" class="form-input" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯" required>
                </div>
                <button class="btn btn-primary btn-block" onclick="saveUserInfo('${type}')">
                    å®Œæˆè®¾ç½®
                </button>
            `;
        }

        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
        function saveUserInfo(type) {
            const name = document.getElementById('user-name').value.trim();
            const phone = document.getElementById('user-phone').value.trim();

            if (!name || !phone) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }

            const userInfo = {
                id: StorageManager.generateId(),
                type: type,
                name: name,
                phone: phone,
                certified: false,
                createdAt: Date.now()
            };

            StorageManager.saveUserInfo(userInfo);
            alert('è®¾ç½®æˆåŠŸï¼');
            loadUserProfile();
        }

        // ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯
        function editUserInfo() {
            const userInfo = StorageManager.getUserInfo();
            const container = document.getElementById('user-info-section');

            container.innerHTML = `
                <h3 style="margin-bottom: 20px;">ç¼–è¾‘ä¸ªäººä¿¡æ¯</h3>
                <div class="form-group">
                    <label class="form-label">å§“å</label>
                    <input type="text" id="edit-name" class="form-input" value="${userInfo.name}" required>
                </div>
                <div class="form-group">
                    <label class="form-label">è”ç³»ç”µè¯</label>
                    <input type="tel" id="edit-phone" class="form-input" value="${userInfo.phone || ''}" required>
                </div>
                <button class="btn btn-primary btn-block" onclick="updateUserInfo()">
                    ä¿å­˜ä¿®æ”¹
                </button>
                <button class="btn btn-secondary btn-block" style="margin-top: 10px;" onclick="loadUserProfile()">
                    å–æ¶ˆ
                </button>
            `;
        }

        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        function updateUserInfo() {
            const name = document.getElementById('edit-name').value.trim();
            const phone = document.getElementById('edit-phone').value.trim();

            if (!name || !phone) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }

            const userInfo = StorageManager.getUserInfo();
            userInfo.name = name;
            userInfo.phone = phone;
            StorageManager.saveUserInfo(userInfo);

            alert('ä¿®æ”¹ï¿½ï¿½ï¿½åŠŸï¼');
            loadUserProfile();
        }

        // æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
        function checkUserInfo() {
            const userInfo = StorageManager.getUserInfo();
            if (!userInfo || !userInfo.name) {
                // é¦–æ¬¡ä½¿ç”¨ï¼Œå¼•å¯¼ç”¨æˆ·è®¾ï¿½ï¿½
                setTimeout(() => {
                    if (confirm('æ¬¢è¿ä½¿ç”¨åŠ©ç›²é™ªè·‘å¹³å°ï¼\n\nè¯·å…ˆè®¾ç½®æ‚¨çš„èº«ä»½ä¿¡æ¯ã€‚')) {
                        switchPage('profile');
                    }
                }, 500);
            }
        }

        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                localStorage.clear();
                alert('æ•°æ®å·²æ¸…é™¤');
                location.reload();
            }
        }

        // å‘å¸ƒéœ€æ±‚è¡¨å•å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            const publishForm = document.getElementById('publish-form');
            if (publishForm) {
                publishForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const currentUserStr = localStorage.getItem('currentUser');
                    if (!currentUserStr) {
                        alert('è¯·å…ˆç™»å½•');
                        location.reload();
                        return;
                    }

                    const userInfo = JSON.parse(currentUserStr);

                    // è·å–åœ°ç‚¹ç±»å‹
                    const locationType = document.querySelector('input[name="location-type"]:checked').value;

                    // è·å–æ¥é€æ–¹å¼
                    const pickupType = document.querySelector('input[name="pickup-type"]:checked').value;

                    const request = {
                        userName: userInfo.username,
                        userType: userInfo.type,
                        age: document.getElementById('request-age').value,
                        type: document.getElementById('request-type').value,
                        locationType: locationType,
                        locationTypeText: locationType === 'destination' ? 'è¦å»çš„åœ°ç‚¹' : 'ç»“ä¼´çš„åœ°ç‚¹',
                        location: document.getElementById('request-location').value,
                        pickupType: pickupType,
                        pickupTypeText: pickupType === 'home' ? 'åˆ°å®¶æ¥' : 'æ­£å¸¸æ¥é€',
                        time: document.getElementById('request-time').value,
                        phone: document.getElementById('request-phone').value,
                        description: document.getElementById('request-description').value
                    };

                    StorageManager.addRequest(request);
                    alert('éœ€æ±‚å‘å¸ƒæˆåŠŸï¼');
                    publishForm.reset();
                    switchPage('map');
                    loadRequestsList();
                });
            }
        });

        // ==================== èµ›äº‹ç³»ç»Ÿ ====================

        // åŠ è½½èµ›äº‹åˆ—è¡¨
        function loadEvents() {
            const currentUserStr = localStorage.getItem('currentUser');
            if (!currentUserStr) {
                return;
            }

            const currentUser = JSON.parse(currentUserStr);
            const events = StorageManager.getEvents();
            const participations = StorageManager.getEventParticipations();

            // æ˜¾ç¤ºåˆ›å»ºèµ›äº‹æŒ‰é’®ï¼ˆä»…å®˜æ–¹å®¡æ ¸å‘˜å¯è§ï¼‰
            const createSection = document.getElementById('create-event-section');
            if (currentUser.type === 'official') {
                createSection.style.display = 'block';
            } else {
                createSection.style.display = 'none';
            }

            // åˆ†ç±»èµ›äº‹
            const activeEvents = events.filter(e => e.status === 'active');
            const finishedEvents = events.filter(e => e.status === 'finished');
            const myParticipations = participations.filter(p => p.userId === currentUser.id);

            // æ¸²æŸ“è¿›è¡Œä¸­çš„èµ›äº‹
            const activeList = document.getElementById('active-events-list');
            if (activeEvents.length === 0) {
                activeList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— è¿›è¡Œä¸­çš„èµ›äº‹</div>';
            } else {
                activeList.innerHTML = activeEvents.map(event => {
                    const isRegistered = participations.some(p => p.eventId === event.id && p.userId === currentUser.id);
                    const participation = participations.find(p => p.eventId === event.id && p.userId === currentUser.id);

                    let statusBadge = '';
                    if (isRegistered) {
                        if (participation.completed) {
                            statusBadge = '<span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-left: 10px;">âœ… å·²å®Œæˆ</span>';
                        } else {
                            const progress = participation.progress.completed || 0;
                            statusBadge = `<span style="background: #2196f3; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-left: 10px;">è¿›åº¦: ${progress}/${event.requirement.count}</span>`;
                        }
                    }

                    return `
                        <div class="card" style="margin-bottom: 15px; cursor: pointer;" onclick="showEventDetail('${event.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h3 style="margin: 0; color: #333; flex: 1;">${event.title}</h3>
                                ${statusBadge}
                            </div>
                            <p style="color: #666; margin: 8px 0; font-size: 14px;">${event.description}</p>
                            <div style="display: flex; gap: 15px; margin-top: 12px; flex-wrap: wrap;">
                                <span style="color: #ff6b6b; font-size: 13px;">ğŸ¯ ${event.requirement.description}</span>
                                <span style="color: #4caf50; font-size: 13px;">ğŸ å¥–åŠ±: ${event.reward.points}ç§¯åˆ†</span>
                            </div>
                            <div style="margin-top: 10px; font-size: 12px; color: #999;">
                                ${new Date(event.createdAt).toLocaleString('zh-CN')}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // æ¸²æŸ“æˆ‘çš„èµ›äº‹
            const myEventsList = document.getElementById('my-events-list');
            if (myParticipations.length === 0) {
                myEventsList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æ‚¨è¿˜æ²¡æœ‰å‚åŠ ä»»ä½•èµ›äº‹</div>';
            } else {
                myEventsList.innerHTML = myParticipations.map(participation => {
                    const event = events.find(e => e.id === participation.eventId);
                    if (!event) return '';

                    const progress = participation.progress.completed || 0;
                    const progressPercent = Math.min((progress / event.requirement.count) * 100, 100);

                    return `
                        <div class="card" style="margin-bottom: 15px; cursor: pointer;" onclick="showEventDetail('${event.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h3 style="margin: 0; color: #333; flex: 1;">${event.title}</h3>
                                ${participation.completed ?
                                    '<span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">âœ… å·²å®Œæˆ</span>' :
                                    '<span style="background: #ff9800; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">â³ è¿›è¡Œä¸­</span>'
                                }
                            </div>
                            <div style="margin: 12px 0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px;">
                                    <span style="color: #666;">å®Œæˆè¿›åº¦</span>
                                    <span style="color: #2196f3; font-weight: 600;">${progress}/${event.requirement.count}</span>
                                </div>
                                <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${progressPercent}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: #999;">
                                æŠ¥åæ—¶é—´: ${new Date(participation.registeredAt).toLocaleString('zh-CN')}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // æ¸²æŸ“å·²ç»“æŸçš„èµ›äº‹
            const finishedList = document.getElementById('finished-events-list');
            if (finishedEvents.length === 0) {
                finishedList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— å·²ç»“æŸçš„èµ›äº‹</div>';
            } else {
                finishedList.innerHTML = finishedEvents.map(event => {
                    return `
                        <div class="card" style="margin-bottom: 15px; opacity: 0.7; cursor: pointer;" onclick="showEventDetail('${event.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h3 style="margin: 0; color: #666; flex: 1;">${event.title}</h3>
                                <span style="background: #9e9e9e; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">å·²ç»“æŸ</span>
                            </div>
                            <p style="color: #999; margin: 8px 0; font-size: 14px;">${event.description}</p>
                        </div>
                    `;
                }).join('');
            }
        }

        // æ˜¾ç¤ºåˆ›å»ºèµ›äº‹è¡¨å•
        function showCreateEventForm() {
            console.log('[DEBUG] æ˜¾ç¤ºåˆ›å»ºèµ›äº‹è¡¨å•');
            const modal = document.getElementById('create-event-modal');
            if (!modal) {
                console.error('[ERROR] æ‰¾ä¸åˆ°create-event-modalå…ƒç´ ');
                alert('é”™è¯¯ï¼šæ‰¾ä¸åˆ°åˆ›å»ºèµ›äº‹å¼¹çª—');
                return;
            }
            modal.style.display = 'flex';
            console.log('[DEBUG] å¼¹çª—å·²æ˜¾ç¤º');
        }

        // å…³é—­åˆ›å»ºèµ›äº‹è¡¨å•
        function closeCreateEventForm() {
            console.log('[DEBUG] å…³é—­åˆ›å»ºèµ›äº‹è¡¨å•');
            const modal = document.getElementById('create-event-modal');
            if (modal) {
                modal.style.display = 'none';
            }
            const form = document.getElementById('create-event-form');
            if (form) {
                form.reset();
            }
        }

        // æäº¤åˆ›å»ºèµ›äº‹
        function submitCreateEvent() {
            console.log('[DEBUG] å¼€å§‹åˆ›å»ºèµ›äº‹');

            try {
                const title = document.getElementById('event-title').value.trim();
                const description = document.getElementById('event-description').value.trim();
                const requirementType = document.getElementById('event-requirement-type').value;
                const requirementCount = parseInt(document.getElementById('event-requirement-count').value);
                const requirementDistance = parseFloat(document.getElementById('event-requirement-distance').value);
                const requirementTimeLimit = parseInt(document.getElementById('event-requirement-time-limit').value);
                const rewardPoints = parseInt(document.getElementById('event-reward-points').value);
                const targetUserType = document.getElementById('event-target-type').value;

                console.log('[DEBUG] è¡¨å•æ•°æ®:', {
                    title, description, requirementType, requirementCount,
                    requirementDistance, requirementTimeLimit, rewardPoints, targetUserType
                });

                if (!title || !description || !requirementCount || !requirementDistance || !requirementTimeLimit || !rewardPoints) {
                    alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                    console.warn('[WARN] è¡¨å•ä¿¡æ¯ä¸å®Œæ•´');
                    return;
                }

                // ç”Ÿæˆéœ€æ±‚æè¿°
                let requirementDescription = '';
                if (requirementType === 'consecutive') {
                    requirementDescription = `åœ¨${requirementTimeLimit}å°æ—¶å†…è¿ç»­å®Œæˆ${requirementCount}å•ï¼Œæ¯å•â‰¥${requirementDistance}km`;
                } else {
                    requirementDescription = `åœ¨${requirementTimeLimit}å°æ—¶å†…ç´¯è®¡å®Œæˆ${requirementCount}å•ï¼Œæ¯å•â‰¥${requirementDistance}km`;
                }

                const event = {
                    title: title,
                    description: description,
                    requirement: {
                        type: requirementType,
                        count: requirementCount,
                        minDistance: requirementDistance,
                        timeLimit: requirementTimeLimit,
                        description: requirementDescription
                    },
                    reward: {
                        points: rewardPoints
                    },
                    targetUserType: targetUserType,
                    status: 'active'
                };

                console.log('[DEBUG] å‡†å¤‡ä¿å­˜èµ›äº‹:', event);
                const savedEvent = StorageManager.addEvent(event);
                console.log('[DEBUG] èµ›äº‹å·²ä¿å­˜:', savedEvent);

                alert('èµ›äº‹åˆ›å»ºæˆåŠŸï¼');
                closeCreateEventForm();
                loadEvents();
                console.log('[DEBUG] èµ›äº‹åˆ›å»ºæµç¨‹å®Œæˆ');
            } catch (error) {
                console.error('[ERROR] åˆ›å»ºèµ›äº‹æ—¶å‡ºé”™:', error);
                alert('åˆ›å»ºèµ›äº‹å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ˜¾ç¤ºèµ›äº‹è¯¦æƒ…
        function showEventDetail(eventId) {
            const currentUserStr = localStorage.getItem('currentUser');
            if (!currentUserStr) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const currentUser = JSON.parse(currentUserStr);
            const events = StorageManager.getEvents();
            const event = events.find(e => e.id === eventId);

            if (!event) {
                alert('èµ›äº‹ä¸å­˜åœ¨');
                return;
            }

            const participations = StorageManager.getEventParticipations();
            const myParticipation = participations.find(p => p.eventId === eventId && p.userId === currentUser.id);
            const isRegistered = !!myParticipation;

            // è·å–æ’è¡Œæ¦œæ•°æ®ï¼ˆåªæ˜¾ç¤ºç›¸åŒç”¨æˆ·ç±»å‹çš„ï¼‰
            const eventParticipations = participations.filter(p => p.eventId === eventId);
            const users = StorageManager.getUsers();

            // æ ¹æ®å½“å‰ç”¨æˆ·ç±»å‹è¿‡æ»¤æ’è¡Œæ¦œ
            const leaderboardData = eventParticipations
                .map(p => {
                    const user = users.find(u => u.id === p.userId);
                    if (!user) return null;

                    // åªæ˜¾ç¤ºç›¸åŒç±»å‹çš„ç”¨æˆ·
                    if (event.targetUserType === 'all') {
                        // å¦‚æœèµ›äº‹é¢å‘æ‰€æœ‰äººï¼Œå¿—æ„¿è€…åªçœ‹å¿—æ„¿è€…æ¦œï¼Œç›²äººåªçœ‹ç›²äººæ¦œ
                        if (currentUser.type === 'volunteer' && user.type !== 'volunteer') return null;
                        if (currentUser.type === 'blind' && user.type !== 'blind') return null;
                    } else if (event.targetUserType !== user.type) {
                        return null;
                    }

                    return {
                        userId: user.id,
                        userName: user.name || user.username,
                        userType: user.type,
                        completed: p.completed,
                        progress: p.progress.completed || 0,
                        completedAt: p.completedAt || 0
                    };
                })
                .filter(item => item !== null)
                .sort((a, b) => {
                    // å·²å®Œæˆçš„æ’åœ¨å‰é¢ï¼ŒæŒ‰å®Œæˆæ—¶é—´æ’åº
                    if (a.completed && !b.completed) return -1;
                    if (!a.completed && b.completed) return 1;
                    if (a.completed && b.completed) return a.completedAt - b.completedAt;
                    // æœªå®Œæˆçš„æŒ‰è¿›åº¦æ’åº
                    return b.progress - a.progress;
                });

            // æ‰¾åˆ°å½“å‰ç”¨æˆ·çš„æ’å
            const myRank = leaderboardData.findIndex(item => item.userId === currentUser.id) + 1;

            // æ¸²æŸ“æ’è¡Œæ¦œ
            let leaderboardHTML = '';
            if (leaderboardData.length === 0) {
                leaderboardHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ’è¡Œæ•°æ®</div>';
            } else {
                leaderboardHTML = leaderboardData.map((item, index) => {
                    const rank = index + 1;
                    const isCurrentUser = item.userId === currentUser.id;
                    const rankEmoji = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : `${rank}.`;

                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${isCurrentUser ? '#fff3cd' : '#f5f5f5'}; border-radius: 8px; margin-bottom: 8px; ${isCurrentUser ? 'border: 2px solid #ffc107;' : ''}">
                            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                <span style="font-size: 18px; font-weight: 600; min-width: 35px;">${rankEmoji}</span>
                                <div>
                                    <div style="font-weight: 600; color: #333;">${item.userName}${isCurrentUser ? ' (æˆ‘)' : ''}</div>
                                    <div style="font-size: 12px; color: #666;">è¿›åº¦: ${item.progress}/${event.requirement.count}</div>
                                </div>
                            </div>
                            <div>
                                ${item.completed ?
                                    '<span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">âœ… å·²å®Œæˆ</span>' :
                                    `<span style="color: #2196f3; font-weight: 600;">${Math.round((item.progress / event.requirement.count) * 100)}%</span>`
                                }
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // æ˜¾ç¤ºèµ›äº‹è¯¦æƒ…æ¨¡æ€æ¡†
            const modal = document.getElementById('event-detail-modal');
            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333;">${event.title}</h2>
                        <button onclick="closeEventDetail()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">Ã—</button>
                    </div>

                    <div style="background: #f5f5f5; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <p style="color: #666; margin: 0; line-height: 1.6;">${event.description}</p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #333; margin-bottom: 12px;">ğŸ“‹ èµ›äº‹è¦æ±‚</h3>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 12px; border-left: 4px solid #ffc107;">
                            <p style="margin: 0; color: #333; font-weight: 500;">${event.requirement.description}</p>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #333; margin-bottom: 12px;">ğŸ èµ›äº‹å¥–åŠ±</h3>
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 12px; border-left: 4px solid #4caf50;">
                            <p style="margin: 0; color: #333; font-weight: 600; font-size: 18px;">${event.reward.points} ç§¯åˆ†</p>
                        </div>
                    </div>

                    ${isRegistered ? `
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #333; margin-bottom: 12px;">ğŸ“Š æˆ‘çš„è¿›åº¦</h3>
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: #666;">å®Œæˆè¿›åº¦</span>
                                    <span style="color: #2196f3; font-weight: 600;">${myParticipation.progress.completed}/${event.requirement.count}</span>
                                </div>
                                <div style="background: #fff; height: 10px; border-radius: 5px; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, #2196f3 0%, #1976d2 100%); height: 100%; width: ${Math.min((myParticipation.progress.completed / event.requirement.count) * 100, 100)}%; transition: width 0.3s;"></div>
                                </div>
                                ${myParticipation.completed ?
                                    '<div style="margin-top: 10px; color: #4caf50; font-weight: 600; text-align: center;">ğŸ‰ æ­å–œå®Œæˆèµ›äº‹ï¼</div>' :
                                    ''
                                }
                            </div>
                        </div>
                    ` : ''}

                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #333; margin-bottom: 12px;">ğŸ† æ’è¡Œæ¦œ${myRank > 0 ? ` (æˆ‘çš„æ’å: ç¬¬${myRank}å)` : ''}</h3>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${leaderboardHTML}
                        </div>
                    </div>

                    ${!isRegistered && event.status === 'active' ? `
                        <button onclick="registerEvent('${event.id}')" class="btn btn-primary btn-block">
                            ğŸ¯ ç«‹å³æŠ¥å
                        </button>
                    ` : ''}
                </div>
            `;
            modal.style.display = 'flex';
        }

        // å…³é—­èµ›äº‹è¯¦æƒ…
        function closeEventDetail() {
            document.getElementById('event-detail-modal').style.display = 'none';
        }

        // æŠ¥åèµ›äº‹
        function registerEvent(eventId) {
            console.log('[DEBUG] å¼€å§‹æŠ¥åèµ›äº‹:', eventId);

            try {
                const currentUserStr = localStorage.getItem('currentUser');
                if (!currentUserStr) {
                    alert('è¯·å…ˆç™»å½•');
                    console.warn('[WARN] ç”¨æˆ·æœªç™»å½•');
                    return;
                }

                const currentUser = JSON.parse(currentUserStr);
                console.log('[DEBUG] å½“å‰ç”¨æˆ·:', currentUser);

                const events = StorageManager.getEvents();
                const event = events.find(e => e.id === eventId);

                if (!event) {
                    alert('èµ›äº‹ä¸å­˜åœ¨');
                    console.error('[ERROR] æ‰¾ä¸åˆ°èµ›äº‹:', eventId);
                    return;
                }

                console.log('[DEBUG] æ‰¾åˆ°èµ›äº‹:', event);

                // æ£€æŸ¥ç”¨æˆ·ç±»å‹æ˜¯å¦ç¬¦åˆ
                if (event.targetUserType !== 'all' && event.targetUserType !== currentUser.type) {
                    alert('è¯¥èµ›äº‹ä¸é¢å‘æ‚¨çš„ç”¨æˆ·ç±»å‹');
                    console.warn('[WARN] ç”¨æˆ·ç±»å‹ä¸ç¬¦:', currentUser.type, 'èµ›äº‹è¦æ±‚:', event.targetUserType);
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦å·²æŠ¥å
                const participations = StorageManager.getEventParticipations();
                const alreadyRegistered = participations.some(p => p.eventId === eventId && p.userId === currentUser.id);

                if (alreadyRegistered) {
                    alert('æ‚¨å·²ç»æŠ¥åè¿‡è¯¥èµ›äº‹äº†');
                    console.warn('[WARN] ç”¨æˆ·å·²æŠ¥å');
                    return;
                }

                // åˆ›å»ºå‚èµ›è®°å½•
                const participation = {
                    eventId: eventId,
                    userId: currentUser.id,
                    userName: currentUser.name || currentUser.username,
                    userType: currentUser.type
                };

                console.log('[DEBUG] åˆ›å»ºå‚èµ›è®°å½•:', participation);
                const savedParticipation = StorageManager.addEventParticipation(participation);
                console.log('[DEBUG] å‚èµ›è®°å½•å·²ä¿å­˜:', savedParticipation);

                alert('æŠ¥åæˆåŠŸï¼åŠ æ²¹å®Œæˆèµ›äº‹å§ï¼');
                closeEventDetail();
                loadEvents();
                console.log('[DEBUG] æŠ¥åæµç¨‹å®Œæˆ');
            } catch (error) {
                console.error('[ERROR] æŠ¥åèµ›äº‹æ—¶å‡ºé”™:', error);
                alert('æŠ¥åå¤±è´¥ï¼š' + error.message);
            }
        }

        // æ£€æŸ¥èµ›äº‹è¿›åº¦ï¼ˆåœ¨å®¡æ ¸è¿åŠ¨è®°å½•æ—¶è°ƒç”¨ï¼‰
        function checkEventProgress(userId, exerciseRecord) {
            console.log('[DEBUG] æ£€æŸ¥èµ›äº‹è¿›åº¦ - ç”¨æˆ·ID:', userId, 'è¿åŠ¨è®°å½•:', exerciseRecord);

            try {
                const events = StorageManager.getEvents();
                const participations = StorageManager.getEventParticipations();
                const users = StorageManager.getUsers();

                console.log('[DEBUG] å½“å‰èµ›äº‹æ•°:', events.length, 'å‚èµ›è®°å½•æ•°:', participations.length);

                // è·å–ç”¨æˆ·å‚ä¸çš„æ‰€æœ‰è¿›è¡Œä¸­çš„èµ›äº‹
                const userParticipations = participations.filter(p =>
                    p.userId === userId &&
                    !p.completed &&
                    events.find(e => e.id === p.eventId && e.status === 'active')
                );

                console.log('[DEBUG] ç”¨æˆ·å‚ä¸çš„è¿›è¡Œä¸­èµ›äº‹æ•°:', userParticipations.length);

                userParticipations.forEach(participation => {
                    const event = events.find(e => e.id === participation.eventId);
                    if (!event) {
                        console.warn('[WARN] æ‰¾ä¸åˆ°èµ›äº‹:', participation.eventId);
                        return;
                    }

                    console.log('[DEBUG] å¤„ç†èµ›äº‹:', event.title);

                    // æ£€æŸ¥è¿åŠ¨è®°å½•æ˜¯å¦ç¬¦åˆèµ›äº‹è¦æ±‚
                    const distance = parseFloat(exerciseRecord.distance);
                    console.log('[DEBUG] è¿åŠ¨è·ç¦»:', distance, 'è¦æ±‚æœ€ä½è·ç¦»:', event.requirement.minDistance);

                    if (distance < event.requirement.minDistance) {
                        console.log('[DEBUG] è·ç¦»ä¸ç¬¦åˆè¦æ±‚ï¼Œè·³è¿‡');
                        return; // è·ç¦»ä¸ç¬¦åˆè¦æ±‚
                    }

                    // æ·»åŠ åˆ°è¿›åº¦è®°å½•
                    if (!participation.progress.records) {
                        participation.progress.records = [];
                    }

                    participation.progress.records.push({
                        recordId: exerciseRecord.id,
                        distance: distance,
                        timestamp: exerciseRecord.createdAt || Date.now()
                    });

                    console.log('[DEBUG] å·²æ·»åŠ è¿›åº¦è®°å½•ï¼Œå½“å‰è®°å½•æ•°:', participation.progress.records.length);

                    // æ£€æŸ¥æ˜¯å¦åœ¨æ—¶é—´é™åˆ¶å†…
                    const timeLimit = event.requirement.timeLimit * 60 * 60 * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
                    const now = Date.now();

                    if (event.requirement.type === 'consecutive') {
                        console.log('[DEBUG] è¿ç»­å®Œæˆæ¨¡å¼');
                        // è¿ç»­å®Œæˆï¼šæ£€æŸ¥æœ€è¿‘çš„è®°å½•æ˜¯å¦åœ¨æ—¶é—´é™åˆ¶å†…è¿ç»­
                        const recentRecords = participation.progress.records
                            .filter(r => now - r.timestamp <= timeLimit)
                            .sort((a, b) => a.timestamp - b.timestamp);

                        console.log('[DEBUG] æ—¶é—´é™åˆ¶å†…çš„è®°å½•æ•°:', recentRecords.length);

                        // æ£€æŸ¥æ˜¯å¦è¿ç»­
                        let consecutiveCount = 0;
                        let lastTimestamp = 0;

                        for (const record of recentRecords) {
                            if (consecutiveCount === 0) {
                                consecutiveCount = 1;
                                lastTimestamp = record.timestamp;
                            } else {
                                // æ£€æŸ¥ä¸ä¸Šä¸€æ¡è®°å½•çš„æ—¶é—´é—´éš”
                                const gap = record.timestamp - lastTimestamp;
                                const maxGap = timeLimit / event.requirement.count; // å¹³å‡æ—¶é—´é—´éš”

                                if (gap <= maxGap * 2) { // å…è®¸ä¸€å®šçš„æ—¶é—´å¼¹æ€§
                                    consecutiveCount++;
                                    lastTimestamp = record.timestamp;
                                } else {
                                    // ä¸è¿ç»­ï¼Œé‡æ–°å¼€å§‹è®¡æ•°
                                    consecutiveCount = 1;
                                    lastTimestamp = record.timestamp;
                                }
                            }
                        }

                        participation.progress.completed = consecutiveCount;
                        console.log('[DEBUG] è¿ç»­å®Œæˆæ•°:', consecutiveCount);
                    } else {
                        console.log('[DEBUG] ç´¯è®¡å®Œæˆæ¨¡å¼');
                        // ç´¯è®¡å®Œæˆï¼šç»Ÿè®¡æ—¶é—´é™åˆ¶å†…çš„æ‰€æœ‰è®°å½•
                        const validRecords = participation.progress.records.filter(r => now - r.timestamp <= timeLimit);
                        participation.progress.completed = validRecords.length;
                        console.log('[DEBUG] ç´¯è®¡å®Œæˆæ•°:', validRecords.length);
                    }

                    // æ£€æŸ¥æ˜¯å¦å®Œæˆèµ›äº‹
                    if (participation.progress.completed >= event.requirement.count && !participation.completed) {
                        console.log('[DEBUG] ğŸ‰ ç”¨æˆ·å®Œæˆèµ›äº‹ï¼');
                        participation.completed = true;
                        participation.completedAt = now;

                        // å‘æ”¾å¥–åŠ±
                        const user = users.find(u => u.id === userId);
                        if (user) {
                            if (!user.pointsHistory) {
                                user.pointsHistory = [];
                            }

                            user.pointsHistory.push({
                                points: event.reward.points,
                                reason: `å®Œæˆèµ›äº‹ï¼š${event.title}`,
                                timestamp: now,
                                expiresAt: now + (365 * 24 * 60 * 60 * 1000) // 1å¹´åè¿‡æœŸ
                            });

                            user.points = user.pointsHistory
                                .filter(p => !p.expiresAt || p.expiresAt > now)
                                .reduce((sum, p) => sum + p.points, 0);

                            console.log('[DEBUG] å·²å‘æ”¾å¥–åŠ±:', event.reward.points, 'ç§¯åˆ†ï¼Œç”¨æˆ·å½“å‰ç§¯åˆ†:', user.points);

                            StorageManager.saveUsers(users);

                            // æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
                            const currentUserStr = localStorage.getItem('currentUser');
                            if (currentUserStr) {
                                const currentUser = JSON.parse(currentUserStr);
                                if (currentUser.id === userId) {
                                    localStorage.setItem('currentUser', JSON.stringify(user));
                                }
                            }
                        }
                    } else {
                        console.log('[DEBUG] è¿›åº¦:', participation.progress.completed, '/', event.requirement.count);
                    }

                    // ä¿å­˜å‚èµ›è®°å½•
                    StorageManager.saveEventParticipations(participations);
                });

                console.log('[DEBUG] èµ›äº‹è¿›åº¦æ£€æŸ¥å®Œæˆ');
            } catch (error) {
                console.error('[ERROR] æ£€æŸ¥èµ›äº‹è¿›åº¦æ—¶å‡ºé”™:', error);
            }
        }

        // ==================== è¿èƒœå†°å†»ç³»ç»Ÿ ====================

        // æ˜¾ç¤ºç”³è¯·å†°å†»è¿èƒœå¼¹çª—
        function showRequestFreezeModal() {
            console.log('[DEBUG] æ˜¾ç¤ºç”³è¯·å†°å†»è¿èƒœå¼¹çª—');
            document.getElementById('request-freeze-modal').style.display = 'flex';
        }

        // å…³é—­ç”³è¯·å†°å†»è¿èƒœå¼¹çª—
        function closeRequestFreezeModal() {
            document.getElementById('request-freeze-modal').style.display = 'none';
            document.getElementById('freeze-reason').value = '';
        }

        // æäº¤å†°å†»è¿èƒœç”³è¯·
        function submitFreezeRequest() {
            console.log('[DEBUG] æäº¤å†°å†»è¿èƒœç”³è¯·');

            try {
                const currentUserStr = localStorage.getItem('currentUser');
                if (!currentUserStr) {
                    alert('è¯·å…ˆç™»å½•');
                    return;
                }

                const currentUser = JSON.parse(currentUserStr);

                if (currentUser.type !== 'volunteer') {
                    alert('åªæœ‰å¿—æ„¿è€…å¯ä»¥ç”³è¯·å†°å†»è¿èƒœ');
                    return;
                }

                if (currentUser.streakFrozen) {
                    alert('æ‚¨çš„è¿èƒœå·²ç»å¤„äºå†°å†»çŠ¶æ€');
                    return;
                }

                const reason = document.getElementById('freeze-reason').value.trim();
                if (!reason) {
                    alert('è¯·å¡«å†™ç”³è¯·ç†ç”±');
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å®¡æ ¸çš„ç”³è¯·
                const requests = StorageManager.getStreakFreezeRequests();
                const hasPending = requests.some(r => r.userId === currentUser.id && r.status === 'pending');
                if (hasPending) {
                    alert('æ‚¨å·²æœ‰å¾…å®¡æ ¸çš„å†°å†»ç”³è¯·ï¼Œè¯·ç­‰å¾…å®¡æ ¸');
                    return;
                }

                const request = {
                    userId: currentUser.id,
                    userName: currentUser.name || currentUser.username,
                    reason: reason,
                    currentStreak: currentUser.currentStreak || 0
                };

                console.log('[DEBUG] åˆ›å»ºå†°å†»ç”³è¯·:', request);
                StorageManager.addStreakFreezeRequest(request);

                alert('å†°å†»è¿èƒœç”³è¯·å·²æäº¤ï¼Œè¯·ç­‰å¾…å®˜æ–¹å®¡æ ¸');
                closeRequestFreezeModal();
                console.log('[DEBUG] å†°å†»ç”³è¯·æäº¤å®Œæˆ');
            } catch (error) {
                console.error('[ERROR] æäº¤å†°å†»ç”³è¯·æ—¶å‡ºé”™:', error);
                alert('æäº¤å¤±è´¥ï¼š' + error.message);
            }
        }

        // è§£å†»è¿èƒœ
        function unfreezeStreak() {
            console.log('[DEBUG] è§£å†»è¿èƒœ');

            try {
                const currentUserStr = localStorage.getItem('currentUser');
                if (!currentUserStr) {
                    alert('è¯·å…ˆç™»å½•');
                    return;
                }

                const currentUser = JSON.parse(currentUserStr);

                if (!currentUser.streakFrozen) {
                    alert('æ‚¨çš„è¿èƒœæœªå¤„äºå†°å†»çŠ¶æ€');
                    return;
                }

                if (!confirm('ç¡®å®šè¦è§£å†»è¿èƒœå—ï¼Ÿè§£å†»åè¿èƒœå°†æ¢å¤æ­£å¸¸è®¡ç®—ã€‚')) {
                    return;
                }

                const users = StorageManager.getUsers();
                const userIndex = users.findIndex(u => u.id === currentUser.id);

                if (userIndex !== -1) {
                    users[userIndex].streakFrozen = false;
                    users[userIndex].streakFreezeStartDate = null;
                    StorageManager.saveUsers(users);

                    // æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
                    localStorage.setItem('currentUser', JSON.stringify(users[userIndex]));

                    alert('è¿èƒœå·²è§£å†»ï¼');
                    loadUserProfile();
                    console.log('[DEBUG] è¿èƒœè§£å†»å®Œæˆ');
                }
            } catch (error) {
                console.error('[ERROR] è§£å†»è¿èƒœæ—¶å‡ºé”™:', error);
                alert('è§£å†»å¤±è´¥ï¼š' + error.message);
            }
        }

        // å®¡æ‰¹å†°å†»è¿èƒœç”³è¯·
        function approveStreakFreezeRequest(requestId) {
            console.log('[DEBUG] å®¡æ‰¹å†°å†»ç”³è¯·:', requestId);

            try {
                if (!confirm('ç¡®å®šæ‰¹å‡†è¯¥å†°å†»è¿èƒœç”³è¯·å—ï¼Ÿ')) {
                    return;
                }

                const currentUserStr = localStorage.getItem('currentUser');
                const currentUser = JSON.parse(currentUserStr);

                const requests = StorageManager.getStreakFreezeRequests();
                const request = requests.find(r => r.id === requestId);

                if (!request) {
                    alert('ç”³è¯·ä¸å­˜åœ¨');
                    return;
                }

                // æ›´æ–°ç”³è¯·çŠ¶æ€
                StorageManager.updateStreakFreezeRequest(requestId, {
                    status: 'approved',
                    reviewedBy: currentUser.id,
                    reviewedAt: Date.now()
                });

                // å†°å†»ç”¨æˆ·çš„è¿èƒœ
                const users = StorageManager.getUsers();
                const userIndex = users.findIndex(u => u.id === request.userId);

                if (userIndex !== -1) {
                    users[userIndex].streakFrozen = true;
                    users[userIndex].streakFreezeStartDate = Date.now();
                    StorageManager.saveUsers(users);
                    console.log('[DEBUG] ç”¨æˆ·è¿èƒœå·²å†°å†»');
                }

                alert('å·²æ‰¹å‡†å†°å†»ç”³è¯·');
                loadStreakFreezeRequests();
                console.log('[DEBUG] å†°å†»ç”³è¯·å®¡æ‰¹å®Œæˆ');
            } catch (error) {
                console.error('[ERROR] å®¡æ‰¹å†°å†»ç”³è¯·æ—¶å‡ºé”™:', error);
                alert('å®¡æ‰¹å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ‹’ç»å†°å†»è¿èƒœç”³è¯·
        function rejectStreakFreezeRequest(requestId) {
            console.log('[DEBUG] æ‹’ç»å†°å†»ç”³è¯·:', requestId);

            try {
                const reason = prompt('è¯·è¾“å…¥æ‹’ç»ç†ç”±ï¼š');
                if (!reason) {
                    return;
                }

                const currentUserStr = localStorage.getItem('currentUser');
                const currentUser = JSON.parse(currentUserStr);

                StorageManager.updateStreakFreezeRequest(requestId, {
                    status: 'rejected',
                    reviewedBy: currentUser.id,
                    reviewedAt: Date.now(),
                    rejectReason: reason
                });

                alert('å·²æ‹’ç»å†°å†»ç”³è¯·');
                loadStreakFreezeRequests();
                console.log('[DEBUG] å†°å†»ç”³è¯·æ‹’ç»å®Œæˆ');
            } catch (error) {
                console.error('[ERROR] æ‹’ç»å†°å†»ç”³è¯·æ—¶å‡ºé”™:', error);
                alert('æ‹’ç»å¤±è´¥ï¼š' + error.message);
            }
        }

        // åŠ è½½å†°å†»è¿èƒœç”³è¯·åˆ—è¡¨ï¼ˆå®˜æ–¹å®¡æ ¸é¡µé¢ï¼‰
        function loadStreakFreezeRequests() {
            console.log('[DEBUG] åŠ è½½å†°å†»è¿èƒœç”³è¯·åˆ—è¡¨');

            const requests = StorageManager.getStreakFreezeRequests();
            const container = document.getElementById('freeze-requests-list');

            if (!container) {
                console.warn('[WARN] æ‰¾ä¸åˆ°freeze-requests-listå®¹å™¨');
                return;
            }

            const pendingRequests = requests.filter(r => r.status === 'pending');

            if (pendingRequests.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— å¾…å®¡æ ¸çš„å†°å†»ç”³è¯·</div>';
                return;
            }

            container.innerHTML = pendingRequests.map(request => `
                <div class="card" style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #333;">â„ï¸ ${request.userName}</h3>
                            <div style="color: #666; font-size: 14px; margin-bottom: 5px;">
                                å½“å‰è¿èƒœï¼š${request.currentStreak}å¤©
                            </div>
                            <div style="color: #999; font-size: 12px;">
                                ç”³è¯·æ—¶é—´ï¼š${new Date(request.requestedAt).toLocaleString('zh-CN')}
                            </div>
                        </div>
                        <span style="background: #ff9800; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">å¾…å®¡æ ¸</span>
                    </div>

                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #333;">ç”³è¯·ç†ç”±ï¼š</div>
                        <div style="color: #666; line-height: 1.6;">${request.reason}</div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" style="flex: 1;" onclick="approveStreakFreezeRequest('${request.id}')">
                            âœ… æ‰¹å‡†
                        </button>
                        <button class="btn btn-secondary" style="flex: 1;" onclick="rejectStreakFreezeRequest('${request.id}')">
                            âŒ æ‹’ç»
                        </button>
                    </div>
                </div>
            `).join('');

            console.log('[DEBUG] å†°å†»ç”³è¯·åˆ—è¡¨åŠ è½½å®Œæˆ');
        }

        // åŠ è½½ç§¯åˆ†å®¡æ ¸åˆ—è¡¨ï¼ˆä½¿ç”¨æœåŠ¡å™¨APIï¼‰
        function loadPointsRequests() {
            console.log('[DEBUG] åŠ è½½ç§¯åˆ†ç”³è¯·åˆ—è¡¨');

            const container = document.getElementById('points-requests-list');

            if (!container) {
                console.warn('[WARN] æ‰¾ä¸åˆ°points-requests-listå®¹å™¨');
                return;
            }

            fetch('/api/points/pending')
                .then(response => response.json())
                .then(data => {
                    const pendingRequests = data.data || [];

                    if (pendingRequests.length === 0) {
                        container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— å¾…å®¡æ ¸çš„ç§¯åˆ†ç”³è¯·</div>';
                        return;
                    }

                    container.innerHTML = pendingRequests.map(request => `
                        <div class="card" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <h3 style="margin: 0 0 10px 0; color: #333;">ğŸ¯ ${request.userName}</h3>
                                    <div style="color: #666; font-size: 14px; margin-bottom: 5px;">
                                        ç±»å‹ï¼š${request.type === 'marathon' ? 'ç›²äººé©¬æ‹‰æ¾' : 'çº¿ä¸Šèµ›äº‹'}
                                    </div>
                                    <div style="color: #666; font-size: 14px; margin-bottom: 5px;">
                                        ç”³è¯·ç§¯åˆ†ï¼š<strong style="color: #f5222a;">${request.points}</strong> åˆ†
                                    </div>
                                    <div style="color: #999; font-size: 12px;">
                                        æè¿°ï¼š${request.description}
                                    </div>
                                    <div style="color: #999; font-size: 12px; margin-top: 5px;">
                                        ç”³è¯·æ—¶é—´ï¼š${new Date(request.date).toLocaleString('zh-CN')}
                                    </div>
                                </div>
                                <span style="background: #ff4d4f; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">å¾…å®¡æ ¸</span>
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" style="flex: 1;" onclick="approvePointsRequest('${request.userId}', '${request.date}')">
                                    âœ… æ‰¹å‡†ï¼ˆ+${request.points}åˆ†ï¼‰
                                </button>
                                <button class="btn btn-secondary" style="flex: 1;" onclick="rejectPointsRequest('${request.userId}', '${request.date}')">
                                    âŒ æ‹’ç»
                                </button>
                            </div>
                        </div>
                    `).join('');

                    console.log('[DEBUG] ç§¯åˆ†ç”³è¯·åˆ—è¡¨åŠ è½½å®Œæˆï¼Œå…±' + pendingRequests.length + 'æ¡');
                })
                .catch(err => {
                    console.error('[ERROR] è·å–ç§¯åˆ†ç”³è¯·åˆ—è¡¨å¤±è´¥:', err);
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
                });
        }

        // æ‰¹å‡†ç§¯åˆ†ç”³è¯·ï¼ˆä½¿ç”¨æœåŠ¡å™¨APIï¼‰
        function approvePointsRequest(userId, date) {
            if (!confirm('ç¡®å®šè¦æ‰¹å‡†è¿™ä¸ªç§¯åˆ†ç”³è¯·å—ï¼Ÿ')) return;

            fetch('/api/points/approve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, date })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('âœ… å®¡æ ¸é€šè¿‡ï¼\nç”¨æˆ· ' + data.data.userName + ' è·å¾— ' + data.data.points + ' ç§¯åˆ†');
                    loadPointsRequests();
                } else {
                    alert('å¤±è´¥ï¼š' + data.message);
                }
            })
            .catch(err => {
                alert('æ“ä½œå¤±è´¥ï¼š' + err.message);
            });
        }

        // æ‹’ç»ç§¯åˆ†ç”³è¯·ï¼ˆä½¿ç”¨æœåŠ¡å™¨APIï¼‰
        function rejectPointsRequest(userId, date) {
            const reason = prompt('è¯·è¾“å…¥æ‹’ç»ç†ç”±ï¼š');
            if (reason === null || reason.trim() === '') return;

            fetch('/api/points/reject', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, date, reason })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('âŒ å·²æ‹’ç»è¯¥ç§¯åˆ†ç”³è¯·');
                    loadPointsRequests();
                } else {
                    alert('å¤±è´¥ï¼š' + data.message);
                }
            })
            .catch(err => {
                alert('æ“ä½œå¤±è´¥ï¼š' + err.message);
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkAuth();

            // åˆå§‹åŒ–æ¼”ç¤ºæ•°æ®
            StorageManager.initDemoData();
            StorageManager.initShopItems();

            // åˆå§‹åŒ–åœ°å›¾
            initMap();

            // åŠ è½½é¦–é¡µå†…å®¹
            loadRequestsList();

            // æ›´æ–°ä»“åº“å°çº¢ç‚¹
            updateWarehouseBadge();
        });
    </script>
    <script src="api-integration.js"></script>
    <script src="competition-management.js"></script>
</body>
</html>
